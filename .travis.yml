dist: xenial
language: generic

branches:
  only:
    - source

git:
  depth: false
  quiet: true

before_install:
 - git config --global user.email "lujun9972@gmail.com"
 - git config --global user.name "darksun"
 - git clone https://github.com/nasfarley88/habash ~/habash
 - git clone https://github.com/lujun9972/EGO ~/EGO
 - git clone -b source https://github.com/lujun9972/lujun9972.github.com.git ~/source
 - git clone -b master https://github.com/lujun9972/lujun9972.github.com.git ~/web
 - sudo add-apt-repository ppa:ubuntu-elisp/ppa -y
 - sudo apt-get update
 - sudo apt-get install emacs-snapshot -y
 - emacs-snapshot --version
 
script:
- git config --global core.quotepath false
- echo -e $TRAVIS_PRIVATE >~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
- wc -l ~/.ssh/id_rsa
- echo "Host github.com" >> ~/.ssh/config
- echo "   Hostname github.com" >> ~/.ssh/config
- echo "   StrictHostKeyChecking no" >> ~/.ssh/config
- echo "   CheckHostIP no" >> ~/.ssh/config
- echo "   UserKnownHostsFile=/dev/null" >> ~/.ssh/config
- cd ~/source
- emacs-snapshot --batch -l ./auto_publish.el 
- ./generate_index.sh >README.org
- git commit -a -m "update README" || exit 0
- git push origin source
- ~/habash/habash up "写博客"

deploy:
  provider: pages
  skip_cleanup: true
  keep_history: true
  github_token: $GITHUB_TOKEN
  local_dir: ~/web
  target_branch: master
  on:
    branch:
      - source
