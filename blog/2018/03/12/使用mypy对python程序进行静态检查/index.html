<!DOCTYPE html>
<html lang="en">
<head>
  <title>使用mypy对python程序进行静态检查 - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="编程之旅,python,checker" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="/media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  <link rel="stylesheet" href="/media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="/">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="/years/">Years</a></li>
              <li><a href="/authors/">Authors</a></li>
              <li><a href="/tags/">Tags</a></li>
              <li><a href="/about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com">Github</a></li>
              <li><a href="/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">使用mypy对python程序进行静态检查</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc593784">安装mypy</a></li>
<li><a href="#orgf0db89c">使用mypy进行静态检查</a></li>
<li><a href="#org5f9f38f">帮助信息</a></li>
</ul>
</div>
</div>
<p>
自从python3.6开始，允许为参数和返回类型添加 type hint，这使得对python程序进行静态检查成为可能。
</p>

<p>
mypy就是这么一个python type checker.
</p>

<div id="outline-container-orgc593784" class="outline-2">
<h2 id="orgc593784">安装mypy</h2>
<div class="outline-text-2" id="text-orgc593784">
<p>
我们可以使用 <code>pip</code> 来安装mypy。
</p>
<pre class="example">
[lujun9972@T520 work]$ pip install mypy
Collecting mypy
  Downloading mypy-0.570-py3-none-any.whl (1.2MB)
    100% |████████████████████████████████| 1.2MB 70kB/s 
Collecting typed-ast&lt;1.2.0,&gt;=1.1.0 (from mypy)
  Downloading typed_ast-1.1.0-cp36-cp36m-manylinux1_x86_64.whl (724kB)
    100% |████████████████████████████████| 727kB 68kB/s 
Installing collected packages: typed-ast, mypy
Successfully installed mypy-0.570 typed-ast-1.1.0

</pre>
</div>
</div>

<div id="outline-container-orgf0db89c" class="outline-2">
<h2 id="orgf0db89c">使用mypy进行静态检查</h2>
<div class="outline-text-2" id="text-orgf0db89c">
<p>
假设有这么一个 <code>test.py</code> 的文件：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">Student</span><span style="color: #4f97d7;">()</span>:
    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">__init__</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>,<span style="color: #4f97d7;">id</span>,name,age,major<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">self</span>.<span style="color: #4f97d7;">id</span> = <span style="color: #4f97d7;">id</span>
        <span style="color: #4f97d7; font-weight: bold;">self</span>.name = name
        <span style="color: #4f97d7; font-weight: bold;">self</span>.age = age
        <span style="color: #4f97d7; font-weight: bold;">self</span>.major = major


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">display</span><span style="color: #4f97d7;">(</span>persons<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">for</span> person <span style="color: #4f97d7; font-weight: bold;">in</span> persons:
        <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>f<span style="color: #2d9574;">'{person.id} {person.name}'</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">dark</span> = Student<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'1'</span>, <span style="color: #2d9574;">'Dark'</span>, <span style="color: #2d9574;">'19'</span>, <span style="color: #2d9574;">'computer'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">sun</span> = Student<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'2'</span>, <span style="color: #2d9574;">'Sun'</span>, <span style="color: #a45bad;">21</span>, <span style="color: #2d9574;">'account'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">lujun</span>= Student<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">3</span>, <span style="color: #2d9574;">'lujun'</span>, <span style="color: #2d9574;">'MBA'</span>, <span style="color: #a45bad;">25</span><span style="color: #4f97d7;">)</span>

display<span style="color: #4f97d7;">(</span>dark<span style="color: #4f97d7;">)</span>
display<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>sun, dark, <span style="color: #2d9574;">'lujun'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
这段代码并没有添加 type hint，但是从代码中可以很容易看出是有许多错误的。
</p>

<p>
我们用 <code>mypy</code> 来检查一下看能不能查出什么：
</p>
<pre class="example">
[lujun9972@T520 work]$ mypy /tmp/test.py 
[lujun9972@T520 work]$ 
</pre>

<p>
你会发现 <code>mypy</code> 什么错误都没有提示。
</p>

<p>
现在我们来为程序加上type hint
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> typing <span style="color: #4f97d7; font-weight: bold;">import</span> List
<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">Student</span><span style="color: #4f97d7;">()</span>:
    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">__init__</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, <span style="color: #4f97d7;">id</span>:<span style="color: #4f97d7;">int</span>, name:<span style="color: #4f97d7;">str</span>, age:<span style="color: #4f97d7;">int</span>, major:<span style="color: #4f97d7;">str</span><span style="color: #4f97d7;">)</span>-&gt;<span style="color: #a45bad;">None</span>:
        <span style="color: #4f97d7; font-weight: bold;">self</span>.<span style="color: #4f97d7;">id</span> = <span style="color: #4f97d7;">id</span>
        <span style="color: #4f97d7; font-weight: bold;">self</span>.name = name
        <span style="color: #4f97d7; font-weight: bold;">self</span>.age = age
        <span style="color: #4f97d7; font-weight: bold;">self</span>.major = major


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">display</span><span style="color: #4f97d7;">(</span>persons:List<span style="color: #bc6ec5;">[</span>Student<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>-&gt;<span style="color: #a45bad;">None</span>:
    <span style="color: #4f97d7; font-weight: bold;">for</span> person <span style="color: #4f97d7; font-weight: bold;">in</span> persons:
        <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>f<span style="color: #2d9574;">'{person.id} {person.name}'</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">dark</span> = Student<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'1'</span>, <span style="color: #2d9574;">'Dark'</span>, <span style="color: #2d9574;">'19'</span>, <span style="color: #2d9574;">'computer'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">sun</span> = Student<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'2'</span>, <span style="color: #2d9574;">'Sun'</span>, <span style="color: #a45bad;">21</span>, <span style="color: #2d9574;">'account'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">lujun</span>= Student<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">3</span>, <span style="color: #2d9574;">'lujun'</span>, <span style="color: #2d9574;">'MBA'</span>, <span style="color: #a45bad;">25</span><span style="color: #4f97d7;">)</span>

display<span style="color: #4f97d7;">(</span>dark<span style="color: #4f97d7;">)</span>
display<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>sun, dark, <span style="color: #2d9574;">'lujun'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
再次用 <code>mypy</code> 来检查一下
</p>
<pre class="example">
[lujun9972@T520 work]$ mypy /tmp/test_with_type_hint.py 
/tmp/test_with_type_hint.py:14: error: Argument 1 to "Student" has incompatible type "str"; expected "int"
/tmp/test_with_type_hint.py:14: error: Argument 3 to "Student" has incompatible type "str"; expected "int"
/tmp/test_with_type_hint.py:15: error: Argument 1 to "Student" has incompatible type "str"; expected "int"
/tmp/test_with_type_hint.py:16: error: Argument 3 to "Student" has incompatible type "str"; expected "int"
/tmp/test_with_type_hint.py:16: error: Argument 4 to "Student" has incompatible type "int"; expected "str"
/tmp/test_with_type_hint.py:18: error: Argument 1 to "display" has incompatible type "Student"; expected "List[Student]"
/tmp/test_with_type_hint.py:19: error: List item 2 has incompatible type "str"; expected "Student"
</pre>

<p>
可以发现，找出了一堆问题。
</p>
</div>
</div>

<div id="outline-container-org5f9f38f" class="outline-2">
<h2 id="org5f9f38f">帮助信息</h2>
<div class="outline-text-2" id="text-org5f9f38f">
<p>
mypy还带有一堆的参数来定义检查的方法，运行 <code>mypy -h</code> 就会列出帮助信息了：
</p>
<pre class="example">
[lujun9972@T520 work]$ mypy --help
usage: mypy [-h] [-v] [-V] [--python-version x.y] [--platform PLATFORM] [-2]
            [--ignore-missing-imports]
            [--follow-imports {normal,silent,skip,error}]
            [--disallow-any-unimported] [--disallow-any-expr]
            [--disallow-any-decorated] [--disallow-any-explicit]
            [--disallow-any-generics] [--disallow-untyped-calls]
            [--disallow-untyped-defs] [--disallow-incomplete-defs]
            [--check-untyped-defs] [--disallow-subclassing-any]
            [--warn-incomplete-stub] [--disallow-untyped-decorators]
            [--warn-redundant-casts] [--no-warn-no-return] [--warn-return-any]
            [--warn-unused-ignores] [--warn-unused-configs]
            [--show-error-context] [--no-implicit-optional] [-i]
            [--quick-and-dirty] [--cache-dir DIR] [--cache-fine-grained]
            [--skip-version-check] [--strict-optional]
            [--strict-optional-whitelist [GLOB [GLOB ...]]]
            [--junit-xml JUNIT_XML] [--pdb] [--show-traceback] [--stats]
            [--inferstats] [--custom-typing MODULE]
            [--custom-typeshed-dir DIR] [--scripts-are-modules]
            [--config-file CONFIG_FILE] [--show-column-numbers]
            [--find-occurrences CLASS.MEMBER] [--strict]
            [--shadow-file SOURCE_FILE SHADOW_FILE] [--any-exprs-report DIR]
            [--cobertura-xml-report DIR] [--html-report DIR]
            [--linecount-report DIR] [--linecoverage-report DIR]
            [--memory-xml-report DIR] [--txt-report DIR] [--xml-report DIR]
            [--xslt-html-report DIR] [--xslt-txt-report DIR] [-m MODULE]
            [-c PROGRAM_TEXT] [-p PACKAGE]
            [files [files ...]]

optional arguments:
  -h, --help                show this help message and exit
  -v, --verbose             more verbose messages
  -V, --version             show program's version number and exit
  --python-version x.y      use Python x.y
  --platform PLATFORM       typecheck special-cased code for the given OS
                            platform (defaults to sys.platform).
  -2, --py2                 use Python 2 mode
  --ignore-missing-imports  silently ignore imports of missing modules
  --follow-imports {normal,silent,skip,error}
                            how to treat imports (default normal)
  --disallow-any-unimported
                            disallow Any types resulting from unfollowed
                            imports
  --disallow-any-expr       disallow all expressions that have type Any
  --disallow-any-decorated  disallow functions that have Any in their
                            signature after decorator transformation
  --disallow-any-explicit   disallow explicit Any in type positions
  --disallow-any-generics   disallow usage of generic types that do not
                            specify explicit type parameters
  --disallow-untyped-calls  disallow calling functions without type
                            annotations from functions with type annotations
                            (inverse: --allow-untyped-calls)
  --disallow-untyped-defs   disallow defining functions without type
                            annotations or with incomplete type annotations
                            (inverse: --allow-untyped-defs)
  --disallow-incomplete-defs
                            disallow defining functions with incomplete type
                            annotations (inverse: --allow-incomplete-defs)
  --check-untyped-defs      type check the interior of functions without type
                            annotations (inverse: --no-check-untyped-defs)
  --disallow-subclassing-any
                            disallow subclassing values of type 'Any' when
                            defining classes (inverse: --allow-subclassing-
                            any)
  --warn-incomplete-stub    warn if missing type annotation in typeshed, only
                            relevant with --check-untyped-defs enabled
                            (inverse: --no-warn-incomplete-stub)
  --disallow-untyped-decorators
                            disallow decorating typed functions with untyped
                            decorators (inverse: --allow-untyped-decorators)
  --warn-redundant-casts    warn about casting an expression to its inferred
                            type (inverse: --no-warn-redundant-casts)
  --no-warn-no-return       do not warn about functions that end without
                            returning (inverse: --warn-no-return)
  --warn-return-any         warn about returning values of type Any from non-
                            Any typed functions (inverse: --no-warn-return-
                            any)
  --warn-unused-ignores     warn about unneeded '# type: ignore' comments
                            (inverse: --no-warn-unused-ignores)
  --warn-unused-configs     warn about unused '[mypy-&lt;pattern&gt;]' config
                            sections (inverse: --no-warn-unused-configs)
  --show-error-context      Precede errors with "note:" messages explaining
                            context (inverse: --hide-error-context)
  --no-implicit-optional    don't assume arguments with default values of None
                            are Optional (inverse: --implicit-optional)
  -i, --incremental         enable module cache, (inverse: --no-incremental)
  --quick-and-dirty         use cache even if dependencies out of date
                            (implies --incremental)
  --cache-dir DIR           store module cache info in the given folder in
                            incremental mode (defaults to '.mypy_cache')
  --cache-fine-grained      include fine-grained dependency information in the
                            cache
  --skip-version-check      allow using cache written by older mypy version
  --strict-optional         enable experimental strict Optional checks
                            (inverse: --no-strict-optional)
  --strict-optional-whitelist [GLOB [GLOB ...]]
                            suppress strict Optional errors in all but the
                            provided files (experimental -- read documentation
                            before using!). Implies --strict-optional. Has the
                            undesirable side-effect of suppressing other
                            errors in non-whitelisted files.
  --junit-xml JUNIT_XML     write junit.xml to the given file
  --pdb                     invoke pdb on fatal error
  --show-traceback, --tb    show traceback on fatal error
  --stats                   dump stats
  --inferstats              dump type inference stats
  --custom-typing MODULE    use a custom typing module
  --custom-typeshed-dir DIR
                            use the custom typeshed in DIR
  --scripts-are-modules     Script x becomes module x instead of __main__
  --config-file CONFIG_FILE
                            Configuration file, must have a [mypy] section
                            (defaults to mypy.ini)
  --show-column-numbers     Show column numbers in error messages (inverse:
                            --hide-column-numbers)
  --find-occurrences CLASS.MEMBER
                            print out all usages of a class member
                            (experimental)
  --strict                  Strict mode. Enables the following flags:
                            --disallow-untyped-calls, --disallow-untyped-defs,
                            --disallow-incomplete-defs, --check-untyped-defs,
                            --disallow-subclassing-any, --disallow-untyped-
                            decorators, --warn-redundant-casts, --warn-return-
                            any, --warn-unused-ignores, --warn-unused-configs,
                            --no-implicit-optional, --strict-optional
  --shadow-file SOURCE_FILE SHADOW_FILE
                            Typecheck SHADOW_FILE in place of SOURCE_FILE.

report generation:
  Generate a report in the specified format.

  --any-exprs-report DIR
  --cobertura-xml-report DIR
  --html-report DIR
  --linecount-report DIR
  --linecoverage-report DIR
  --memory-xml-report DIR
  --txt-report DIR
  --xml-report DIR
  --xslt-html-report DIR
  --xslt-txt-report DIR

How to specify the code to type check:
  -m MODULE, --module MODULE
                            type-check module; can repeat for more modules
  -c PROGRAM_TEXT, --command PROGRAM_TEXT
                            type-check program passed in as string
  -p PACKAGE, --package PACKAGE
                            type-check all files in a directory
  files                     type-check given files or directories

environment variables: MYPYPATH additional module search path
</pre>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2018-03-12</span>
    <span title="last modification date" class="post-info">2018-03-12</span>
    <span title="tags" class="post-info"><a href="/tags/编程之旅">编程之旅</a> : <a href="/tags/python">python</a> : <a href="/tags/checker">checker</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="/media/js/jquery-2.1.3.min.js"></script>
  <script src="/media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="/media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T520">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
