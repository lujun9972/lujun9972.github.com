<!DOCTYPE html>
<html lang="en">
<head>
  <title>xfs文件系统管理 - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="linux和它的小伙伴" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/org-src-fontify.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com.git">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
    <img class="avatar" src="https://avatar.csdnimg.cn/6/2/4/1_lujun9972.jpg" />
  </header>
</div>

<div>
<div class="post">
<h1 class="title">xfs文件系统管理</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8134402">常用命令说明</a></li>
<li><a href="#org4723055">创建XFS文件系统</a>
<ul>
<li><a href="#org02046d7">设置block大小</a></li>
<li><a href="#org9256ce0">日志大小</a></li>
<li><a href="#org32d01ea">设置文件系统标签</a></li>
</ul>
</li>
<li><a href="#org71641c8">挂载XFS文件系统</a></li>
<li><a href="#orgffee477">调整XFS文件系统参数</a>
<ul>
<li><a href="#orgfd55251">卷标管理</a>
<ul>
<li><a href="#org8597755">设置卷标</a></li>
<li><a href="#orgfb16b8c">查看卷标</a></li>
</ul>
</li>
<li><a href="#orgb911d8d">UUID管理</a>
<ul>
<li><a href="#org43412ad">查看指定设备的UUID</a></li>
<li><a href="#org2c8e647">设置设备的UUID</a></li>
<li><a href="#orga1b2511">清除文件系统的UUID</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org97c85a9">扩展XFS文件系统的大小</a></li>
<li><a href="#orgf99cb8a">暂停/恢复XFS文件系统</a>
<ul>
<li><a href="#orgfc65fe1">暂停XFS文件系统</a></li>
<li><a href="#orge784b99">恢复XFS文件系统</a></li>
</ul>
</li>
<li><a href="#orga56d2ec">修复XFS文件系统</a></li>
<li><a href="#org049888e">碎片管理</a>
<ul>
<li><a href="#org7cd07dc">查看碎片情况</a></li>
<li><a href="#org8dad437">整理碎片</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
XFS文件系统管理常用命令记录
</p>

<div id="outline-container-org8134402" class="outline-2">
<h2 id="org8134402">常用命令说明</h2>
<div class="outline-text-2" id="text-org8134402">
<dl class="org-dl">
<dt>mkfs.xfs</dt><dd>创建xfs文件系统</dd>
<dt>xfs_admin</dt><dd>调整XFS文件系统各种参数</dd>
<dt>xfs_copy</dt><dd>并行地拷贝XFS文件系统的内容到一个或多个目标系统中</dd>
<dt>xfs_db</dt><dd>调试或检测XFS文件系统</dd>
<dt>xfs_check</dt><dd>检测XFS文件系统完整性</dd>
<dt>xfs_bmap</dt><dd>查看一个文件的块映射</dd>
<dt>xfs_repair</dt><dd>尝试修复受损的XFS文件系统</dd>
<dt>xfs_fsr</dt><dd>碎片整理</dd>
<dt>xfs_quota</dt><dd>管理XFS文件系统的磁盘配额</dd>
<dt>xfs_metadump</dt><dd>导出XFS文件系统的元数据</dd>
<dt>xfs_growfs</dt><dd>扩展XFS文件系统大小</dd>
<dt>xfs_freeze</dt><dd>暂停/恢复XFS文件系统</dd>
</dl>
</div>
</div>

<div id="outline-container-org4723055" class="outline-2">
<h2 id="org4723055">创建XFS文件系统</h2>
<div class="outline-text-2" id="text-org4723055">
<p>
使用 <code>mkfs.xfs</code> 可以将存储设备格式化为XFS格式
</p>
<div class="org-src-container">
<pre class="src src-shell">dd <span class="org-variable-name">if</span>=/dev/zero <span class="org-variable-name">of</span>=~/xfs.img <span class="org-variable-name">bs</span>=1M <span class="org-variable-name">count</span>=4096
mkfs.xfs ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">meta-data=/home/lujun9972/xfs.img isize=512    agcount=4, agsize=262144 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=0
data     =                       bsize=4096   blocks=1048576, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
</pre>
</div>

<p>
但若原存储已经被格式化过，则 <code>mkfs.xfs</code> 会拒绝再次格式化
</p>
<div class="org-src-container">
<pre class="src src-shell">mkfs.xfs ~/xfs.img 2&gt;&amp;1 ||<span class="org-keyword">exit</span> 0
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">mkfs.xfs: /home/lujun9972/xfs.img appears to contain an existing filesystem (xfs).
mkfs.xfs: Use the -f option to force overwrite.
</pre>
</div>

<p>
这个时候需要用 <code>-f</code> 选项表示强行格式化
</p>
<div class="org-src-container">
<pre class="src src-shell">mkfs.xfs -f ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">meta-data=/home/lujun9972/xfs.img isize=512    agcount=4, agsize=262144 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=0
data     =                       bsize=4096   blocks=1048576, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
</pre>
</div>
</div>

<div id="outline-container-org02046d7" class="outline-3">
<h3 id="org02046d7">设置block大小</h3>
<div class="outline-text-3" id="text-org02046d7">
<p>
block是文件系统存储的最小单位，较大的block可以增加文件系统和单个文件的大小上限并加快大文件的读写速度，但是会浪费较多空间。而太小的block则相反。
</p>

<p>
我们可以在格式化时指定block的大小，XFS的大小最小为512字节，最大为64KB,默认为4K
</p>

<p>
在格式化时使用 <code>-b size=block大小</code> 来指定区块大小
</p>
<div class="org-src-container">
<pre class="src src-shell">mkfs.xfs -f -b <span class="org-variable-name">size</span>=1k ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">meta-data=/home/lujun9972/xfs.img isize=512    agcount=4, agsize=1048576 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=0
data     =                       bsize=1024   blocks=4194304, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=1024   blocks=10240, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
</pre>
</div>

<p>
这里大小单位可以是"k"表示kb，或者"s"表示扇区数，一个扇区默认为512字节，但可以通过 <code>-s</code> 选项改变。
</p>

<p>
XFS允许目录使用比文件系统block更大的block,方法是使用 <code>-n size=block大小</code>
</p>

<div class="org-src-container">
<pre class="src src-shell">mkfs.xfs -f -b <span class="org-variable-name">size</span>=1k -n <span class="org-variable-name">size</span>=4k ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">meta-data=/home/lujun9972/xfs.img isize=512    agcount=4, agsize=1048576 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=0
data     =                       bsize=1024   blocks=4194304, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=1024   blocks=10240, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
</pre>
</div>
</div>
</div>

<div id="outline-container-org9256ce0" class="outline-3">
<h3 id="org9256ce0">日志大小</h3>
<div class="outline-text-3" id="text-org9256ce0">
<p>
格式化XFS时，mkfs.xfs会根据文件系统的大小自动分配日志的大小。
日志大小介于512KB到128MB之间，但可以通过 <code>-l size=日志大小</code> 来设置，其中日志的单位可以是:
</p>

<dl class="org-dl">
<dt>s</dt><dd>扇区</dd>
<dt>b</dt><dd>block</dd>
<dt>k</dt><dd>KB</dd>
<dt>m</dt><dd>MB</dd>
<dt>g</dt><dd>GB</dd>
<dt>t</dt><dd>TB</dd>
<dt>p</dt><dd>PB</dd>
<dt>e</dt><dd>EB</dd>
</dl>

<div class="org-src-container">
<pre class="src src-shell">mkfs.xfs -f -l <span class="org-variable-name">size</span>=64m ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">meta-data=/home/lujun9972/xfs.img isize=512    agcount=4, agsize=262144 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=0
data     =                       bsize=4096   blocks=1048576, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=16384, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
</pre>
</div>
</div>
</div>

<div id="outline-container-org32d01ea" class="outline-3">
<h3 id="org32d01ea">设置文件系统标签</h3>
<div class="outline-text-3" id="text-org32d01ea">
<p>
Label或者说Volume Name可以用来说明文件系统的用途，可以通过 <code>-L 标签</code> 来设置
</p>
<div class="org-src-container">
<pre class="src src-shell">mkfs.xfs -f -L TEST ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">meta-data=/home/lujun9972/xfs.img isize=512    agcount=4, agsize=262144 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=0
data     =                       bsize=4096   blocks=1048576, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
</pre>
</div>

<p>
我们可以使用 <code>xfs_admin</code> 来查看当前的label
</p>
<div class="org-src-container">
<pre class="src src-shell">xfs_admin -l ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">label = "TEST"
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org71641c8" class="outline-2">
<h2 id="org71641c8">挂载XFS文件系统</h2>
<div class="outline-text-2" id="text-org71641c8">
<p>
在挂载时，可以使用一些性能增强的选项来发掘XFS文件系统的性能
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo mount -t xfs ~lujun9972/xfs.img /mnt -o noatime,nodiratime
</pre>
</div>

<p>
其他常见的 <code>-o</code> 选项包括:
</p>

<dl class="org-dl">
<dt>allocsize</dt><dd>延时分配时，预分配缓冲区的大小</dd>
<dt>discard / nodiscard</dt><dd>块设备是否自动回收空间</dd>
<dt>largeio</dt><dd>大块分配</dd>
<dt>nolargeio</dt><dd>尽量小块分配</dd>
<dt>noatime</dt><dd>读取文件时不更新访问时间</dd>
<dt>nodiratime</dt><dd>不更新目录的访问时间</dd>
<dt>norecovery</dt><dd>挂载时不运行日志恢复</dd>
<dt>logbufs</dt><dd>内存中的日志缓冲区数量</dd>
<dt>logbsize</dt><dd>内存中每个日志缓存区的大小</dd>
</dl>
</div>
</div>
<div id="outline-container-orgffee477" class="outline-2">
<h2 id="orgffee477">调整XFS文件系统参数</h2>
<div class="outline-text-2" id="text-orgffee477">
<p>
使用 <code>xfs_admin</code> 来调整XFS文件系统参数
</p>
</div>
<div id="outline-container-orgfd55251" class="outline-3">
<h3 id="orgfd55251">卷标管理</h3>
<div class="outline-text-3" id="text-orgfd55251">
</div>
<div id="outline-container-org8597755" class="outline-4">
<h4 id="org8597755">设置卷标</h4>
<div class="outline-text-4" id="text-org8597755">
<div class="org-src-container">
<pre class="src src-shell">xfs_admin -L <span class="org-string">"another_volume"</span> ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">writing all SBs
xfs_admin: truncating label length from 14 to 12
new label = "another_volu"
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfb16b8c" class="outline-4">
<h4 id="orgfb16b8c">查看卷标</h4>
<div class="outline-text-4" id="text-orgfb16b8c">
<div class="org-src-container">
<pre class="src src-shell">xfs_admin -l ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">label = "another_volu"
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb911d8d" class="outline-3">
<h3 id="orgb911d8d">UUID管理</h3>
<div class="outline-text-3" id="text-orgb911d8d">
<p>
传统上Linux在/etc/fstab中直接使用设备名称指定要挂载的存储设备。
然而设备名称会因为BIOS或硬件的改变而改变，引起混乱，因此现在Linux改用UUID来指定要挂载的存储设备。
</p>
</div>

<div id="outline-container-org43412ad" class="outline-4">
<h4 id="org43412ad">查看指定设备的UUID</h4>
<div class="outline-text-4" id="text-org43412ad">
<div class="org-src-container">
<pre class="src src-shell">xfs_admin -u ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">UUID = aceeca47-82a0-47ce-a2e6-704569ebcbd4
</pre>
</div>
</div>
</div>

<div id="outline-container-org2c8e647" class="outline-4">
<h4 id="org2c8e647">设置设备的UUID</h4>
<div class="outline-text-4" id="text-org2c8e647">
<div class="org-src-container">
<pre class="src src-shell">xfs_admin -U 12345678-9012-3456-7890-123456789012 ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Clearing log and setting UUID
writing all SBs
new UUID = 12345678-9012-3456-7890-123456789012
</pre>
</div>

<p>
你也可以给 -U 参数传递 <code>generate</code> 表示随机生成新的UUID
</p>
<div class="org-src-container">
<pre class="src src-shell">xfs_admin -U generate ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Clearing log and setting UUID
writing all SBs
new UUID = 9618fe39-638d-41b0-9863-5b3b8daa9801
</pre>
</div>
</div>
</div>

<div id="outline-container-orga1b2511" class="outline-4">
<h4 id="orga1b2511">清除文件系统的UUID</h4>
<div class="outline-text-4" id="text-orga1b2511">
<div class="org-src-container">
<pre class="src src-shell">xfs_admin -U nil ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Clearing log and setting UUID
writing all SBs
new UUID = 00000000-0000-0000-0000-000000000000
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org97c85a9" class="outline-2">
<h2 id="org97c85a9">扩展XFS文件系统的大小</h2>
<div class="outline-text-2" id="text-org97c85a9">
<p>
XFS文件系统只能扩大，不能减少大小
</p>

<p>
扩容指定容量
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo xfs_growfs -D 20G /mnt
</pre>
</div>

<p>
扩展全部未用容量
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo xfs_growfs -d /mnt
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf99cb8a" class="outline-2">
<h2 id="orgf99cb8a">暂停/恢复XFS文件系统</h2>
<div class="outline-text-2" id="text-orgf99cb8a">
<p>
xfs_freeze 命令可以停止对文件系统的访问并创建一个静态的磁盘镜像。
</p>
</div>

<div id="outline-container-orgfc65fe1" class="outline-3">
<h3 id="orgfc65fe1">暂停XFS文件系统</h3>
<div class="outline-text-3" id="text-orgfc65fe1">
<div class="org-src-container">
<pre class="src src-shell">sudo xfs_freeze -f /mnt
</pre>
</div>

<p>
这个时候任何对文件系统的操作都会被挂起
</p>
</div>
</div>

<div id="outline-container-orge784b99" class="outline-3">
<h3 id="orge784b99">恢复XFS文件系统</h3>
<div class="outline-text-3" id="text-orge784b99">
<div class="org-src-container">
<pre class="src src-shell">sudo xfs_freeze -u /mnt
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga56d2ec" class="outline-2">
<h2 id="orga56d2ec">修复XFS文件系统</h2>
<div class="outline-text-2" id="text-orga56d2ec">
<div class="org-src-container">
<pre class="src src-shell">sudo umount /mnt
xfs_repair ~lujun9972/xfs.img
</pre>
</div>
</div>
</div>

<div id="outline-container-org049888e" class="outline-2">
<h2 id="org049888e">碎片管理</h2>
<div class="outline-text-2" id="text-org049888e">
</div>
<div id="outline-container-org7cd07dc" class="outline-3">
<h3 id="org7cd07dc">查看碎片情况</h3>
<div class="outline-text-3" id="text-org7cd07dc">
<div class="org-src-container">
<pre class="src src-shell">xfs_db -c frag -r ~/xfs.img
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">actual 0, ideal 0, fragmentation factor 0.00%
Note, this number is largely meaningless.
Files on this filesystem average -nan extents per file
</pre>
</div>
</div>
</div>

<div id="outline-container-org8dad437" class="outline-3">
<h3 id="org8dad437">整理碎片</h3>
<div class="outline-text-3" id="text-org8dad437">
<div class="org-src-container">
<pre class="src src-shell">xfs_fsr ~/xfs.img
</pre>
</div>
</div>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2018-09-08</span>
    <span title="last modification date" class="post-info">2018-09-09</span>
    <span title="tags" class="post-info"><a href="../../../../../tags/linux和它的小伙伴">linux和它的小伙伴</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-7681ff2a-872b-49f2-9385-cd1ed3ca84fc">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="https://licensebuttons.net/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
