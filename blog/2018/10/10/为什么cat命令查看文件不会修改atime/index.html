<!DOCTYPE html>
<html lang="en">
<head>
  <title>为什么cat命令查看文件不会修改atime - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="linux和它的小伙伴" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/org-src-fontify.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com.git">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">为什么cat命令查看文件不会修改atime</h1>
<p>
今天在QQ群里有人问了一个问题:“为什么用cat查看文件内容后不会修改它的atime呢？”
</p>

<p>
我试了一下，发现真的是这样的！例如下面这个例子,在CentOS7上执行
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">export</span> <span class="org-variable-name">LANG</span>=C
<span class="org-builtin">cd</span> /tmp
<span class="org-variable-name">tmpfile</span>=$(<span class="org-sh-quoted-exec">mktemp</span>)
<span class="org-builtin">echo</span> <span class="org-string">"-------------------------------"</span> &gt;${<span class="org-variable-name">tmpfile</span>}
stat ${<span class="org-variable-name">tmpfile</span>} |grep Access
sleep 5
cat ${<span class="org-variable-name">tmpfile</span>}
stat ${<span class="org-variable-name">tmpfile</span>} |grep Access
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Access: (0600/-rw-------)  Uid: ( 1000/lujun9972)   Gid: ( 1000/lujun9972)
Access: 2019-01-15 13:08:34.519887362 +0800
-------------------------------
Access: (0600/-rw-------)  Uid: ( 1000/lujun9972)   Gid: ( 1000/lujun9972)
Access: 2019-01-15 13:08:34.519887362 +0800
</pre>
</div>


<p>
这跟我们所熟知的atime的说法不一样啊。
</p>

<p>
经过一番探查，最终从 <a href="https://en.m.wikipedia.org/wiki/Stat_(system_call)#Criticism_of_atime">Criticism of atime</a> 中发现了原因。
</p>

<p>
根据 <a href="https://en.m.wikipedia.org/wiki/Stat_(system_call)#Criticism_of_atime">Criticism of atime</a> 的说法，读取文件要修改atime本身是一件很不合理的事情，因为要修改文件的atime就意味着要对磁盘进行写操作。
首先，在只读文件系统上你根本不可能修改文件的atime,更重要的是这增加了磁盘IO数量.
</p>

<p>
为了提高磁盘性能，我们可以完全禁止atime的修改(参看mount的noatime和nodiratime选项)，但这会破坏POSIX兼容性，而且某些备份软件需要通过对比atime和mtime/ctime的时间来判断是否需要进行备份。
</p>

<p>
针对这个问题，Linux kernel2.6.20开始为mount引入了一个 <code>relatime</code> 选项，并从 2.6.30 开始这一选项默认是开启的。
</p>

<p>
当开启了 <code>relatime</code> 选项后，只有当 <code>atime&lt;mtime</code> 或 <code>atime&lt;ctime</code> 时，才会去更新 <code>atime</code>.
通过这种方式，一方面可以大幅度减少atime引起的磁盘写操作，另一方面又保证了备份软件不受到影响，可谓非常精妙了。
</p>

<p>
下面这段关于relatime的说明取自 <code>man mount</code>
</p>
<pre class="example">
relatime
       Update inode access times relative to modify or  change  time.
       Access  time  is  only updated if the previous access time was
       earlier than the current modify or change time.   (Similar  to
       noatime,  but it doesn't break mutt or other applications that
       need to know if a file has been read since the  last  time  it
       was modified.)

       Since  Linux  2.6.30, the kernel defaults to the behavior pro‐
       vided by this option (unless noatime was specified),  and  the
       strictatime  option  is  required to obtain traditional seman‐
       tics.  In addition, since Linux 2.6.30, the file's last access
       time is always updated if it is more than 1 day old.
</pre>

<p>
另外，Linux kernel4.0开始引入了一个新选项 <code>lazytime</code>. 它可以让更新atime的操作缓存在内存中，然后当该文件有非时间相关的IO要写入时以其更新到磁盘中。
同时它也能设置超过多长时间后强制更新atime. 通过这种方式, <code>lazytime</code> 能做到在不影响性能的情况下保持POSIX兼容性。
</p>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2018-10-10</span>
    <span title="last modification date" class="post-info">2019-01-15</span>
    <span title="tags" class="post-info"><a href="../../../../../tags/linux和它的小伙伴">linux和它的小伙伴</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-741fed94-a850-4ec5-8cd7-96177af926a4">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
