<!DOCTYPE html>
<html lang="en">
<head>
  <title>docker-machine初体验 - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="linux和它的小伙伴,docker" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../authors/">Authors</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com.git">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">docker-machine初体验</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge609f64">在本地创建带Docker的虚拟机</a></li>
<li><a href="#org579c368">在远程主机上安装Docker</a></li>
<li><a href="#org3785910">管理Docker Machine</a>
<ul>
<li><a href="#org1074b81">查看被管主机信息</a></li>
<li><a href="#org1579d56">升级被管主机</a></li>
<li><a href="#org6684cf4">停止被管主机</a></li>
<li><a href="#org0b35031">启动被管主机</a></li>
<li><a href="#orgeb2df20">删除被管主机</a></li>
<li><a href="#org561e94c">管理远程Docker</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
Docker Machine是Docker官方提供的一个帮助我们在远程机器上安装Docker和在本地安装带Docker的虚拟机的工具。
我们还可以通过docker=machine命令来对远程主机的Docker进行管理。
</p>

<p>
Docker Machine自带了很多驱动，这些驱动将不同的虚拟机引擎与云服务商与Docker Machine整合在一起。
Docker Machine自带的驱动有:
</p>
<pre class="example">
amazonec2        digitalocean     generic          hyperv           rackspace        virtualbox       vmwarevcloudair
azure            exoscale         google           openstack        softlayer        vmwarefusion     vmwarevsphere
</pre>

<div id="outline-container-orge609f64" class="outline-2">
<h2 id="orge609f64">在本地创建带Docker的虚拟机</h2>
<div class="outline-text-2" id="text-orge609f64">
<p>
通过 <code>docker-machine create</code> 命令可以创建主机并安装虚拟机，比如下面命令会创建三个使用VirtualBox驱动的主机并且在每台主机上安装好Docker
</p>
<div class="org-src-container">
<pre class="src src-shell">docker-machine create --driver virtualbox host1
docker-machine create --driver virtualbox host2
docker-machine create --driver virtualbox host3
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Running pre-create checks...
Creating machine...
(host1) Copying <span style="font-style: italic;">/home/lujun9972/</span>.docker/machine/cache/boot2docker.iso to <span style="font-style: italic;">/home/lujun9972/</span>.docker/machine/machines/host1/boot2docker.iso...
(host1) Creating VirtualBox VM...
(host1) Creating SSH key...
(host1) Starting the VM...
(host1) Check network to re-create if needed...
(host1) Waiting for an IP...
Waiting for machine to be running, this may take a few minutes...
Detecting operating system of created instance...
Waiting for SSH to be available...
Detecting the provisioner...
Provisioning with boot2docker...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Checking connection to Docker...
Docker is up and running!
To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env host1
Running pre-create checks...
Creating machine...
(host2) Copying <span style="font-style: italic;">/home/lujun9972/</span>.docker/machine/cache/boot2docker.iso to <span style="font-style: italic;">/home/lujun9972/</span>.docker/machine/machines/host2/boot2docker.iso...
(host2) Creating VirtualBox VM...
(host2) Creating SSH key...
(host2) Starting the VM...
(host2) Check network to re-create if needed...
(host2) Waiting for an IP...
Waiting for machine to be running, this may take a few minutes...
Detecting operating system of created instance...
Waiting for SSH to be available...
Detecting the provisioner...
Provisioning with boot2docker...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Checking connection to Docker...
Docker is up and running!
To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env host2
Running pre-create checks...
Creating machine...
(host3) Copying <span style="font-style: italic;">/home/lujun9972/</span>.docker/machine/cache/boot2docker.iso to <span style="font-style: italic;">/home/lujun9972/</span>.docker/machine/machines/host3/boot2docker.iso...
(host3) Creating VirtualBox VM...
(host3) Creating SSH key...
(host3) Starting the VM...
(host3) Check network to re-create if needed...
(host3) Waiting for an IP...
Waiting for machine to be running, this may take a few minutes...
Detecting operating system of created instance...
Waiting for SSH to be available...
Detecting the provisioner...
Provisioning with boot2docker...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Checking connection to Docker...
Docker is up and running!
To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env host3
</pre>
</div>

<p>
同时，你会发现virtualbox创建了名为host1,host2,host3的三台主机
</p>
<div class="org-src-container">
<pre class="src src-shell">vboxmanage list vms
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">"winxp_default_1529148278389_22373" {5d100a8e-a670-4f84-8ea4-eb22f3dab94d}
"win7" {dddcdefb-5002-4bcd-bef2-ee37f0ba6197}
"rhel7.5" {bbf01330-070b-4663-b8e3-52734297c112}
"redis-host" {f5576790-7d12-4ee8-884f-7352c04f4e04}
"rhel_default_1532386536492_17873" {449040f4-21ef-436d-8648-a4026a547875}
"centos_default_1532472936791_11249" {86ffd1ee-681a-4062-a233-e29ac966fc81}
"freebsd" {2924b43b-da8b-4f59-ac32-ee4420923055}
"RHEL7" {33e98062-f82e-49df-9a8a-91b0eb31e80d}
"arch_default_1532990644081_68335" {2d5206ba-c07a-4691-8c3b-63e941113f15}
"ctf-tools_default_1533510374954_98487" {edd5c5d6-95e5-47af-a462-1d66aab8e640}
"host1" {ee738687-3981-4582-b2d3-3540a1cbff1c}
"host2" {d2907cef-5018-4476-a6e8-5e7c1c321cfe}
"host3" {222d485e-26c2-46e8-bc6e-cfc490d4c34a}
</pre>
</div>
</div>
</div>

<div id="outline-container-org579c368" class="outline-2">
<h2 id="org579c368">在远程主机上安装Docker</h2>
<div class="outline-text-2" id="text-org579c368">
<p>
若远程主机是在Docker Machine支持的云服务商的，那么可以直接通过对应的驱动来帮助安装Docker，方法跟上面很类似。
</p>

<p>
然若远程主机并不是在云服务商上，或者是Docker Machine所不支持的云服务商，那么可以通过 <code>generic</code> 驱动来进行安装。
</p>

<p>
在使用 <code>generic</code> 进行远程安装前，我们需要一些准备工作:
</p>

<ol class="org-ol">
<li><p>
在目标主机创建一个无需输入密码即可sudo操作的用户
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo adduser ${<span style="font-weight: bold; font-style: italic;">user</span>}
sudo usermod -a -G sudo wheel ${<span style="font-weight: bold; font-style: italic;">user</span>}
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"${user} ALL=(ALL:ALL) NOPASSWD: ALL"</span> &gt;&gt;/etc/sudoers
</pre>
</div></li>

<li><p>
在目标主机上添加密钥认证，使得登陆远程主机不同输入密码
</p>
<div class="org-src-container">
<pre class="src src-shell">ssh-copy-id ${<span style="font-weight: bold; font-style: italic;">user</span>}@${<span style="font-weight: bold; font-style: italic;">remote_host</span>}
</pre>
</div></li>
</ol>


<p>
准备工作完成后，我们可以在本地主机上运行下面命令
</p>
<div class="org-src-container">
<pre class="src src-shell">docker-machine create -d generic <span style="font-style: italic;">\</span>
    --generic-ip-address=xxx.xxx.xxx.xxx <span style="font-style: italic;">\</span>
    --generic-ssh-user=${<span style="font-weight: bold; font-style: italic;">user</span>} <span style="font-style: italic;">\</span>
    --generic-ssh-key ~/.ssh/id_rsa <span style="font-style: italic;">\</span>
    ${<span style="font-weight: bold; font-style: italic;">name</span>}
</pre>
</div>

<p>
其中 <code>${name}</code> 就是 Docker-Machine 用来管理目标主机上Docker的一个指代名称。
</p>
</div>
</div>

<div id="outline-container-org3785910" class="outline-2">
<h2 id="org3785910">管理Docker Machine</h2>
<div class="outline-text-2" id="text-org3785910">
</div>
<div id="outline-container-org1074b81" class="outline-3">
<h3 id="org1074b81">查看被管主机信息</h3>
<div class="outline-text-3" id="text-org1074b81">
<p>
Docker Machine可以用来列出、检查和升级被管主机，我们可以通过 <code>ls</code> 子命令来获得被管理的机器列表
</p>
<div class="org-src-container">
<pre class="src src-shell">docker-machine ls
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">NAME         ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER        ERRORS
host1        -        virtualbox   Running   tcp://192.168.99.100:2376           v18.06.0-ce   
host2        -        virtualbox   Running   tcp://192.168.99.101:2376           v18.06.0-ce   
host3        -        virtualbox   Running   tcp://192.168.99.102:2376           v18.06.0-ce   
redis-host   -        virtualbox   Stopped                                       Unknown       
</pre>
</div>

<p>
这个命令列出了每台被管主机的名称、创建时的驱动、状态、以及Docker Daemon访问的URL。
ACTIVE这一列若带星号，则表示这台机器是活跃的，也就是任何在本地运行的docker命令连接上的都是活跃机器上的Docker Daemon。
</p>

<p>
类似于 <code>docker</code>, 我们也可以使用 <code>inspect</code> 子命令来查看某台主机的配置
</p>
<div class="org-src-container">
<pre class="src src-shell">docker-machine inspect --format <span style="font-style: italic;">"{{.Driver.IPAddress}}"</span> host2
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">192.168.99.101
</pre>
</div>

<p>
当然，如果只是想看被管主机IP，那么可以直接通过 <code>ip</code> 子命令来查看
</p>
<div class="org-src-container">
<pre class="src src-shell">docker-machine ip host2
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">192.168.99.101
</pre>
</div>
</div>
</div>


<div id="outline-container-org1579d56" class="outline-3">
<h3 id="org1579d56">升级被管主机</h3>
<div class="outline-text-3" id="text-org1579d56">
<div class="org-src-container">
<pre class="src src-shell">docker-machine upgrade host1
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Waiting for SSH to be available...
Detecting the provisioner...
Upgrading docker...
Stopping machine to do the upgrade...
Upgrading machine "host1"...
Copying <span style="font-style: italic;">/home/lujun9972/</span>.docker/machine/cache/boot2docker.iso to <span style="font-style: italic;">/home/lujun9972/</span>.docker/machine/machines/host1/boot2docker.iso...
Starting machine back up...
(host1) Check network to re-create if needed...
(host1) Waiting for an IP...
Restarting docker...
</pre>
</div>
</div>
</div>

<div id="outline-container-org6684cf4" class="outline-3">
<h3 id="org6684cf4">停止被管主机</h3>
<div class="outline-text-3" id="text-org6684cf4">
<p>
使用 <code>stop</code> 子命令来停止被管主机
</p>
<div class="org-src-container">
<pre class="src src-shell">docker-machine stop host2
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Stopping "host2"...
Machine "host2" was stopped.
</pre>
</div>

<p>
如果使用 <code>stop</code> 子命令迟迟无法关闭被管主机，那么也可以直接使用 <code>kill</code> 命令来强制关机
</p>
</div>
</div>

<div id="outline-container-org0b35031" class="outline-3">
<h3 id="org0b35031">启动被管主机</h3>
<div class="outline-text-3" id="text-org0b35031">
<p>
使用 <code>start</code> 子命令来启动被停止的主机
</p>
<div class="org-src-container">
<pre class="src src-shell">docker-machine start host2
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Starting "host2"...
(host2) Check network to re-create if needed...
(host2) Waiting for an IP...
Machine "host2" was started.
Waiting for SSH to be available...
Detecting the provisioner...
Started machines may have new IP addresses. You may need to re-run the `docker-machine env` command.
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeb2df20" class="outline-3">
<h3 id="orgeb2df20">删除被管主机</h3>
<div class="outline-text-3" id="text-orgeb2df20">
<p>
使用 <code>rm</code> 子命令来删除被管主机
</p>
<div class="org-src-container">
<pre class="src src-shell">yes|docker-machine rm host3
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">About to remove host3
WARNING: This action will delete both local reference and remote instance.
Are you sure? (y/n): Successfully removed host3
</pre>
</div>

<p>
再次查看一下virtualbox还剩下哪些主机
</p>
<div class="org-src-container">
<pre class="src src-shell">vboxmanage list vms
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">"winxp_default_1529148278389_22373" {5d100a8e-a670-4f84-8ea4-eb22f3dab94d}
"win7" {dddcdefb-5002-4bcd-bef2-ee37f0ba6197}
"rhel7.5" {bbf01330-070b-4663-b8e3-52734297c112}
"redis-host" {f5576790-7d12-4ee8-884f-7352c04f4e04}
"rhel_default_1532386536492_17873" {449040f4-21ef-436d-8648-a4026a547875}
"centos_default_1532472936791_11249" {86ffd1ee-681a-4062-a233-e29ac966fc81}
"freebsd" {2924b43b-da8b-4f59-ac32-ee4420923055}
"RHEL7" {33e98062-f82e-49df-9a8a-91b0eb31e80d}
"arch_default_1532990644081_68335" {2d5206ba-c07a-4691-8c3b-63e941113f15}
"ctf-tools_default_1533510374954_98487" {edd5c5d6-95e5-47af-a462-1d66aab8e640}
"host1" {ee738687-3981-4582-b2d3-3540a1cbff1c}
"host2" {d2907cef-5018-4476-a6e8-5e7c1c321cfe}
</pre>
</div>

<p>
host3虚拟机被干掉了。
</p>
</div>
</div>

<div id="outline-container-org561e94c" class="outline-3">
<h3 id="org561e94c">管理远程Docker</h3>
<div class="outline-text-3" id="text-org561e94c">
<p>
我们只需要更改更改环境变量就能让Docker客户端连接上远程主机上的Docker Daemon来进行操作。
</p>

<p>
Docker Machine提供了一个 <code>env</code> 子命令来告诉你输入哪些命令可以连接到特定的机器上。
</p>

<div class="org-src-container">
<pre class="src src-shell">docker-machine env host1
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">export DOCKER_TLS_VERIFY="1"
export DOCKER_HOST="tcp://192.168.99.100:2376"
export DOCKER_CERT_PATH="<span style="font-style: italic;">/home/lujun9972/</span>.docker/machine/machines/host1"
export DOCKER_MACHINE_NAME="host1"
<span style="font-weight: bold; font-style: italic;"># Run this command to configure your shell: </span>
<span style="font-weight: bold; font-style: italic;"># eval $(docker-machine env host1)</span>
</pre>
</div>

<p>
按照说明，只需要执行 <code>eval $(docker-machine env host1)</code>, 之后Docker客户端的操作就都是在 <code>host1</code> 主机上进行的了。比如
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"&#28608;&#27963;host1&#21069;"</span>
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"check docker machines"</span>
docker-machine ls
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"check docker images"</span>
docker images |head -n 5

<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"&#28608;&#27963;host1&#21518;"</span>
<span style="font-weight: bold;">eval</span> $(<span style="font-weight: bold;">docker-machine</span> env host1)
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"check docker machines"</span>
docker-machine ls
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"check docker images"</span>
docker images |head -n 5
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">&#28608;&#27963;host1&#21069;
check docker machines
NAME         ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER        ERRORS
host1        -        virtualbox   Running   tcp://192.168.99.100:2376           v18.06.0-ce   
host2        -        virtualbox   Running   tcp://192.168.99.101:2376           v18.06.0-ce   
redis-host   -        virtualbox   Stopped                                       Unknown       
check docker images
REPOSITORY                     TAG                 IMAGE ID            CREATED             SIZE
eaf                            latest              85aaf245545d        14 hours ago        1.97GB
&lt;none&gt;                         &lt;none&gt;              071e13965b57        24 hours ago        1.97GB
&lt;none&gt;                         &lt;none&gt;              2717978972e0        24 hours ago        1.97GB
&lt;none&gt;                         &lt;none&gt;              86ac9d427d3f        24 hours ago        1.97GB
&#28608;&#27963;host1&#21518;
check docker machines
NAME         ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER        ERRORS
host1        *        virtualbox   Running   tcp://192.168.99.100:2376           v18.06.0-ce   
host2        -        virtualbox   Running   tcp://192.168.99.101:2376           v18.06.0-ce   
redis-host   -        virtualbox   Stopped                                       Unknown       
check docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
</pre>
</div>

<p>
可以发现，激活host1前和激活host1主机后有两个不同点:
</p>

<ol class="org-ol">
<li>激活host1主机后，ACTIVE这一列，在 <code>host1</code> 这一行有一个 <code>*</code> 号标识</li>
<li>激活host1主机后，docker images变成空了，因为 <code>host1</code> 主机上并没有任何镜像。</li>
</ol>
</div>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2018-08-13</span>
    <span title="last modification date" class="post-info">2018-08-18</span>
    <span title="tags" class="post-info"><a href="../../../../../tags/linux和它的小伙伴">linux和它的小伙伴</a> : <a href="../../../../../tags/docker">docker</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-9488a5c5-3f1f-487d-9f0f-a2bfa120bd0b">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
