<!DOCTYPE html>
<html lang="en">
<head>
  <title>LFS - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="linux和它的小伙伴" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="/media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  <link rel="stylesheet" href="/media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="/">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="/years/">Years</a></li>
              <li><a href="/authors/">Authors</a></li>
              <li><a href="/tags/">Tags</a></li>
              <li><a href="/about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com">Github</a></li>
              <li><a href="/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">LFS</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf3107f0">前置准备工具</a></li>
<li><a href="#org3281481">配置构建环境</a></li>
<li><a href="#org624878b">构建交叉编译器</a>
<ul>
<li><a href="#orgbed057f">设置好编译相关的变量</a></li>
<li><a href="#orgc5a80f5">安装kernel headers</a></li>
<li><a href="#orga8fac56">安装Binutils</a></li>
<li><a href="#org26ca556">静态编译的gcc</a></li>
<li><a href="#orgaf73054">编译Glibc</a></li>
<li><a href="#orge3eb5fb">最后再编译一次GCC，这次这个GCC会链接到上一步编译出来的Glibc中</a></li>
</ul>
</li>
<li><a href="#org8f76226">构建Target Image</a>
<ul>
<li><a href="#org4a2b95b">构建BusyBox</a></li>
<li><a href="#org0baac13">构建linux kernel</a></li>
<li><a href="#orgf15ac2f">Bootscripts</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgf3107f0" class="outline-2">
<h2 id="orgf3107f0">前置准备工具</h2>
<div class="outline-text-2" id="text-orgf3107f0">
<p>
在host主机上需要安装有 GCC,make,ncurses,perl以及grub-install
</p>

<p>
同时需要下载一些源代码包:
</p>

<ul class="org-ul">
<li>binutils-2.30.tar.xz</li>
<li>busybox-1.28.3.tar.bz2</li>
<li>clfs-embedded-bootscripts-1.0-pre5.tar.bz2</li>
<li>gcc-7.3.0.tar.xz</li>
<li>glibc-2.27.tar.xz</li>
<li>gmp-6.1.2.tar.bz2</li>
<li>linux-4.16.3.tar.xz</li>
<li>mpc-1.1.0.tar.gz</li>
<li>mpfr-4.0.1.tar.xz</li>
<li>zlib-1.2.11.tar.gz</li>
</ul>
</div>
</div>


<div id="outline-container-org3281481" class="outline-2">
<h2 id="org3281481">配置构建环境</h2>
<div class="outline-text-2" id="text-org3281481">
<ol class="org-ol">
<li><p>
启用bash hash功能
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">set</span> +h
</pre>
</div></li>

<li><p>
新建目录/文件只有属主具有写权限
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">umask</span> 022
</pre>
</div></li>

<li><p>
设置环境变量
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">export</span> <span style="font-weight: bold; font-style: italic;">LJOS</span>=~/LFS
mkdir -p ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}
<span style="font-weight: bold;">export</span> <span style="font-weight: bold; font-style: italic;">LC_ALL</span>=POSIX
<span style="font-weight: bold;">export</span> <span style="font-weight: bold; font-style: italic;">PATH</span>=${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/cross-tools/bin:/bin:/usr/bin
</pre>
</div></li>

<li><p>
创建<a href="http://refspecs.linuxfoundation.org/fhs.shtml">Linux目录层级结构</a>
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir -pv ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/{bin,boot{,grub},dev,{etc/,}opt,home,lib/{firmware,modules},lib64,mnt}
mkdir -pv ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/{proc,media/{floppy,cdrom},sbin,srv,sys}
mkdir -pv ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/var/{lock,log,mail,run,spool}
mkdir -pv ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/var/{opt,cache,lib/{misc,locate},local}
install -dv -m 0750 ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/root
install -dv -m 1777 ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}{/var,}/tmp
install -dv ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/etc/init.d
mkdir -pv ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/usr/{,local/}{bin,include,lib{,64},sbin,src}
mkdir -pv ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/usr/{,local/}share/{doc,info,locale,man}
mkdir -pv ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/usr/{,local/}share/{misc,terminfo,zoneinfo}
mkdir -pv ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/usr/{,local/}share/man/man{1,2,3,4,5,6,7,8}
<span style="font-weight: bold;">for</span> dir<span style="font-weight: bold;"> in</span> ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/usr{,/local}; <span style="font-weight: bold;">do</span>
    ln -sv share/{man,doc,info} ${<span style="font-weight: bold; font-style: italic;">dir</span>}
<span style="font-weight: bold;">done</span>
</pre>
</div></li>

<li><p>
创建存放交叉编译工具链的目录
</p>
<div class="org-src-container">
<pre class="src src-shell">install -dv ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/cross-tools{,/bin}
</pre>
</div></li>

<li><p>
创建各个配置文件
</p>

<p>
使用 <code>/proc/mounts</code> 的值作为LFS中的 <code>/etc/mtab</code> 文件
</p>
<div class="org-src-container">
<pre class="src src-shell">ln -svf ../proc/mounts ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/etc/mtab
</pre>
</div>

<p>
创建 <code>/etc/passwd</code> 文件，这一步用来创建LFS中的root账户
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/etc/passwd &lt;&lt; <span style="font-style: italic;">"EOF"</span>
<span style="font-weight: bold;">root::0:0:root:/root:/bin/ash</span>
<span style="font-weight: bold;">EOF</span>
</pre>
</div>

<p>
创建 <code>/etc/group</code> 文件
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/etc/group &lt;&lt; <span style="font-style: italic;">"EOF"</span>
<span style="font-weight: bold;">root:x:0:</span>
<span style="font-weight: bold;">bin:x:1:</span>
<span style="font-weight: bold;">sys:x:2:</span>
<span style="font-weight: bold;">kmem:x:3:</span>
<span style="font-weight: bold;">tty:x:4:</span>
<span style="font-weight: bold;">daemon:x:6:</span>
<span style="font-weight: bold;">disk:x:8:</span>
<span style="font-weight: bold;">dialout:x:10:</span>
<span style="font-weight: bold;">video:x:12:</span>
<span style="font-weight: bold;">utmp:x:13:</span>
<span style="font-weight: bold;">usb:x:14:</span>
<span style="font-weight: bold;">EOF</span>
</pre>
</div>

<p>
创建 <code>/etc/fstab</code>
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/etc/fstab &lt;&lt; <span style="font-style: italic;">"EOF"</span>
<span style="font-weight: bold;"># file system  mount-point  type   options          dump  fsck</span>
<span style="font-weight: bold;">#                                                         order</span>

<span style="font-weight: bold;">rootfs          /               auto    defaults        1      1</span>
<span style="font-weight: bold;">proc            /proc           proc    defaults        0      0</span>
<span style="font-weight: bold;">sysfs           /sys            sysfs   defaults        0      0</span>
<span style="font-weight: bold;">devpts          /dev/pts        devpts  gid=4,mode=620  0      0</span>
<span style="font-weight: bold;">tmpfs           /dev/shm        tmpfs   defaults        0      0</span>
<span style="font-weight: bold;">EOF</span>
</pre>
</div>

<p>
创建 <code>/etc/profile</code>
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/etc/profile &lt;&lt; <span style="font-style: italic;">"EOF"</span>
<span style="font-weight: bold;">export PATH=/bin:/usr/bin</span>

<span style="font-weight: bold;">if [ `id -u` -eq 0 ] ; then</span>
<span style="font-weight: bold;">        PATH=/bin:/sbin:/usr/bin:/usr/sbin</span>
<span style="font-weight: bold;">        unset HISTFILE</span>
<span style="font-weight: bold;">fi</span>


<span style="font-weight: bold;"># Set up some environment variables.</span>
<span style="font-weight: bold;">export USER=`id -un`</span>
<span style="font-weight: bold;">export LOGNAME=$USER</span>
<span style="font-weight: bold;">export HOSTNAME=`/bin/hostname`</span>
<span style="font-weight: bold;">export HISTSIZE=1000</span>
<span style="font-weight: bold;">export HISTFILESIZE=1000</span>
<span style="font-weight: bold;">export PAGER='/bin/more '</span>
<span style="font-weight: bold;">export EDITOR='/bin/vi'</span>
<span style="font-weight: bold;">EOF</span>
</pre>
</div>

<p>
设置主机名
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"LFS"</span> &gt; ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/etc/HOSTNAME
</pre>
</div>

<p>
设置登陆提示
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/etc/issue&lt;&lt; <span style="font-style: italic;">"EOF"</span>
<span style="font-weight: bold;">Linux From Scratch OS 0.1a</span>
<span style="font-weight: bold;">Kernel \r on an \m</span>

<span style="font-weight: bold;">EOF</span>
</pre>
</div>

<p>
为了简单期间，使用BusyBox的 init 进程作为初始化进程，因此需要定义 <code>/etc/inittab</code>
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/etc/inittab&lt;&lt; <span style="font-style: italic;">"EOF"</span>
<span style="font-weight: bold;">::sysinit:/etc/rc.d/startup</span>

<span style="font-weight: bold;">tty1::respawn:/sbin/getty 38400 tty1</span>
<span style="font-weight: bold;">tty2::respawn:/sbin/getty 38400 tty2</span>
<span style="font-weight: bold;">tty3::respawn:/sbin/getty 38400 tty3</span>
<span style="font-weight: bold;">tty4::respawn:/sbin/getty 38400 tty4</span>
<span style="font-weight: bold;">tty5::respawn:/sbin/getty 38400 tty5</span>
<span style="font-weight: bold;">tty6::respawn:/sbin/getty 38400 tty6</span>

<span style="font-weight: bold;">::shutdown:/etc/rc.d/shutdown</span>
<span style="font-weight: bold;">::ctrlaltdel:/sbin/reboot</span>
<span style="font-weight: bold;">EOF</span>
</pre>
</div>

<p>
同样的，BusyBox 使用mdev代替udev，因此需要定义 <code>/etc/mdev</code>
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/etc/mdev.conf&lt;&lt; <span style="font-style: italic;">"EOF"</span>
<span style="font-weight: bold;"># Devices:</span>
<span style="font-weight: bold;"># Syntax: %s %d:%d %s</span>
<span style="font-weight: bold;"># devices user:group mode</span>

<span style="font-weight: bold;"># null does already exist; therefore ownership has to</span>
<span style="font-weight: bold;"># be changed with command</span>
<span style="font-weight: bold;">null    root:root 0666  @chmod 666 $MDEV</span>
<span style="font-weight: bold;">zero    root:root 0666</span>
<span style="font-weight: bold;">grsec   root:root 0660</span>
<span style="font-weight: bold;">full    root:root 0666</span>

<span style="font-weight: bold;">random  root:root 0666</span>
<span style="font-weight: bold;">urandom root:root 0444</span>
<span style="font-weight: bold;">hwrandom root:root 0660</span>

<span style="font-weight: bold;"># console does already exist; therefore ownership has to</span>
<span style="font-weight: bold;"># be changed with command</span>
<span style="font-weight: bold;">console root:tty 0600 @mkdir -pm 755 fd &amp;&amp; cd fd &amp;&amp; for x</span>
<span style="font-weight: bold;"> &#8618;in 0 1 2 3 ; do ln -sf /proc/self/fd/$x $x; done</span>

<span style="font-weight: bold;">kmem    root:root 0640</span>
<span style="font-weight: bold;">mem     root:root 0640</span>
<span style="font-weight: bold;">port    root:root 0640</span>
<span style="font-weight: bold;">ptmx    root:tty 0666</span>

<span style="font-weight: bold;"># ram.*</span>
<span style="font-weight: bold;">ram([0-9]*)     root:disk 0660 &gt;rd/%1</span>
<span style="font-weight: bold;">loop([0-9]+)    root:disk 0660 &gt;loop/%1</span>
<span style="font-weight: bold;">sd[a-z].*       root:disk 0660 */lib/mdev/usbdisk_link</span>
<span style="font-weight: bold;">hd[a-z][0-9]*   root:disk 0660 */lib/mdev/ide_links</span>

<span style="font-weight: bold;">tty             root:tty 0666</span>
<span style="font-weight: bold;">tty[0-9]        root:root 0600</span>
<span style="font-weight: bold;">tty[0-9][0-9]   root:tty 0660</span>
<span style="font-weight: bold;">ttyO[0-9]*      root:tty 0660</span>
<span style="font-weight: bold;">pty.*           root:tty 0660</span>
<span style="font-weight: bold;">vcs[0-9]*       root:tty 0660</span>
<span style="font-weight: bold;">vcsa[0-9]*      root:tty 0660</span>

<span style="font-weight: bold;">ttyLTM[0-9]     root:dialout 0660 @ln -sf $MDEV modem</span>
<span style="font-weight: bold;">ttySHSF[0-9]    root:dialout 0660 @ln -sf $MDEV modem</span>
<span style="font-weight: bold;">slamr           root:dialout 0660 @ln -sf $MDEV slamr0</span>
<span style="font-weight: bold;">slusb           root:dialout 0660 @ln -sf $MDEV slusb0</span>
<span style="font-weight: bold;">fuse            root:root  0666</span>

<span style="font-weight: bold;"># misc stuff</span>
<span style="font-weight: bold;">agpgart         root:root 0660  &gt;misc/</span>
<span style="font-weight: bold;">psaux           root:root 0660  &gt;misc/</span>
<span style="font-weight: bold;">rtc             root:root 0664  &gt;misc/</span>

<span style="font-weight: bold;"># input stuff</span>
<span style="font-weight: bold;">event[0-9]+     root:root 0640 =input/</span>
<span style="font-weight: bold;">ts[0-9]         root:root 0600 =input/</span>

<span style="font-weight: bold;"># v4l stuff</span>
<span style="font-weight: bold;">vbi[0-9]        root:video 0660 &gt;v4l/</span>
<span style="font-weight: bold;">video[0-9]      root:video 0660 &gt;v4l/</span>

<span style="font-weight: bold;"># load drivers for usb devices</span>
<span style="font-weight: bold;">usbdev[0-9].[0-9]       root:root 0660 */lib/mdev/usbdev</span>
<span style="font-weight: bold;">usbdev[0-9].[0-9]_.*    root:root 0660</span>
<span style="font-weight: bold;">EOF</span>
</pre>
</div>

<p>
为GRUB引导器创建配置文件
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/boot/grub/grub.cfg&lt;&lt; <span style="font-style: italic;">"EOF"</span>

<span style="font-weight: bold;">set default=0</span>
<span style="font-weight: bold;">set timeout=5</span>

<span style="font-weight: bold;">set root=(hd0,1)</span>

<span style="font-weight: bold;">menuentry "Linux From Scratch OS" {</span>
<span style="font-weight: bold;">        linux   /boot/vmlinuz-4.16.3 root=/dev/sda1 ro quiet</span>
<span style="font-weight: bold;">}</span>
<span style="font-weight: bold;">EOF</span>
</pre>
</div>

<p>
创建日志文件
</p>
<div class="org-src-container">
<pre class="src src-shell">touch ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/var/run/utmp ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/var/log/{btmp,lastlog,wtmp}
chmod -v 664 ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/var/run/utmp ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/var/log/lastlog
</pre>
</div></li>
</ol>
</div>
</div>


<div id="outline-container-org624878b" class="outline-2">
<h2 id="org624878b">构建交叉编译器</h2>
<div class="outline-text-2" id="text-org624878b">
</div>
<div id="outline-container-orgbed057f" class="outline-3">
<h3 id="orgbed057f">设置好编译相关的变量</h3>
<div class="outline-text-3" id="text-orgbed057f">
<p>
清空host上预设的 C/C++ 编译标志
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">unset</span> CFLAGS
<span style="font-weight: bold;">unset</span> CXXFLAGS
</pre>
</div>

<p>
定义其他交叉编译过程中使用的变量
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">export</span> <span style="font-weight: bold; font-style: italic;">LJOS_HOST</span>=$(<span style="font-weight: bold;">echo</span> ${<span style="font-weight: bold; font-style: italic;">MACHTYPE</span>} | sed <span style="font-style: italic;">"s/-[^-]*/-cross/"</span>)
<span style="font-weight: bold;">export</span> <span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>=x86_64-unknown-linux-gnu
<span style="font-weight: bold;">export</span> <span style="font-weight: bold; font-style: italic;">LJOS_CPU</span>=k4
<span style="font-weight: bold;">export</span> <span style="font-weight: bold; font-style: italic;">LJOS_ARCH</span>=$(<span style="font-weight: bold;">echo</span> ${<span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>} | sed -e <span style="font-style: italic;">'s/-.*//'</span> -e <span style="font-style: italic;">'s/i.86/i386/'</span>)
<span style="font-weight: bold;">export</span> <span style="font-weight: bold; font-style: italic;">LJOS_ENDIAN</span>=little
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc5a80f5" class="outline-3">
<h3 id="orgc5a80f5">安装kernel headers</h3>
<div class="outline-text-3" id="text-orgc5a80f5">
<p>
从<a href="https://www.kernel.org/">kernel.org</a>下载内核源码
</p>
<div class="org-src-container">
<pre class="src src-shell">wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.18.4.tar.xz
</pre>
</div>

<p>
解压源代码
</p>
<div class="org-src-container">
<pre class="src src-shell">tar -xf linux-4.18.4.tar.xz 
</pre>
</div>

<p>
编译kernel headers
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">cd</span> linux-4.18.4/
make mrproper
make <span style="font-weight: bold; font-style: italic;">ARCH</span>=${<span style="font-weight: bold; font-style: italic;">LJOS_ARCH</span>} headers_check &amp;&amp; <span style="font-style: italic;">\</span>
make <span style="font-weight: bold; font-style: italic;">ARCH</span>=${<span style="font-weight: bold; font-style: italic;">LJOS_ARCH</span>} <span style="font-weight: bold; font-style: italic;">INSTALL_HDR_PATH</span>=dest headers_install
cp -rv dest/include/* ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/usr/include
</pre>
</div>
</div>
</div>

<div id="outline-container-orga8fac56" class="outline-3">
<h3 id="orga8fac56">安装Binutils</h3>
<div class="outline-text-3" id="text-orga8fac56">
<p>
下载bintuils源代码
</p>
<div class="org-src-container">
<pre class="src src-shell">wget http://ftp.gnu.org/gnu/binutils/binutils-2.31.tar.xz
</pre>
</div>

<p>
解压源代码
</p>
<div class="org-src-container">
<pre class="src src-shell">tar -xf binutils-2.31.tar.xz
</pre>
</div>

<p>
编译binutils
</p>
<div class="org-src-container">
<pre class="src src-shell">./configure --prefix=${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/cross-tools <span style="font-style: italic;">\</span>
--target=${<span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>} --with-sysroot=${<span style="font-weight: bold; font-style: italic;">LJOS</span>} <span style="font-style: italic;">\</span>
--disable-nls --enable-shared --disable-multilib
make configure-host &amp;&amp; make
ln -sv lib ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/cross-tools/lib64
make install
cp -v include/libiberty.h ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/usr/include
</pre>
</div>
</div>
</div>

<div id="outline-container-org26ca556" class="outline-3">
<h3 id="org26ca556">静态编译的gcc</h3>
<div class="outline-text-3" id="text-org26ca556">
<p>
下载 gcc，gmp，mpfr，mpc
</p>
<div class="org-src-container">
<pre class="src src-shell">wget http://ftp.gnu.org/gnu/gcc/gcc-8.2.0/gcc-8.2.0.tar.xz <span style="font-style: italic;">\</span>
     http://ftp.gnu.org/gnu/gmp/gmp-6.1.2.tar.xz <span style="font-style: italic;">\</span>
     http://ftp.gnu.org/gnu/mpfr/mpfr-4.0.1.tar.xz <span style="font-style: italic;">\</span>
     http://ftp.gnu.org/gnu/mpc/mpc-1.1.0.tar.gz
</pre>
</div>

<p>
解压 gcc，gmp，mpfr，mpc
</p>
<div class="org-src-container">
<pre class="src src-shell">tar -xf gcc-8.2.0.tar.xz
tar -xf gmp-6.1.2.tar.xz
tar -xf mpfr-4.0.1.tar.xz
tar -xf mpc-1.1.0.tar.gz
</pre>
</div>

<p>
将gmp,mpfr,mpc移动到gcc目录下
</p>
<div class="org-src-container">
<pre class="src src-shell">mv gmp-6.1.2 gcc-8.2.0/gmp
mv mpfr-4.0.1 gcc-8.2.0/mpfr
mv mpc-1.1.0 gcc-8.2.0/mpc
</pre>
</div>

<p>
编译gcc
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir gcc-static
<span style="font-weight: bold;">cd</span> gcc-static/
<span style="font-weight: bold; font-style: italic;">AR</span>=ar <span style="font-weight: bold; font-style: italic;">LDFLAGS</span>=<span style="font-style: italic;">"-Wl,-rpath,${LJOS}/cross-tools/lib"</span> <span style="font-style: italic;">\</span>
../gcc-8.2.0/configure --prefix=${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/cross-tools <span style="font-style: italic;">\</span>
--build=${<span style="font-weight: bold; font-style: italic;">LJOS_HOST</span>} --host=${<span style="font-weight: bold; font-style: italic;">LJOS_HOST</span>} <span style="font-style: italic;">\</span>
--target=${<span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>} <span style="font-style: italic;">\</span>
--with-sysroot=${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/target --disable-nls <span style="font-style: italic;">\</span>
--disable-shared <span style="font-style: italic;">\</span>
--with-mpfr-include=$(<span style="font-weight: bold;">pwd</span>)/../gcc-8.2.0/mpfr/src <span style="font-style: italic;">\</span>
--with-mpfr-lib=$(<span style="font-weight: bold;">pwd</span>)/mpfr/src/.libs <span style="font-style: italic;">\</span>
--without-headers --with-newlib --disable-decimal-float <span style="font-style: italic;">\</span>
--disable-libgomp --disable-libmudflap --disable-libssp <span style="font-style: italic;">\</span>
--disable-threads --enable-languages=c,c++ <span style="font-style: italic;">\</span>
--disable-multilib --with-arch=${<span style="font-weight: bold; font-style: italic;">LJOS_CPU</span>}
make all-gcc all-target-libgcc &amp;&amp; <span style="font-style: italic;">\</span>
make install-gcc install-target-libgcc
ln -vs libgcc.a $(${<span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>}-gcc -print-libgcc-file-name | sed <span style="font-style: italic;">'s/libgcc/&amp;_eh/'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaf73054" class="outline-3">
<h3 id="orgaf73054">编译Glibc</h3>
<div class="outline-text-3" id="text-orgaf73054">
<p>
下载glibc
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">cd</span> ..
wget http://ftp.gnu.org/gnu/glibc/glibc-2.28.tar.xz
</pre>
</div>

<p>
解压glibc
</p>
<div class="org-src-container">
<pre class="src src-shell">tar -xf glibc-2.28.tar.xz
</pre>
</div>

<p>
编译glibc
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir glibc-build
<span style="font-weight: bold;">cd</span> glibc-build/
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"libc_cv_forced_unwind=yes"</span> &gt; config.cache
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"libc_cv_c_cleanup=yes"</span> &gt;&gt; config.cache
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"libc_cv_ssp=no"</span> &gt;&gt; config.cache
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"libc_cv_ssp_strong=no"</span> &gt;&gt; config.cache
<span style="font-weight: bold; font-style: italic;">BUILD_CC</span>=<span style="font-style: italic;">"gcc"</span> <span style="font-weight: bold; font-style: italic;">CC</span>=<span style="font-style: italic;">"${LJOS_TARGET}-gcc"</span> <span style="font-style: italic;">\</span>
<span style="font-weight: bold; font-style: italic;">AR</span>=<span style="font-style: italic;">"${LJOS_TARGET}-ar"</span> <span style="font-style: italic;">\</span>
<span style="font-weight: bold; font-style: italic;">RANLIB</span>=<span style="font-style: italic;">"${LJOS_TARGET}-ranlib"</span> <span style="font-weight: bold; font-style: italic;">CFLAGS</span>=<span style="font-style: italic;">"-O2"</span> <span style="font-style: italic;">\</span>
../glibc-2.28/configure --prefix=/usr <span style="font-style: italic;">\</span>
--host=${<span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>} --build=${<span style="font-weight: bold; font-style: italic;">LJOS_HOST</span>} <span style="font-style: italic;">\</span>
--disable-profile --enable-add-ons --with-tls <span style="font-style: italic;">\</span>
--enable-kernel=2.6.32 --with-__thread <span style="font-style: italic;">\</span>
--with-binutils=${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/cross-tools/bin <span style="font-style: italic;">\</span>
--with-headers=${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/usr/include <span style="font-style: italic;">\</span>
--cache-file=config.cache
make &amp;&amp; make <span style="font-weight: bold; font-style: italic;">install_root</span>=${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/ install
</pre>
</div>
</div>
</div>

<div id="outline-container-orge3eb5fb" class="outline-3">
<h3 id="orge3eb5fb">最后再编译一次GCC，这次这个GCC会链接到上一步编译出来的Glibc中</h3>
<div class="outline-text-3" id="text-orge3eb5fb">
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">cd</span> ..
mkdir gcc-build
<span style="font-weight: bold;">cd</span> gcc-build/
<span style="font-weight: bold; font-style: italic;">AR</span>=ar <span style="font-weight: bold; font-style: italic;">LDFLAGS</span>=<span style="font-style: italic;">"-Wl,-rpath,${LJOS}/cross-tools/lib"</span> <span style="font-style: italic;">\</span>
../gcc-8.2.0/configure --prefix=${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/cross-tools <span style="font-style: italic;">\</span>
--build=${<span style="font-weight: bold; font-style: italic;">LJOS_HOST</span>} --target=${<span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>} <span style="font-style: italic;">\</span>
--host=${<span style="font-weight: bold; font-style: italic;">LJOS_HOST</span>} --with-sysroot=${<span style="font-weight: bold; font-style: italic;">LJOS</span>} <span style="font-style: italic;">\</span>
--disable-nls --enable-shared <span style="font-style: italic;">\</span>
--enable-languages=c,c++ --enable-c99 <span style="font-style: italic;">\</span>
--enable-long-long <span style="font-style: italic;">\</span>
--with-mpfr-include=$(<span style="font-weight: bold;">pwd</span>)/../gcc-8.2.0/mpfr/src <span style="font-style: italic;">\</span>
--with-mpfr-lib=$(<span style="font-weight: bold;">pwd</span>)/mpfr/src/.libs <span style="font-style: italic;">\</span>
--disable-multilib --with-arch=${<span style="font-weight: bold; font-style: italic;">LJOS_CPU</span>}
make &amp;&amp; make install
cp -v ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/cross-tools/${<span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>}/lib64/libgcc_s.so.1 ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/lib64
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8f76226" class="outline-2">
<h2 id="org8f76226">构建Target Image</h2>
<div class="outline-text-2" id="text-org8f76226">
</div>
<div id="outline-container-org4a2b95b" class="outline-3">
<h3 id="org4a2b95b">构建BusyBox</h3>
<div class="outline-text-3" id="text-org4a2b95b">
<p>
下载 BusyBox
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">cd</span> ..
wget http://busybox.net/downloads/busybox-1.29.2.tar.bz2
</pre>
</div>

<p>
解压源码包
</p>
<div class="org-src-container">
<pre class="src src-shell">tar -xf busybox-1.29.2.tar.bz2
</pre>
</div>

<p>
编译BusyBox
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">cd</span> busybox-1.29.2/
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29983;&#25104;&#40664;&#35748;&#30340;&#32534;&#35793;&#37197;&#32622;&#25991;&#20214;</span>
make <span style="font-weight: bold; font-style: italic;">CROSS_COMPILE</span>=<span style="font-style: italic;">"${LJOS_TARGET}-"</span> defconfig
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#38656;&#35201;&#30340;&#35805;&#65292;&#21487;&#20197;&#36890;&#36807;menuconfig&#26469;&#23545;&#37197;&#32622;&#23601;&#20687;&#35843;&#25972;</span>
make <span style="font-weight: bold; font-style: italic;">CROSS_COMPILE</span>=<span style="font-style: italic;">"${LJOS_TARGET}-"</span> menuconfig
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32534;&#35793;</span>
make <span style="font-weight: bold; font-style: italic;">CROSS_COMPILE</span>=<span style="font-style: italic;">"${LJOS_TARGET}-"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23433;&#35013;</span>
make <span style="font-weight: bold; font-style: italic;">CROSS_COMPILE</span>=<span style="font-style: italic;">"${LJOS_TARGET}-"</span> <span style="font-style: italic;">\</span>
<span style="font-weight: bold; font-style: italic;">CONFIG_PREFIX</span>=<span style="font-style: italic;">"${LJOS}"</span> install
</pre>
</div>

<p>
拷贝depmod.pl,后面构建kernel的时候要用
</p>
<div class="org-src-container">
<pre class="src src-shell">cp -v examples/depmod.pl ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/cross-tools/bin
chmod 755 ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/cross-tools/bin/depmod.pl
</pre>
</div>
</div>
</div>

<div id="outline-container-org0baac13" class="outline-3">
<h3 id="org0baac13">构建linux kernel</h3>
<div class="outline-text-3" id="text-org0baac13">
<p>
生成默认的x86-64的配置文件
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">cd</span> ../linux-4.18.4/
make <span style="font-weight: bold; font-style: italic;">ARCH</span>=${<span style="font-weight: bold; font-style: italic;">LJOS_ARCH</span>} <span style="font-style: italic;">\</span>
     <span style="font-weight: bold; font-style: italic;">CROSS_COMPILE</span>=${<span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>}- x86_64_defconfig
</pre>
</div>

<p>
当然，你也可以通过 <code>make menuconfig</code> 进行微调
</p>

<p>
比如安装Target Image到VirutalBox虚拟机中，则需要安装 Intel 的 <code>e1000</code> 网卡模块以及 LSI 的 <code>mpt2sas</code> 模块
</p>
<div class="org-src-container">
<pre class="src src-shell">make <span style="font-weight: bold; font-style: italic;">ARCH</span>=${<span style="font-weight: bold; font-style: italic;">LJOS_ARCH</span>} <span style="font-style: italic;">\</span>
     <span style="font-weight: bold; font-style: italic;">CROSS_COMPILE</span>=${<span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>}- menuconfig
</pre>
</div>

<p>
编译并安装kernel
</p>
<div class="org-src-container">
<pre class="src src-shell">make <span style="font-weight: bold; font-style: italic;">ARCH</span>=${<span style="font-weight: bold; font-style: italic;">LJOS_ARCH</span>} <span style="font-style: italic;">\</span>
     <span style="font-weight: bold; font-style: italic;">CROSS_COMPILE</span>=${<span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>}-
make <span style="font-weight: bold; font-style: italic;">ARCH</span>=${<span style="font-weight: bold; font-style: italic;">LJOS_ARCH</span>} <span style="font-style: italic;">\</span>
     <span style="font-weight: bold; font-style: italic;">CROSS_COMPILE</span>=${<span style="font-weight: bold; font-style: italic;">LJOS_TARGET</span>}- <span style="font-style: italic;">\</span>
     <span style="font-weight: bold; font-style: italic;">INSTALL_MOD_PATH</span>=${<span style="font-weight: bold; font-style: italic;">LJOS</span>} modules_install
</pre>
</div>

<p>
拷贝文件到 target 的 <code>/boot</code> 目录下
</p>
<div class="org-src-container">
<pre class="src src-shell">cp -v arch/x86/boot/bzImage ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/boot/vmlinuz-4.18.4
cp -v System.map ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/boot/System.map-4.18.4
cp -v .config ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/boot/config-4.18.4
</pre>
</div>

<p>
运行 <code>depmod.pl</code>
</p>
<div class="org-src-container">
<pre class="src src-shell">${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/cross-tools/bin/depmod.pl <span style="font-style: italic;">\</span>
      -F ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/boot/System.map-4.18.4 <span style="font-style: italic;">\</span>
      -b ${<span style="font-weight: bold; font-style: italic;">LJOS</span>}/lib/modules/4.18.4
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf15ac2f" class="outline-3">
<h3 id="orgf15ac2f">Bootscripts</h3>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2018-08-24</span>
    <span title="last modification date" class="post-info">2018-10-15</span>
    <span title="tags" class="post-info"><a href="/tags/linux和它的小伙伴">linux和它的小伙伴</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="/media/js/jquery-2.1.3.min.js"></script>
  <script src="/media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="/media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-bac9dec7-ec0a-4eb9-963f-b39087028fe9">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
