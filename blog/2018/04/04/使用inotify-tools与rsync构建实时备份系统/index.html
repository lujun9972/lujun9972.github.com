<!DOCTYPE html>
<html lang="en">
<head>
  <title>使用inotify-tools与rsync构建实时备份系统 - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="linux和它的小伙伴" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="/media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  <link rel="stylesheet" href="/media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="/">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="/years/">Years</a></li>
              <li><a href="/authors/">Authors</a></li>
              <li><a href="/tags/">Tags</a></li>
              <li><a href="/about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com">Github</a></li>
              <li><a href="/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">使用inotify-tools与rsync构建实时备份系统</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org97bf03b">使用inotifywait监控文件变动</a></li>
<li><a href="#orgb39f7ee">使用rsync同步变动</a></li>
<li><a href="#org6cbc1b6">整合起来</a></li>
<li><a href="#org3401029">改进</a></li>
</ul>
</div>
</div>

<div id="outline-container-org97bf03b" class="outline-2">
<h2 id="org97bf03b">使用inotifywait监控文件变动</h2>
<div class="outline-text-2" id="text-org97bf03b">
<p>
inotifywait是 <code>inotify-tools</code> 包中提供的一个工具，它使用 <code>inotify</code> API 来监控文件/目录中的变动情况。
</p>

<p>
在archlinux上，我们可以使用下面命令来安装
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo pacman -S --noconfirm inotify-tools
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">resolving dependencies...
looking for conflicting packages...

Packages (1) inotify-tools-3.20.1-1

Total Installed Size:  0.69 MiB
Net Upgrade Size:      0.00 MiB

:: Proceed with installation? [Y/n] 
(0/1) checking keys in keyring                     [----------------------]   0%(1/1) checking keys in keyring                     [######################] 100%
(0/1) checking package integrity                   [----------------------]   0%(1/1) checking package integrity                   [######################] 100%
(0/1) loading package files                        [----------------------]   0%(1/1) loading package files                        [######################] 100%
(0/1) checking for file conflicts                  [----------------------]   0%(1/1) checking for file conflicts                  [######################] 100%
(0/1) checking available disk space                [----------------------]   0%(1/1) checking available disk space                [######################] 100%
:: Processing package changes...
(1/1) reinstalling inotify-tools                   [----------------------]   0%(1/1) reinstalling inotify-tools                   [######################] 100%
:: Running post-transaction hooks...
(1/1) Arming ConditionNeedsUpdate...
</pre>
</div>

<p>
平时 <code>inotifywait</code> 会挂起在那里，直到文件/目录发生了要引起关注的事件后，它会退出并输出事件发生的场所、事件的名称以及引起事件的文件（当事件发生在目录上时才会输出）.
</p>

<p>
<code>inotifywait</code> 最常用的选项有两个，一个是 <code>-r</code> 一个是 <code>-e</code> ，其中：
</p>

<dl class="org-dl">
<dt>-r</dt><dd>表示递归监控子目录中文件发生的事件</dd>
<dt>-e</dt><dd>指定要监控的事件列表。对于备份系统来说，只需要监控 modify、create和delete三种事件就行了。</dd>
</dl>

<p>
比如，我们运行
</p>
<div class="org-src-container">
<pre class="src src-shell">inotifywait -r -e modify,create,delete /tmp
</pre>
</div>

<p>
表示监控 <code>/tmp</code> 目录及其子目录中文件修改、文件创建和文件删除三种事件。
</p>

<p>
这时程序一直在挂起状态
</p>
<pre class="example">
[lujun9972@X61 ~]$ inotifywait -r -e modify,create,delete /tmp
Setting up watches.  Beware: since -r was given, this may take a while!
Watches established.
</pre>

<p>
这时在 <code>/tmp</code> 目录下新建一个文件
</p>
<div class="org-src-container">
<pre class="src src-shell">touch /tmp/newFile
</pre>
</div>

<p>
则 <code>inotifywait</code> 进程退出，并输出如下信息
</p>
<pre class="example">
/tmp/ CREATE newFile
</pre>
</div>
</div>

<div id="outline-container-orgb39f7ee" class="outline-2">
<h2 id="orgb39f7ee">使用rsync同步变动</h2>
<div class="outline-text-2" id="text-orgb39f7ee">
<p>
rsync是一款快速增量备份工具。它的具有以下几个特点使得它很适合用作做备份的工具：
</p>

<ul class="org-ul">
<li>增量备份,只会传输修改过的内容</li>
<li>可以在传输过程中实时解压缩，减少带宽消耗</li>
<li>可以保持原来文件的权限、事件、软硬链接</li>
<li>即支持本机复制，也支持远程复制</li>
</ul>

<p>
rsync常用法为：
</p>
<div class="org-src-container">
<pre class="src src-shell">rsync -avz --delete  src/ foo:/data
</pre>
</div>

<p>
其中
</p>
<dl class="org-dl">
<dt>-a</dt><dd>表示archive mode，即备份目录下的所有内容(包括子目录中的内容),并且保持软链接、文件属性、文件修改事件、文件的所有者和宿主信息不变，并且同步字符/块设备以及命名socket和fifo等特殊文件。</dd>
<dt>-v</dt><dd>表示输出备份的详细信息</dd>
<dt>-z</dt><dd>表示传输时进行压缩</dd>
<dt>--delete</dt><dd>删除备份目的地里src中没有的文件</dd>
<dt>src/</dt><dd>表示要备份的是src目录下的所有内容，注意这里最后的 <code>/</code> 不能去掉，否则会把src目录本身备份过去</dd>
<dt>foo:/data</dt><dd>表示备份的目的地是foo主机下的 <code>/data/</code> 目录</dd>
</dl>
</div>
</div>

<div id="outline-container-org6cbc1b6" class="outline-2">
<h2 id="org6cbc1b6">整合起来</h2>
<div class="outline-text-2" id="text-org6cbc1b6">
<p>
接下来我们只需要用个 <code>while</code> 死循环把两个工具整合起来就行了，非常简单
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/bin/</span><span style="font-weight: bold;">bash</span>

<span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">#</span> -ne 2 ]];<span style="font-weight: bold;">then</span>
    cat&lt;&lt;EOF
<span style="font-weight: bold;">Usage $(</span><span style="font-weight: bold;">basename</span><span style="font-weight: bold;"> $0) source_dir [host:]dest_dir</span>
<span style="font-weight: bold;">EOF</span>
    <span style="font-weight: bold;">exit</span> 0
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;">source_dir</span>=$<span style="font-weight: bold; font-style: italic;">1</span>
<span style="font-weight: bold; font-style: italic;">dest_dir</span>=$<span style="font-weight: bold; font-style: italic;">2</span>
<span style="font-weight: bold;">while</span> :
<span style="font-weight: bold;">do</span>
    inotifywait -r -e modify,create,delete ${<span style="font-weight: bold; font-style: italic;">source_dir</span>} &amp;&amp; rsync -avz ${<span style="font-weight: bold; font-style: italic;">source_dir</span>}/ ${<span style="font-weight: bold; font-style: italic;">dest_dir</span>} --delete
<span style="font-weight: bold;">done</span>
</pre>
</div>

<p>
这里有必要说明的是，虽然用 <code>inotifywait</code> 能探测出文件具体做了什么改动，但实际上我们根本不需要知道具体的改变是什么。
</p>

<p>
我们只需要知道有所改变了，然后具体改变了什么由 <code>rsync</code> 来自己处理就行了。
</p>
</div>
</div>
<div id="outline-container-org3401029" class="outline-2">
<h2 id="org3401029">改进</h2>
<div class="outline-text-2" id="text-org3401029">
<p>
但是上面这种方法存在一个问题，那就是在 <code>rsync</code> 运行完到调用起 <code>inotifywait</code> 之前其实是会有一个微小的时间间隔的。
在这个时间间隔内若有文件发生变动，则无法检测出来从而同步。
</p>

<p>
通过 <code>man inotifywait</code> 可以看到它其实有一个 <code>-m(--monitor)</code> 选项,这个选项可以让 <code>inotifywait</code> 持续监控而不是检测到时间后自动退出。
通过该选项，我们可以做出如下改进：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/bin/</span><span style="font-weight: bold;">bash</span>

<span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">#</span> -ne 2 ]];<span style="font-weight: bold;">then</span>
    cat&lt;&lt;EOF
<span style="font-weight: bold;">Usage $(</span><span style="font-weight: bold;">basename</span><span style="font-weight: bold;"> $0) source_dir [host:]dest_dir</span>
<span style="font-weight: bold;">EOF</span>
    <span style="font-weight: bold;">exit</span> 0
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;">source_dir</span>=$<span style="font-weight: bold; font-style: italic;">1</span>
<span style="font-weight: bold; font-style: italic;">dest_dir</span>=$<span style="font-weight: bold; font-style: italic;">2</span>
<span style="font-weight: bold; font-style: italic;">temp</span>=$(<span style="font-weight: bold;">mktemp</span>)
<span style="font-weight: bold;">trap</span> <span style="font-style: italic;">"rm ${temp}"</span> exit
inotifywait -r -m -e modify,create,delete ${<span style="font-weight: bold; font-style: italic;">source_dir</span>} &gt;${<span style="font-weight: bold; font-style: italic;">temp</span>} &amp;
<span style="font-weight: bold;">while</span> :
<span style="font-weight: bold;">do</span>
    <span style="font-weight: bold;">if</span> [[ $(<span style="font-weight: bold;">stat</span> -c <span style="font-style: italic;">'%s'</span> ${<span style="font-weight: bold; font-style: italic;">temp</span>}) -eq 0 ]];<span style="font-weight: bold;">then</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33509;&#26377;&#25913;&#21160;&#20986;&#29616;</span>
        sleep 1
        <span style="font-weight: bold;">continue</span>
    <span style="font-weight: bold;">fi</span>

    &gt; ${<span style="font-weight: bold; font-style: italic;">temp</span>}                   <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#20010;&#26102;&#38388;&#28857;&#20043;&#21518;&#30340;&#25913;&#21160;&#37117;&#20250;&#34987;rsync&#21516;&#27493;&#25481;</span>
    rsync -avz ${<span style="font-weight: bold; font-style: italic;">source_dir</span>}/ ${<span style="font-weight: bold; font-style: italic;">dest_dir</span>} --delete
<span style="font-weight: bold;">done</span>
</pre>
</div>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2018-04-04</span>
    <span title="last modification date" class="post-info">2018-05-05</span>
    <span title="tags" class="post-info"><a href="/tags/linux和它的小伙伴">linux和它的小伙伴</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="/media/js/jquery-2.1.3.min.js"></script>
  <script src="/media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="/media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-28cf1161-6021-4541-a002-8eb87d451368">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
