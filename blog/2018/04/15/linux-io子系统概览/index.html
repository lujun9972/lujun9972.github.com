<!DOCTYPE html>
<html lang="en">
<head>
  <title>linux IO子系统概览 - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="linux和它的小伙伴,IO" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/org-src-fontify.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com.git">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
    <img class="avatar" src="https://avatar.csdnimg.cn/6/2/4/1_lujun9972.jpg" />
  </header>
</div>

<div>
<div class="post">
<h1 class="title">linux IO子系统概览</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7c0ec03">IO子系统概况</a>
<ul>
<li><a href="#orge508c6b">写入数据的情形</a></li>
<li><a href="#org57db55c">读取数据的情形</a></li>
</ul>
</li>
<li><a href="#org3170f69">IO调度器</a>
<ul>
<li><a href="#orgff0020b">四种IO调度器的特点</a></li>
<li><a href="#org80a9687">查看/修改调度器</a>
<ul>
<li><a href="#org9c2ebc7">查看调度器</a></li>
<li><a href="#orgd0997f2">修改调度器</a></li>
<li><a href="#orgecdab8f">ionice命令</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org7c0ec03" class="outline-2">
<h2 id="org7c0ec03">IO子系统概况</h2>
<div class="outline-text-2" id="text-org7c0ec03">
<p>
Linux的IO子系统由VFS(Virtual File System,虚拟文件系统)层和块层构成。
其中，VFS层用于将各种不同的文件系统统一起来，形成统一的抽象层。
而块层用于通过设备驱动将数据读取或写入物理磁盘。
</p>

<p>
#+IO子系统的结构
<img src="../../../../../assets/blog/2018/04/15/linux-io子系统概览/IO_System_Struct.jpg" alt="IO_System_Struct.jpg" />
</p>

<p>
我们通常说的“文件系统的块大小”，指的就是块层中的设备驱动程序从物理磁盘读取/写入数据的最小单位。
</p>

<p>
值得一提的是，当分区的大小不为块大小的整数时(比如在512字节扇区的磁盘上，文件系统块大小设置为为4K,而分区不是8的整数倍时),那么最终会有一个块超出分区界限，那么这个超出分区界限的块不会在文件系统中被使用。
</p>
</div>

<div id="outline-container-orge508c6b" class="outline-3">
<h3 id="orge508c6b">写入数据的情形</h3>
<div class="outline-text-3" id="text-orge508c6b">
<p>
当写入数据时，根据上图所示，其步骤为：
</p>

<ol class="org-ol">
<li><p>
当数据被写入文件系统的文件中时，首先会暂时存入磁盘高速缓存中。
</p>

<p>
虽然这一步并未真正将数据写入物理磁盘中，但应用程序依然认为写入动作已经完成。
这些没有写入物理磁盘的数据被成为“脏数据”
</p></li>

<li>当脏数据积累到一定程度,或一定时间后，文件系统会向IO调度发出请求，将脏数据写入物理磁盘中</li>

<li>IO调度器响应请求队列中的请求，调用设备驱动程序将数据写入物理磁盘中。</li>

<li>设备驱动程序将数据从磁盘高速缓存写入到物理磁盘中。</li>
</ol>
</div>
</div>

<div id="outline-container-org57db55c" class="outline-3">
<h3 id="org57db55c">读取数据的情形</h3>
<div class="outline-text-3" id="text-org57db55c">
<p>
当读取数据时，根据上图所示，其步骤为：
</p>

<ol class="org-ol">
<li>若目标数据已经存在于磁盘高速缓存中，那么文件系统直接将这些数据返回进程</li>

<li>若目标数据不再磁盘高速缓存中，那么进程会暂停执行进入等待状态，之后文件系统会向IO调度器发出读取数据的请求</li>

<li>IO调度器相应请求，调用设备驱动程序把数据从物理磁盘读入磁盘高速缓存中</li>

<li>设备驱动程序程序把数据从物理磁盘读入磁盘高速缓存中，然后解除进程等待状态，进入就绪状态，再回到第一步</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org3170f69" class="outline-2">
<h2 id="org3170f69">IO调度器</h2>
<div class="outline-text-2" id="text-org3170f69">

<div class="figure">
<p><img src="../../../../../assets/blog/2018/04/15/linux-io子系统概览/IO_System_Scheduler.jpg" alt="IO_System_Scheduler.jpg" />
</p>
</div>

<p>
当文件系统通过IO调度器将数据写入物理磁盘时，遵循以下步骤：
</p>

<ol class="org-ol">
<li>文件系统将磁盘高速缓存中的数据分配到物理磁盘的连续扇区中，每块连续的扇区都会在内核中构成一个bio对象，再把这些bio对象传递给IO调度器</li>

<li><p>
IO调度器接收到bio对象后将多个bio对象合并成一个请求对象，加入到请求子队列中
</p>

<p>
bio对象的合并方法根据各IO调度器不同而不同.
一般来说，如果bio对象指定的连续扇区和已经存在的某个请求队列中的连续扇区一致，那么就会将两个对象合并，否则就创建一个只包含该bio对象的新请求对象。
</p></li>

<li>子队列中的请求对象增加到一定程度后，将请求对象转移到调度队列中进行实际的写入/读取操作</li>

<li>设备驱动程序根据请求对象在其所指定的区域进行读取或写入。</li>
</ol>
</div>

<div id="outline-container-orgff0020b" class="outline-3">
<h3 id="orgff0020b">四种IO调度器的特点</h3>
<div class="outline-text-3" id="text-orgff0020b">
<p>
Linux主要使用以下四种IO调度器，它们的特征如下：
</p>

<ol class="org-ol">
<li><p>
noop(no optimization)调度器
</p>

<p>
该调度器只有一个子队列，按照bio对象被接受时的顺序处理请求
</p></li>

<li><p>
cfg(complete fair queuing)调度器
</p>

<p>
bio对象被接收后，将发送该bio对象的进程ID通过散列函数，映射到64个子队列中的某个队列中。这样每个进程的IO请求都会被公平执行。
</p></li>

<li><p>
deadline调度器
</p>

<p>
用不同的队列来维护读请求和写请求。
</p>

<p>
它将接收到的bio对象，根据其对应的扇区位置，以减少磁盘头移动为原则，插入到请求队列中最合适的位置。
</p>

<p>
但是若有新的bio对象不断插入到队列前面，那么队列的请求可能一直得不到处理，因此超过一段时间没有处理的请求会被优先处理。
</p></li>

<li><p>
anticipatory调度器
</p>

<p>
在deadline调度器的基础上，会尝试预测下一个bio对象。
</p></li>
</ol>
</div>
</div>

<div id="outline-container-org80a9687" class="outline-3">
<h3 id="org80a9687">查看/修改调度器</h3>
<div class="outline-text-3" id="text-org80a9687">
</div>
<div id="outline-container-org9c2ebc7" class="outline-4">
<h4 id="org9c2ebc7">查看调度器</h4>
<div class="outline-text-4" id="text-org9c2ebc7">
<p>
我们可以通过 <code>/sys/block/&lt;磁盘名&gt;/queue/scheduler</code> 来查看或设置IO调度器的名称。
</p>

<div class="org-src-container">
<pre class="src src-shell">cat /sys/block/sda/queue/scheduler
</pre>
</div>

<p>
结果为:
</p>
<div class="org-src-container">
<pre class="src src-org">noop deadline [cfq] 
</pre>
</div>

<p>
这个意思是，本机支持的调度器有 <code>noop</code>, <code>deadline</code>, 和 <code>cfq</code>. 其中 <code>sda</code> 中采取的调度器为 <code>cfg(被[]括起来)</code> 
</p>

<p>
此外我们也能通过 <code>lsblk -t</code> 命令来查看调度器
</p>
<div class="org-src-container">
<pre class="src src-shell">lsblk -t
</pre>
</div>

<p>
结果为:
</p>
<div class="org-src-container">
<pre class="src src-org">NAME   ALIGNMENT MIN-IO OPT-IO PHY-SEC LOG-SEC ROTA SCHED RQ-SIZE  RA WSAME
sda            0    512      0     512     512    0 cfq       128 128    0B
&#9500;&#9472;sda1         0    512      0     512     512    0 cfq       128 128    0B
&#9500;&#9472;sda2         0    512      0     512     512    0 cfq       128 128    0B
&#9492;&#9472;sda3         0    512      0     512     512    0 cfq       128 128    0B
sr0            0    512      0     512     512    1 cfq       128 128    0B
</pre>
</div>

<p>
其中 <code>SCHED</code> 这一栏中现实的就是当前调度器的名称。
</p>
</div>
</div>
<div id="outline-container-orgd0997f2" class="outline-4">
<h4 id="orgd0997f2">修改调度器</h4>
<div class="outline-text-4" id="text-orgd0997f2">
<p>
通过 echo 命令往 <code>/sys/block/&lt;磁盘名&gt;/queue/scheduler</code> 中写入新的IO调度器名称就能够临时修改当前使用的调度器。
</p>

<div class="org-src-container">
<pre class="src src-shell">sudo bash -c <span class="org-string">'echo "deadline" &gt; /sys/block/sda/queue/scheduler'</span>
cat /sys/block/sda/queue/scheduler
</pre>
</div>

<p>
结果为:
</p>
<div class="org-src-container">
<pre class="src src-org">noop [deadline] cfq 
</pre>
</div>

<p>
可以看到，调度器被修改为 <code>deadline</code> 了，我们再用 <code>lsblk</code> 验证一下:
</p>
<div class="org-src-container">
<pre class="src src-shell">lsblk -t
</pre>
</div>

<p>
结果为:
</p>
<div class="org-src-container">
<pre class="src src-org">NAME   ALIGNMENT MIN-IO OPT-IO PHY-SEC LOG-SEC ROTA SCHED    RQ-SIZE  RA WSAME
sda            0    512      0     512     512    0 deadline     128 128    0B
&#9500;&#9472;sda1         0    512      0     512     512    0 deadline     128 128    0B
&#9500;&#9472;sda2         0    512      0     512     512    0 deadline     128 128    0B
&#9492;&#9472;sda3         0    512      0     512     512    0 deadline     128 128    0B
sr0            0    512      0     512     512    1 cfq          128 128    0B
</pre>
</div>
</div>
</div>
<div id="outline-container-orgecdab8f" class="outline-4">
<h4 id="orgecdab8f">ionice命令</h4>
<div class="outline-text-4" id="text-orgecdab8f">
<p>
通过ionice命令可以对cfq调度器中的每个进程设置优先级：
</p>

<dl class="org-dl">
<dt>Real time</dt><dd>这个级别进程的IO会最为优先被处理</dd>
<dt>Idle</dt><dd>这个级别进程的IO和Real time正相反，只有在系统所有进程IO都被处理完后才会处理它</dd>
<dt>Best effort</dt><dd>默认的优先级，给予cfq调度器的正常逻辑，公平地进行IO调度</dd>
</dl>

<p>
此外，对于Real time和Best effort的进程，还能指定数值0～7的优先级参数，数值越小，优先级越高。
</p>

<p>
关于ionice的用法，可以查看帮助
</p>
<div class="org-src-container">
<pre class="src src-shell">ionice --help
</pre>
</div>

<p>
结果为:
</p>
<div class="org-src-container">
<pre class="src src-org">
&#29992;&#27861;&#65306;
 ionice [&#36873;&#39033;] -p &lt;pid&gt;...
 ionice [&#36873;&#39033;] -P &lt;pgid&gt;...
 ionice [&#36873;&#39033;] -u &lt;uid&gt;...
 ionice [&#36873;&#39033;] &lt;&#21629;&#20196;&gt;

&#35774;&#32622;&#25110;&#26356;&#25913;&#36827;&#31243;&#30340; IO &#35843;&#24230;&#31867;&#21035;&#21644;&#20248;&#20808;&#32423;&#12290;

&#36873;&#39033;&#65306;
 -c, --class &lt;&#31867;&#21035;&gt;    &#35843;&#24230;&#31867;&#21035;&#30340;&#21517;&#31216;&#25110;&#25968;&#20540;
                          0: &#26080;, 1: &#23454;&#26102;, 2: &#23613;&#21147;, 3: &#31354;&#38386;
 -n, --classdata &lt;&#25968;&#23383;&gt; &#25351;&#23450;&#35843;&#24230;&#31867;&#21035;&#30340;&#20248;&#20808;&#32423;(0..7)&#65292;&#21482;&#38024;&#23545;
                          &#8220;&#23454;&#26102;&#8221;&#21644;&#8220;&#23613;&#21147;&#8221;&#31867;&#21035;
 -p, --pid &lt;pid&gt;...     &#23545;&#36825;&#20123;&#24050;&#36816;&#34892;&#30340;&#36827;&#31243;&#25805;&#20316;
 -P, --pgid &lt;pgrp&gt;...   &#23545;&#36825;&#20123;&#32452;&#20013;&#24050;&#36816;&#34892;&#30340;&#36827;&#31243;&#25805;&#20316;
 -t, --ignore           &#24573;&#30053;&#22833;&#36133;
 -u, --uid &lt;uid&gt;...     &#23545;&#23646;&#20110;&#36825;&#20123;&#29992;&#25143;&#30340;&#24050;&#36816;&#34892;&#36827;&#31243;&#25805;&#20316;

 -h, --help             display this help
 -V, --version          display version

&#26356;&#22810;&#20449;&#24687;&#35831;&#21442;&#38405; ionice(1)&#12290;
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2018-04-15</span>
    <span title="last modification date" class="post-info">2018-04-15</span>
    <span title="tags" class="post-info"><a href="../../../../../tags/linux和它的小伙伴">linux和它的小伙伴</a> : <a href="../../../../../tags/io">IO</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-f8772794-b08b-46a0-b59c-8346357cb3da">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="https://licensebuttons.net/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
