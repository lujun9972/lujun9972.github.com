<!DOCTYPE html>
<html lang="en">
<head>
  <title>Vagrant使用指南 - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="linux和它的小伙伴" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/org-src-fontify.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com.git">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Vagrant使用指南</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org17a5eeb">Vagrant的依赖</a></li>
<li><a href="#org473e29e">创建第一台虚拟机</a>
<ul>
<li><a href="#orgd52376f">创建VagrantFile</a></li>
<li><a href="#org782f962">配置VagrangFile</a></li>
<li><a href="#org4a2475d">Vagrant常用命令</a>
<ul>
<li><a href="#org4b715b8">启动虚拟机</a>
<ul>
<li><a href="#org167f74e">指定provider</a></li>
</ul>
</li>
<li><a href="#orgb17b7cf">查看虚拟机状态</a></li>
<li><a href="#org55f1e52">挂起虚拟机</a></li>
<li><a href="#org9d7a04d">重启虚拟机</a></li>
<li><a href="#orgf332be9">关闭虚拟机</a></li>
<li><a href="#orge9436db">删除虚拟机</a></li>
<li><a href="#orgdd4955c">ssh登陆虚拟机</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org7478ccc">Vagrant provision</a></li>
<li><a href="#org3d58a9a">管理box</a>
<ul>
<li><a href="#org9eb749f">添加box</a></li>
<li><a href="#org9acb151">配置box</a></li>
<li><a href="#org17c98e3">升级box</a></li>
<li><a href="#orgf56d7db">删除box</a></li>
</ul>
</li>
<li><a href="#org026561e">关于同步目录(Synced Folders)</a></li>
<li><a href="#orgaba8dbf">网络配置</a>
<ul>
<li><a href="#org418842e">端口转发</a></li>
<li><a href="#org3113bc1">私有网络</a>
<ul>
<li><a href="#org5d09f63">配置IP</a></li>
</ul>
</li>
<li><a href="#orgf6e514c">公有网络</a>
<ul>
<li><a href="#orgce97f6a">DHCP</a></li>
<li><a href="#org8d292d0">设置静态IP</a></li>
<li><a href="#orgbac34f0">指定桥接的网卡</a></li>
</ul>
</li>
<li><a href="#orgca292cb">其他网络设置</a></li>
</ul>
</li>
<li><a href="#org5512672">插件</a>
<ul>
<li><a href="#org9274909">安装插件</a></li>
<li><a href="#orgb03a089">更新插件</a></li>
<li><a href="#org2bba581">列出已安装的插件</a></li>
<li><a href="#org09fe790">卸载插件</a></li>
</ul>
</li>
<li><a href="#org01a0438">设置代理服务器</a>
<ul>
<li><a href="#org4310711">为 vagrant 命令设置代理</a></li>
<li><a href="#orgf8fa6cd">为虚拟机设置代理</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
Vagrant是一款虚拟机管理工具，通过它可以以代码的方式快速地重建不同虚拟环境的虚拟机。
</p>

<p>
本文以virtualbox作为虚拟机引擎来演示一下Vagrant的使用方法。
</p>

<div id="outline-container-org17a5eeb" class="outline-2">
<h2 id="org17a5eeb">Vagrant的依赖</h2>
<div class="outline-text-2" id="text-org17a5eeb">
<p>
Vagrant本身并不具有虚拟化的能力，因此它额外依赖于一套虚拟机程序,我们这里以VirtualBox作为例子，当然除了VirtualBox之外，Vagrant也支持Hyper-V和VMWare，甚至支持Docker作为虚拟机(虚拟环境)引擎。
我们一般把这些虚拟机引擎称之为provider.
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo pacman -S virtualbox vagrant --noconfirm
</pre>
</div>

<p>
当然，要使虚拟机能够运行起来，除了有虚拟机引擎创建虚拟机之外，还需要有被虚拟的操作系统镜像，这些镜像我们称之为box。
box可以由自己创建或者直接使用他人分享的。
Vagrant有两类box，一类是“Pre-Build”，表示所有东西都已经安装在box中了，直接使用就好。
还有一类是“Base OS”，即只安装了一个基础的操作系统，其他所有的软件都需要自己来安装。
</p>
</div>
</div>


<div id="outline-container-org473e29e" class="outline-2">
<h2 id="org473e29e">创建第一台虚拟机</h2>
<div class="outline-text-2" id="text-org473e29e">
<p>
Vagrant通过一个名为 VagrangtFile 的配置文件来创建虚拟机,该文件中包含了如下信息：
</p>
<ul class="org-ul">
<li>使用哪个box作为虚拟镜像</li>
<li>使用哪个虚拟引擎进行虚拟化(virtualbox,vmware,hyper-v,docker等)</li>
<li>虚拟机的网络配置信息</li>
<li>其他虚拟机初始化脚本(shell,puppet,chef等)</li>
</ul>
</div>

<div id="outline-container-orgd52376f" class="outline-3">
<h3 id="orgd52376f">创建VagrantFile</h3>
<div class="outline-text-3" id="text-orgd52376f">
<ol class="org-ol">
<li><p>
我们需要创建一个目录，用于存放VagrantFile
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir ~/rhel7
<span class="org-builtin">cd</span> ~/rhel7
</pre>
</div></li>

<li><p>
运行 <code>vagrant init</code> 初始化Vagrant box。
</p>

<div class="org-src-container">
<pre class="src src-shell">vagrant init <span class="org-string">"generic/rhel7"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">A `Vagrantfile` has been placed in this directory. You are now
ready to `vagrant up` your first virtual environment! Please read
the comments in the Vagrantfile as well as documentation on
`vagrantup.com` for more information on using Vagrant.
</pre>
</div>

<p>
该命令会初始化所在目录用于存放Vagrant相关信息(.vagrant目录)，并在其中中创建一个 <code>VagrantFile</code> 文件，并且在其中指明使用的box为 <code>centos/7</code>
</p>

<p>
Vagrant本身有一个云端预存了大量的box，你可以去 <a href="https://app.vagrantup.com/boxes/search">Vagrant Cloud</a> 搜索其他想要的box
</p></li>
</ol>
</div>
</div>

<div id="outline-container-org782f962" class="outline-3">
<h3 id="org782f962">配置VagrangFile</h3>
<div class="outline-text-3" id="text-org782f962">
<p>
打开VagrantFile你会发现其中包含了关于虚拟机的大量设置，每个配置项还很贴心的包含了注释说明
</p>

<p>
其中比较常用的配置项有下面几个：
</p>

<ol class="org-ol">
<li><p>
<code>config.vm.box</code> 定义了使用哪个box启动虚拟机。若指定的box本机找不到，则会从 <a href="https://app.vagrantup.com/boxes/search">Vagrant Cloud</a> 中搜索并下载指定的box
</p>

<div class="org-src-container">
<pre class="src src-ruby">config.vm.box = <span class="org-string">"generic/rhel7"</span>
</pre>
</div></li>

<li><p>
<code>config.vm.hostname</code> 定义了虚拟机的主机名
</p>

<div class="org-src-container">
<pre class="src src-ruby">config.vm.hostname = <span class="org-string">"rhel7"</span>
</pre>
</div></li>

<li><p>
<code>config.vm.boot_timeout</code> 指明了系统启动的超时时间，若这段时间内Vagrang还无法连接上虚拟机，则认为虚拟机启动过程中发生了错误
</p>

<div class="org-src-container">
<pre class="src src-ruby">config.vm.boot_timeout = 600
</pre>
</div></li>

<li><p>
<code>config.vm.communicator</code> 指明了Vagrant与虚拟机通讯的方式，可以选择"ssh"或者"winrm",一般box为linux类操作系统则使用"ssh"，为windows操作系统则选择"winrm"
</p>

<div class="org-src-container">
<pre class="src src-ruby">config.vm.communicator = <span class="org-string">"ssh"</span>
</pre>
</div></li>

<li><p>
<code>config.vm.provider</code> 用于对虚拟机引擎进行配置
</p>

<div class="org-src-container">
<pre class="src src-ruby">config.vm.provider <span class="org-string">"virtualbox"</span> <span class="org-keyword">do</span> |vb|
  <span class="org-comment-delimiter"># </span><span class="org-comment">Display the VirtualBox GUI when booting the machine</span>
  vb.gui = <span class="org-constant">true</span>

  <span class="org-comment-delimiter"># </span><span class="org-comment">Customize the amount of memory on the VM:</span>
  vb.memory = <span class="org-string">"1024"</span>
  vb.cpus = 2
  vb.customize [<span class="org-string">"modifyvm"</span>, <span class="org-constant">:id</span>, <span class="org-string">"--vram"</span>, <span class="org-string">"128"</span>]
  vb.customize [<span class="org-string">"modifyvm"</span>, <span class="org-constant">:id</span>, <span class="org-string">"--clipboard"</span>, <span class="org-string">"bidirectional"</span>]
  vb.name = <span class="org-string">"RHEL7"</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
比如这段配置指明了虚拟机引擎为 "virtualbox"，启动虚拟机时会现实VirtualBox GUI。同时它还定义了该虚拟机拥有:
</p>

<ul class="org-ul">
<li>1G内存</li>

<li>2个CPU</li>

<li>128M显存</li>

<li>设置虚拟机与主机双向共享粘帖板</li>

<li>虚拟机的名称为RHEL7</li>
</ul></li>
</ol>
</div>
</div>


<div id="outline-container-org4a2475d" class="outline-3">
<h3 id="org4a2475d">Vagrant常用命令</h3>
<div class="outline-text-3" id="text-org4a2475d">
</div>
<div id="outline-container-org4b715b8" class="outline-4">
<h4 id="org4b715b8">启动虚拟机</h4>
<div class="outline-text-4" id="text-org4b715b8">
<p>
配置好 <code>VagrantFile</code> 后，我们只需要在当前目录下运行 <code>vagrant up</code> 就能启动虚拟机了。
</p>
<div class="org-src-container">
<pre class="src src-shell">vagrant up
</pre>
</div>

<p>
若虚拟机尚未创建，则 <code>vagrant up</code> 会自动创建新虚拟机；同时若创建虚拟机时Vagrant发现指定的box不存在，则还会自动从 Vagrant Cloud 上搜索并下载指定的box
</p>

<p>
值得一提的时，由于在当前目录中存储了相关虚拟机的信息，因此在执行Vagrant命令时都无需指明作用于哪个虚拟机之上。
</p>
</div>
<div id="outline-container-org167f74e" class="outline-5">
<h5 id="org167f74e">指定provider</h5>
<div class="outline-text-5" id="text-org167f74e">
<p>
前面提到过Vagrant支持多种虚拟引擎来进行虚拟化，我们可以通过 <code>--provider</code> 参数来指定虚拟引擎，默认为 <code>virtualbox</code>
</p>

<p>
比如 <code>generic/arch</code> box有5种provider提供，分别时virtualbox,vmware_desktop,hyperv,libvirt,parallels. 
那么我们可以通过下面命令指定provider为libvirt
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">&#23433;&#35013;&#24517;&#35201;&#30340;&#20381;&#36182;</span>
sudo pacman -Syu ebtables dnsmasq
<span class="org-comment-delimiter"># </span><span class="org-comment">vagrant&#40664;&#35748;&#21482;&#25903;&#25345;VirtualBox&#65292;Hyper-V&#21644;Docker provider&#65292;&#38656;&#35201;&#23433;&#35013;&#25554;&#20214;&#26469;&#25903;&#25345;libvirt provider</span>
vagrant plugin install vagrant-libvirt
<span class="org-comment-delimiter"># </span><span class="org-comment">&#25351;&#23450;&#20351;&#29992;&#30340;box</span>
vagrant init generic/arch
<span class="org-comment-delimiter"># </span><span class="org-comment">&#25351;&#23450;&#21551;&#21160;&#30340;provider&#20026;libvirt</span>
vagrant up --provider libvirt
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb17b7cf" class="outline-4">
<h4 id="orgb17b7cf">查看虚拟机状态</h4>
<div class="outline-text-4" id="text-orgb17b7cf">
<div class="org-src-container">
<pre class="src src-shell">vagrant status
</pre>
</div>
</div>
</div>

<div id="outline-container-org55f1e52" class="outline-4">
<h4 id="org55f1e52">挂起虚拟机</h4>
<div class="outline-text-4" id="text-org55f1e52">
<div class="org-src-container">
<pre class="src src-shell">vagrant suspend
</pre>
</div>
</div>
</div>

<div id="outline-container-org9d7a04d" class="outline-4">
<h4 id="org9d7a04d">重启虚拟机</h4>
<div class="outline-text-4" id="text-org9d7a04d">
<div class="org-src-container">
<pre class="src src-shell">vagrant reload
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf332be9" class="outline-4">
<h4 id="orgf332be9">关闭虚拟机</h4>
<div class="outline-text-4" id="text-orgf332be9">
<div class="org-src-container">
<pre class="src src-shell">vagrant shutdown
</pre>
</div>
</div>
</div>

<div id="outline-container-orge9436db" class="outline-4">
<h4 id="orge9436db">删除虚拟机</h4>
<div class="outline-text-4" id="text-orge9436db">
<div class="org-src-container">
<pre class="src src-shell">vagrant destory
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdd4955c" class="outline-4">
<h4 id="orgdd4955c">ssh登陆虚拟机</h4>
<div class="outline-text-4" id="text-orgdd4955c">
<div class="org-src-container">
<pre class="src src-shell">vagrant ssh
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org7478ccc" class="outline-2">
<h2 id="org7478ccc">Vagrant provision</h2>
<div class="outline-text-2" id="text-org7478ccc">
<p>
Vagrant provision能够让你为虚拟机自动安装软件并修改配置。
</p>

<p>
Vagrant会在三种情况下触发provision:
</p>
<ol class="org-ol">
<li>第一次使用vagrant up创建虚拟环境,且没有指定 <code>--no-provision</code> 时</li>
<li>运行命令 <code>vagrant provision</code> 时</li>
<li>运行命令 <code>vagrant reload --provision</code> 时</li>
</ol>

<p>
Vagrant支持两种provision provider:
</p>
<dl class="org-dl">
<dt>shell provider</dt><dd><p>
调用shell或powershell脚本，脚本中应该不包括手工交互内容
</p>

<p>
一个shell provision大概长得像这样
</p>
<div class="org-src-container">
<pre class="src src-ruby">config.vm.provision <span class="org-string">"shell"</span>, <span class="org-constant">inline:</span> <span class="org-string">&lt;&lt;-SHELL</span>
<span class="org-string">  apt-get update</span>
<span class="org-string">  apt-get install -y apache2</span>
<span class="org-string">SHELL</span>
</pre>
</div>

<p>
其中 <code>"shell"</code> 表示使用的是shell provider, <code>inline:</code> 表示要执行的内容嵌入在后面， <code>&lt;&lt;-SHELL</code> 表示执行脚本到 <code>SHELL</code> 这一行结束。
</p>

<p>
除了 <code>inline:</code> ,还可以是 <code>path:</code> 表示要执行的内容存放在后面指定的文件中。
</p>
<div class="org-src-container">
<pre class="src src-ruby">config.vm.provision <span class="org-constant">:shell</span>, <span class="org-constant">path:</span> <span class="org-string">"shell/main.cmd"</span>
</pre>
</div></dd>

<dt>file provider</dt><dd><p>
将主机上的文件拷贝到虚拟机中但并不执行脚本的内容。
</p>

<p>
一个shell provision大概长得像这样
</p>
<div class="org-src-container">
<pre class="src src-ruby">config.vm.provision <span class="org-string">"file"</span>,
                    <span class="org-constant">source:</span> <span class="org-string">"shell/RunBoxStarterGist.bat"</span>,
                    <span class="org-constant">destination:</span> <span class="org-string">"desktop\\RunBoxStarterGist.bat"</span>
</pre>
</div>

<p>
很明显, <code>source:</code> 和 <code>destination:</code> 分别指明了源文件路径和目的文件路径
</p></dd>
</dl>

<p>
此外，值得说明的是，一个VagrantFile中支持多个 <code>config.vm.provision</code> 模块，Vagrant会从上到下一次执行。
</p>
</div>
</div>
<div id="outline-container-org3d58a9a" class="outline-2">
<h2 id="org3d58a9a">管理box</h2>
<div class="outline-text-2" id="text-org3d58a9a">
</div>
<div id="outline-container-org9eb749f" class="outline-3">
<h3 id="org9eb749f">添加box</h3>
<div class="outline-text-3" id="text-org9eb749f">
<p>
box是用来创建虚拟机的基础镜像。当使用 <code>vagrant up</code> 启动虚拟机时，Vagrant会自动下载box，但你也可以使用下面命令手工添加一个box
</p>
<div class="org-src-container">
<pre class="src src-shell">vagrant box add ${<span class="org-variable-name">name_or_url_or_path</span>} [--name ${<span class="org-variable-name">name</span>}] [--box-version ${<span class="org-variable-name">version</span>}] [--provider ${<span class="org-variable-name">provider</span>}]
</pre>
</div>

<p>
其中 ${name_or_url_or_path} 可以是box名称，或者指向box文件的URL或路径，
当 ${name_or_url_or_path} 是box名称时，Vagrant会在 <a href="https://app.vagrantup.com/boxes/search">Vagrant Cloud</a> 中搜索指定名称的box，
当 ${name_or_url_or_path} 是指向box文件的URL或路径时，还必须跟 <code>--name ${name}</code> 连用以指定box名称。
</p>

<p>
同一个名字的box可能包含多个版本，这种情况下可以通过 <code>--box-version ${version}</code> 指定版本，
类似的，也可以通过 <code>--provider ${provider}</code> 来下载指定provider的box
</p>
</div>
</div>
<div id="outline-container-org9acb151" class="outline-3">
<h3 id="org9acb151">配置box</h3>
<div class="outline-text-3" id="text-org9acb151">
<p>
添加box之后，我们可以在配置文件中使用它，关于box的配置是以 <code>config.vm.box</code> 开头的
</p>

<p>
像这样：
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">Vagrant</span>.configure(<span class="org-string">"2"</span>) <span class="org-keyword">do</span> |config|
  config.vm.box = <span class="org-string">"hashicorp/precise64"</span>
  config.vm.box_version = <span class="org-string">"1.1.0"</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
或者是这样：
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">Vagrant</span>.configure(<span class="org-string">"2"</span>) <span class="org-keyword">do</span> |config|
  config.vm.box = <span class="org-string">"hashicorp/precise64"</span>
  config.vm.box_url = <span class="org-string">"http://files.vagrantup.com/precise64.box"</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
注意， <code>config.vm.box</code> 并没有关于 <code>provider</code> 的配置，因为它是由 <code>config.vm.provider</code> 决定的
</p>
</div>
</div>
<div id="outline-container-org17c98e3" class="outline-3">
<h3 id="org17c98e3">升级box</h3>
<div class="outline-text-3" id="text-org17c98e3">
<p>
随着时间的推移，box可能也会发生改变，这是可以使用 <code>vagrant box update</code> 命令来对box进行升级。
</p>
<div class="org-src-container">
<pre class="src src-shell">vagrant box update [--box ${<span class="org-variable-name">name</span>}] [--provider ${<span class="org-variable-name">provider</span>}]
</pre>
</div>

<p>
默认情况下，vagrant会对当前目录所指定的box进行升级，但通过 <code>--box ${name}</code> 也可以指定升级特定的box, 通过 <code>--provider ${provider}</code> 则表示只更新特定 provider 的box
</p>
</div>
</div>
<div id="outline-container-orgf56d7db" class="outline-3">
<h3 id="orgf56d7db">删除box</h3>
<div class="outline-text-3" id="text-orgf56d7db">
<p>
当不再使用某个box来创建虚拟机了，则可以将该box删除掉，以释放空间。
</p>
<div class="org-src-container">
<pre class="src src-shell">vagrant box remove ${<span class="org-variable-name">name</span>} [--provider ${<span class="org-variable-name">provider</span>}] [--box-version ${<span class="org-variable-name">version</span>}]
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org026561e" class="outline-2">
<h2 id="org026561e">关于同步目录(Synced Folders)</h2>
<div class="outline-text-2" id="text-org026561e">
<p>
Synced Folder可以用来实现宿主机和虚拟机之间共享文件，
</p>

<p>
默认情况下Vagrant会将你的项目目录(即包含Vagrangfile的那个目录)挂载到虚拟机的 <code>/vargrant</code> 目录。
</p>

<p>
可以在Vagrantfile中通过 <code>config.vm.synced_folder</code> 来添加Synced Folder
</p>
<div class="org-src-container">
<pre class="src src-ruby">config.vm.synced_folder ${&#20027;&#26426;&#30446;&#24405;}, ${&#34394;&#25311;&#26426;&#30446;&#24405;}
</pre>
</div>
<p>
其中主机目录若为相对路径，则是以Vagrant项目目录为基准
</p>
</div>
</div>
<div id="outline-container-orgaba8dbf" class="outline-2">
<h2 id="orgaba8dbf">网络配置</h2>
<div class="outline-text-2" id="text-orgaba8dbf">
<p>
Vagrnat中的所有关于网络的配置都是通过 <code>config.vm.network</code> 配置方法来进行的。
这个方法的第一个参数是一个字符串标识符，用来指明配置网络哪个方面的参数，比如 <code>"forwarded_port"</code> 就表示用来指明配置的是网络转发。
这个方法的其他参数则根据第一个参数的不同而不同。
</p>

<p>
在一个VagrantFile中，可以通过多次调用 <code>config.vm.network</code> 方法来多次配置网络参数。
</p>
</div>

<div id="outline-container-org418842e" class="outline-3">
<h3 id="org418842e">端口转发</h3>
<div class="outline-text-3" id="text-org418842e">
<p>
Vagrant的端口转发功能能够让你把发送到主机端口的数据包转发到虚拟机中去，从而实现暴露虚拟机服务的功能。
</p>

<p>
端口转发的标识符为 <code>"forwarded_port"</code>, 它有两个必须接受的参数 <code>host</code> 和 <code>guest</code>.
即发送到主机 <code>host</code> 端口上的数据包会被转发到 虚拟机的 <code>guest</code> 端口上。
</p>

<p>
比如
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">Vagrant</span>.configure(<span class="org-string">"2"</span>) <span class="org-keyword">do</span> |config|
  config.vm.network <span class="org-string">"forwarded_port"</span>, <span class="org-constant">guest:</span> 80, <span class="org-constant">host:</span> 8080
<span class="org-keyword">end</span>
</pre>
</div>
<p>
表示访问主机8080端口的数据包其实会被转发到虚拟机的80端口上去。
</p>

<p>
除了 <code>host</code> 和 <code>guest</code> 之外，其他常见的参数还包括:
</p>

<dl class="org-dl">
<dt>guest_ip</dt><dd>指定转发到虚拟机的哪个IP上，默认会转发到虚拟机的每个IP接口上</dd>

<dt>host_ip</dt><dd>指定只有访问主机哪个IP上的端口才进行转发，默认也是主机的每个IP</dd>

<dt>protocol</dt><dd>指定转发的协议是 "tcp" 还是 "udp",默认是 "tcp"</dd>
</dl>
</div>
</div>

<div id="outline-container-org3113bc1" class="outline-3">
<h3 id="org3113bc1">私有网络</h3>
<div class="outline-text-3" id="text-org3113bc1">
<p>
虚拟机与虚拟机之间、虚拟机与主机之间可以组成一个私有网络，这个网络只允许网络内的虚拟机或本地主机访问，而不允许主机外的机器进行访问。
</p>

<p>
私有网络的标识符为 <code>"private_network"</code>
</p>
</div>

<div id="outline-container-org5d09f63" class="outline-4">
<h4 id="org5d09f63">配置IP</h4>
<div class="outline-text-4" id="text-org5d09f63">
<p>
配置IP有两种方式，一种是DHCP，一种是配置静态IP。最方便的方法莫过于直接通过DHCP动态分配IP了:
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">Vagrant</span>.configure(<span class="org-string">"2"</span>) <span class="org-keyword">do</span> |config|
  config.vm.network <span class="org-string">"private_network"</span>, <span class="org-constant">type:</span> <span class="org-string">"dhcp"</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
配置静态IP其实也挺简单的:
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">Vagrant</span>.configure(<span class="org-string">"2"</span>) <span class="org-keyword">do</span> |config|
  config.vm.network <span class="org-string">"private_network"</span>, <span class="org-constant">ip:</span> <span class="org-string">"192.168.50.4"</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
同时，静态IP还支持IPV6
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">Vagrant</span>.configure(<span class="org-string">"2"</span>) <span class="org-keyword">do</span> |config|
  config.vm.network <span class="org-string">"private_network"</span>, <span class="org-constant">ip:</span> <span class="org-string">"fde4:8dba:82e1::c4"</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgf6e514c" class="outline-3">
<h3 id="orgf6e514c">公有网络</h3>
<div class="outline-text-3" id="text-orgf6e514c">
<p>
Vagrant也支持创建共有网络，主机外的机器允许访问共有网络。
公有网络的意义根据虚拟机引擎的不同有所不同，一般来说它意味着 "桥接网卡".
</p>

<p>
私有网络的标识符为 <code>"public_network"</code>
</p>
</div>

<div id="outline-container-orgce97f6a" class="outline-4">
<h4 id="orgce97f6a">DHCP</h4>
<div class="outline-text-4" id="text-orgce97f6a">
<p>
若公网上启用了DHCP，则共有网络无需任何配置
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">Vagrant</span>.configure(<span class="org-string">"2"</span>) <span class="org-keyword">do</span> |config|
  config.vm.network <span class="org-string">"public_network"</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8d292d0" class="outline-4">
<h4 id="org8d292d0">设置静态IP</h4>
<div class="outline-text-4" id="text-org8d292d0">
<p>
与私有网络类似，你可以通过 <code>ip</code> 参数来设置静态IP
</p>

<div class="org-src-container">
<pre class="src src-ruby">config.vm.network <span class="org-string">"public_network"</span>, <span class="org-constant">ip:</span> <span class="org-string">"192.168.0.17"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbac34f0" class="outline-4">
<h4 id="orgbac34f0">指定桥接的网卡</h4>
<div class="outline-text-4" id="text-orgbac34f0">
<p>
可以通过 <code>bridge</code> 参数来指定桥接的网卡
</p>
<div class="org-src-container">
<pre class="src src-ruby">config.vm.network <span class="org-string">"public_network"</span>, <span class="org-constant">bridge:</span> <span class="org-string">"en1: Wi-Fi (AirPort)"</span>
</pre>
</div>

<p>
有些provider甚至支持桥接多个网卡
</p>
<div class="org-src-container">
<pre class="src src-ruby">config.vm.network <span class="org-string">"public_network"</span>, <span class="org-constant">bridge:</span> [
  <span class="org-string">"en1: Wi-Fi (AirPort)"</span>,
  <span class="org-string">"en6: Broadcom NetXtreme Gigabit Ethernet Controller"</span>,
]
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgca292cb" class="outline-3">
<h3 id="orgca292cb">其他网络设置</h3>
<div class="outline-text-3" id="text-orgca292cb">
<p>
我们实际上可以通过 provision 的能力来让虚拟机每次启动自动设置网络
</p>
<div class="org-src-container">
<pre class="src src-ruby">config.vm.provision <span class="org-string">"shell"</span>,
    <span class="org-constant">run:</span> <span class="org-string">"always"</span>,
    <span class="org-constant">inline:</span> <span class="org-string">"ifconfig eth1 192.168.0.17 netmask 255.255.255.0 up"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">default router</span>
config.vm.provision <span class="org-string">"shell"</span>,
    <span class="org-constant">run:</span> <span class="org-string">"always"</span>,
    <span class="org-constant">inline:</span> <span class="org-string">"route add default gw 192.168.0.1"</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5512672" class="outline-2">
<h2 id="org5512672">插件</h2>
<div class="outline-text-2" id="text-org5512672">
<p>
通过Vagrant插件可以扩展vagrant的功能或者更改vagrant的某些行为，事实上，某些Vagrant的核心功能都是以插件的方式来实现的。
</p>
</div>

<div id="outline-container-org9274909" class="outline-3">
<h3 id="org9274909">安装插件</h3>
<div class="outline-text-3" id="text-org9274909">
<p>
通过 <code>vagrant plugin install</code> 命令可以安装插件。一个插件其实就是ruby的gem包。
</p>

<p>
安装插件有两种方式：
</p>

<p>
一种是从已知的gem源搜索并安装插件
</p>
<div class="org-src-container">
<pre class="src src-shell">vagrant plugin install &#25554;&#20214;&#21517;&#31216;
</pre>
</div>
<p>
其中 <code>插件名称</code> 一般遵循 <code>vagrant-xxxx</code> 的命名规则
</p>

<p>
还有一种是安装下载到本地的插件
</p>
<div class="org-src-container">
<pre class="src src-shell">vagrant plugin install /path/to/plugin.gem
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb03a089" class="outline-3">
<h3 id="orgb03a089">更新插件</h3>
<div class="outline-text-3" id="text-orgb03a089">
<p>
运行 <code>vagrant plugin update</code> 会更新所有已安装的插件到最新版。
</p>

<p>
你也可以通过 <code>vagrant plugin update 插件名称</code> 来指定更新某个插件
</p>
</div>
</div>

<div id="outline-container-org2bba581" class="outline-3">
<h3 id="org2bba581">列出已安装的插件</h3>
<div class="outline-text-3" id="text-org2bba581">
<p>
<code>vagrant plugin list</code> 命令会列出已经安装的插件及其对应的版本号
</p>

<div class="org-src-container">
<pre class="src src-shell">vagrant plugin list
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">vagrant-libvirt (0.0.43)
vagrant-proxyconf (1.5.2)
vagrant-vbguest (0.15.2)
</pre>
</div>
</div>
</div>

<div id="outline-container-org09fe790" class="outline-3">
<h3 id="org09fe790">卸载插件</h3>
<div class="outline-text-3" id="text-org09fe790">
<div class="org-src-container">
<pre class="src src-shell">vagrant plugin uninstall ${<span class="org-variable-name">plugin_name</span>}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Uninstalling the 'vagrant-proxyconf' plugin...
Successfully uninstalled vagrant-proxyconf-1.5.2
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org01a0438" class="outline-2">
<h2 id="org01a0438">设置代理服务器</h2>
<div class="outline-text-2" id="text-org01a0438">
</div>
<div id="outline-container-org4310711" class="outline-3">
<h3 id="org4310711">为 vagrant 命令设置代理</h3>
<div class="outline-text-3" id="text-org4310711">
<p>
通过配置 <code>http_proxy</code> 和 <code>https_proxy</code> 这两个环境变量可以让 <code>vagrant</code> 命令通过代理访问互联网。
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">export</span> <span class="org-variable-name">http_proxy</span>=http://proxyserver:port
<span class="org-builtin">export</span> <span class="org-variable-name">https_proxy</span>=https://proxyserver:port
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf8fa6cd" class="outline-3">
<h3 id="orgf8fa6cd">为虚拟机设置代理</h3>
<div class="outline-text-3" id="text-orgf8fa6cd">
<p>
为虚拟机设置代理需要借助 <code>vagrant-proxyconf</code> 插件
</p>

<ol class="org-ol">
<li><p>
安装 <code>vagrant-proxyconf</code> 插件 
</p>
<div class="org-src-container">
<pre class="src src-shell">vagrant plugin install vagrant-proxyconf
</pre>
</div></li>

<li><p>
在 <code>VagrantFile</code> 中添加下面配置
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">Vagrant</span>.configure(<span class="org-string">"2"</span>) <span class="org-keyword">do</span> |config|
  <span class="org-keyword">if</span> <span class="org-type">Vagrant</span>.has_plugin?(<span class="org-string">"vagrant-proxyconf"</span>)
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#33509;&#23433;&#35013;&#20102;plugin&#65292;&#21017;&#35774;&#32622;&#20195;&#29702;&#20449;&#24687;</span>
    config.proxy.http     = <span class="org-string">"http://192.168.0.2:3128/"</span>
    config.proxy.https    = <span class="org-string">"http://192.168.0.2:3128/"</span>
    config.proxy.no_proxy = <span class="org-string">"localhost,127.0.0.1,.example.com"</span>
  <span class="org-keyword">else</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#33509;&#27809;&#26377;&#23433;&#35013;plugin&#65292;&#21017;&#35843;&#29992;&#31995;&#32479;&#21629;&#20196;&#23433;&#35013;&#25554;&#20214;&#65292;&#24182;&#25552;&#31034;&#37325;&#36816;&#34892;&#21629;&#20196;</span>
    <span class="org-builtin">system</span>(<span class="org-string">'vagrant plugin install vagrant-proxyconf'</span>)
    <span class="org-builtin">raise</span>(<span class="org-string">"vagrant-proxyconf installed. Run command again."</span>);
  <span class="org-keyword">end</span>
  <span class="org-comment-delimiter"># </span><span class="org-comment">... rest of the configurations</span>
<span class="org-keyword">end</span>
</pre>
</div></li>
</ol>
</div>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2018-07-29</span>
    <span title="last modification date" class="post-info">2018-08-16</span>
    <span title="tags" class="post-info"><a href="../../../../../tags/linux和它的小伙伴">linux和它的小伙伴</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-adabab64-65f3-4ed4-bd6c-a1638c380b0d">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="https://licensebuttons.net/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
