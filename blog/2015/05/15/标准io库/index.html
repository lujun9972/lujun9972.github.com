<!DOCTYPE html>
<html lang="en">
<head>
  <title>标准IO库 - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="DarkSun" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../authors/">Authors</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com.git">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">标准IO库</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org89ef918">1. 流与FILE对象</a>
<ul>
<li><a href="#orga45c37c">1.1. 流定向</a>
<ul>
<li><a href="#org1569ef0">1.1.1. fwide函数:设置流的定向</a></li>
<li><a href="#orgbcb7c65">1.1.2. freopen函数:清除一个流的定向</a></li>
</ul>
</li>
<li><a href="#org4017d9e">1.2. 打开流</a></li>
<li><a href="#org64729e2">1.3. 读写流</a>
<ul>
<li><a href="#org8ee5bc5">1.3.1. 一次一个字符的IO</a></li>
<li><a href="#org57f871e">1.3.2. 一次一行的IO</a></li>
<li><a href="#org7ee8200">1.3.3. 二进制直接IO</a></li>
</ul>
</li>
<li><a href="#org0430619">1.4. 定位流</a></li>
<li><a href="#orgef04d9d">1.5. 错误判断</a></li>
<li><a href="#org622e78a">1.6. fileno:获取流对应的文件描述符</a></li>
</ul>
</li>
<li><a href="#org2c7d6b4">2. 缓冲</a>
<ul>
<li><a href="#org1dd3f70">2.1. 全缓冲</a></li>
<li><a href="#org9fc32d4">2.2. 行缓冲</a></li>
<li><a href="#org30549be">2.3. 缓冲的惯例</a></li>
<li><a href="#orgdbad5c7">2.4. 更改缓冲类型</a>
<ul>
<li><a href="#org1fac5c1">2.4.1. setbuf函数:打开/关闭缓冲机制</a></li>
<li><a href="#org9b4e1c6">2.4.2. setvbuf函数:精确指定缓冲类型</a></li>
<li><a href="#org78a56dc">2.4.3. fflush函数:强制将缓冲区内容写入磁盘</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga894b9f">3. 标准输入,标准输出和标准出错</a></li>
<li><a href="#orgb8179d8">4. 产生临时文件</a></li>
<li><a href="#orgffcc063">5. 线程安全的方式管理FILE对象</a></li>
</ul>
</div>
</div>

<div id="outline-container-org89ef918" class="outline-2">
<h2 id="org89ef918"><span class="section-number-2">1</span> 流与FILE对象</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orga45c37c" class="outline-3">
<h3 id="orga45c37c"><span class="section-number-3">1.1</span> 流定向</h3>
<div class="outline-text-3" id="text-1-1">
<p>
标准IO文件流可用于单字符或多字符字符集. 流的定向(orientation)决定了所读,写的字符是单字符还是多字符的.
</p>

<p>
当一个流被最初创建时,它并没有定向. 
</p>

<p>
如果在未定向的流上使用一个多字节IO函数(&lt;wchar.h&gt;),则将该流的定向设置为宽定向的.
</p>

<p>
如果在未定向的流上使用一个单字节IO函数,则流的定向设置为单字节定向.
</p>
</div>

<div id="outline-container-org1569ef0" class="outline-4">
<h4 id="org1569ef0"><span class="section-number-4">1.1.1</span> fwide函数:设置流的定向</h4>
<div class="outline-text-4" id="text-1-1-1">
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>
<span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;wchar.h&gt;</span>

<span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#33509;mode&#21442;&#25968;&#20540;&#20026;&#36127;,fwide&#23581;&#35797;&#23558;&#27969;&#35774;&#32622;&#20026;&#21333;&#23383;&#33410;&#23450;&#21521;</span><span style="font-weight: bold; font-style: italic;"> */</span>
<span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#33509;mode&#21442;&#25968;&#20540;&#20026;&#27491;,fwide&#23581;&#35797;&#23558;&#27969;&#35774;&#32622;&#20026;&#22810;&#23383;&#33410;&#23450;&#21521;</span><span style="font-weight: bold; font-style: italic;"> */</span>
<span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">&#33509;mode&#21442;&#25968;&#20540;&#20026;0,fwide&#19981;&#35774;&#32622;&#23450;&#21521;,&#21482;&#26159;&#36820;&#22238;&#35813;&#27969;&#30340;&#23450;&#21521;</span><span style="font-weight: bold; font-style: italic;"> */</span>
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">fwide</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>, <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">mode</span>);  <span style="font-weight: bold; font-style: italic;">/*  </span><span style="font-weight: bold; font-style: italic;">&#36820;&#22238;&#20540;&#34920;&#31034;&#27969;&#30340;&#23450;&#21521;,&#27491;&#20026;&#23485;&#23450;&#21521;,&#36127;&#20026;&#20294;&#23450;&#21521;,0&#20026;&#26410;&#23450;&#21521;</span><span style="font-weight: bold; font-style: italic;">*/</span>
</pre>
</div>

<p>
注意:
</p>
<ul class="org-ul">
<li>fwide并不改变已定向流的定向</li>
<li>fwide无出错返回. 只能根据errno的值来判断流是否无效</li>
</ul>
</div>
</div>

<div id="outline-container-orgbcb7c65" class="outline-4">
<h4 id="orgbcb7c65"><span class="section-number-4">1.1.2</span> freopen函数:清除一个流的定向</h4>
</div>
</div>

<div id="outline-container-org4017d9e" class="outline-3">
<h3 id="org4017d9e"><span class="section-number-3">1.2</span> 打开流</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold;">fopen</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">path</span>,<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">type</span>);
<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold;">freopen</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">path</span>,<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">type</span>,<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold;">fdopen</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">filedes</span>,<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">type</span>);
</pre>
</div>

<ul class="org-ul">
<li>fopen打开一个指定的文件,返回新的流</li>

<li><p>
freopen在一个指定的流上打开一个指定的文件. 
</p>

<p>
若该流已被打开,则关闭该流.
</p>

<p>
若该流以及定向,则清除该定向
</p>

<p>
该函数一般将一个指定的文件打开为一个预定义的流:stdin,stdout,stderr
</p></li>

<li><p>
fdopen将一个标准IO流与文件描述符相结合.
</p>

<p>
该函数一般用于将PIPE/SOCKET返回的描述符与标准IO流结合,因为这些特殊类型的文件不能用fopen函数打开.
</p></li>

<li>当以读写类型打开文件时,具有如下限制:
<ul class="org-ul">
<li>如果中间没有fflush,fseek,fsetops或rewind,则输出的后面不能直接跟随输入</li>

<li>如果中间没有fseek,fsetpos或rewind或一个输入操作没有到达文件尾部,则再输入操作之后不能直接跟随输出.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org64729e2" class="outline-3">
<h3 id="org64729e2"><span class="section-number-3">1.3</span> 读写流</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-org8ee5bc5" class="outline-4">
<h4 id="org8ee5bc5"><span class="section-number-4">1.3.1</span> 一次一个字符的IO</h4>
<div class="outline-text-4" id="text-1-3-1">
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">getc</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">fgetc</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">getchar</span>();
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">ungetc</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">c</span>,<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);

<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">putc</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">c</span>,<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">fputc</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">c</span>,<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">putchar</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">c</span>);
</pre>
</div>
<p>
其中getc和fgetc的区别为,getc可能为宏,而fgetc一定是函数. 即
</p>
<ul class="org-ul">
<li>getc的参数不应当是具有副作用的表达式</li>
<li>fgetc一定可以得到其地址,从而作为参数传递给另一个参数.</li>
<li>fgetc调用时间可能会长于getc,因为调用函数所需的时间通常长于调用宏.</li>
<li>ungetc压回的字符, <b>可以不是刚读出的字符</b></li>
</ul>

<p>
putc和fputc的区别类似于getc和fgetc的区别.
</p>
</div>
</div>
<div id="outline-container-org57f871e" class="outline-4">
<h4 id="org57f871e"><span class="section-number-4">1.3.2</span> 一次一行的IO</h4>
<div class="outline-text-4" id="text-1-3-2">
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold;">fgets</span>(<span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">buf</span>,<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">n</span>,<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
<span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold;">gets</span>(<span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">buf</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">fputs</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">str</span>,<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">puts</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">str</span>);
</pre>
</div>
<p>
注意:
</p>
<ul class="org-ul">
<li>gets不能指定缓冲区的长度, <b>且gets并不将换行符存入缓冲区内</b>.</li>
<li>fgets读取时会保持换行符</li>
<li>fputs输出时,指数出str的内容,而不会添加换行符</li>
<li><b>puts输出时,会添加换行符</b>.</li>
</ul>
</div>
</div>
<div id="outline-container-org7ee8200" class="outline-4">
<h4 id="org7ee8200"><span class="section-number-4">1.3.3</span> 二进制直接IO</h4>
<div class="outline-text-4" id="text-1-3-3">
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold;">fread</span>(<span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold; font-style: italic;">ptr</span>,<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">size</span>,<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">ntimes</span>,<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold;">fwrite</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">void</span>* <span style="font-weight: bold; font-style: italic;">ptr</span>,<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">size</span>,<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">ntimes</span>,<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
</pre>
</div>
<ul class="org-ul">
<li>这两个函数,常用于从二进制文件中读/写一个结构</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org0430619" class="outline-3">
<h3 id="org0430619"><span class="section-number-3">1.4</span> 定位流</h3>
<div class="outline-text-3" id="text-1-4">
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">long</span> <span style="font-weight: bold;">ftell</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">fseek</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>,<span style="font-weight: bold; text-decoration: underline;">long</span> <span style="font-weight: bold; font-style: italic;">offset</span>,<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">whence</span>);
<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">rewind</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);

<span style="font-weight: bold; text-decoration: underline;">off_t</span> <span style="font-weight: bold;">ftello</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">fseeko</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>,<span style="font-weight: bold; text-decoration: underline;">off_t</span> <span style="font-weight: bold; font-style: italic;">offset</span>,<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">whence</span>);

<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">fgetpos</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>,<span style="font-weight: bold; text-decoration: underline;">fpos_t</span>* <span style="font-weight: bold; font-style: italic;">pos</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">fsetpos</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>,<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">fpos_t</span>* <span style="font-weight: bold; font-style: italic;">pos</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgef04d9d" class="outline-3">
<h3 id="orgef04d9d"><span class="section-number-3">1.5</span> 错误判断</h3>
<div class="outline-text-3" id="text-1-5">
<p>
读取出错或到达文件结尾,读取函数的返回值都是同一个值. 为了区分这两种不同的情况,必须调用ferror或feof
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">ferror</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">feof</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);

<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">clearerr</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-org622e78a" class="outline-3">
<h3 id="org622e78a"><span class="section-number-3">1.6</span> fileno:获取流对应的文件描述符</h3>
<div class="outline-text-3" id="text-1-6">
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">fileno</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org2c7d6b4" class="outline-2">
<h2 id="org2c7d6b4"><span class="section-number-2">2</span> 缓冲</h2>
<div class="outline-text-2" id="text-2">
<p>
标准IO提供了2种类型的缓冲
</p>
</div>

<div id="outline-container-org1dd3f70" class="outline-3">
<h3 id="org1dd3f70"><span class="section-number-3">2.1</span> 全缓冲</h3>
<div class="outline-text-3" id="text-2-1">
<p>
填满IO缓冲区才进行实际的IO操作
</p>

<p>
对于驻留在磁盘上的文件,通常是由标准IO库实施全缓冲.
</p>
</div>
</div>

<div id="outline-container-org9fc32d4" class="outline-3">
<h3 id="org9fc32d4"><span class="section-number-3">2.2</span> 行缓冲</h3>
<div class="outline-text-3" id="text-2-2">
<p>
当输入和输出中遇到换行符时,标准IO库执行IO操作
</p>

<p>
当流涉及一个终端时,通常使用行缓冲.
</p>
</div>
</div>

<div id="outline-container-org30549be" class="outline-3">
<h3 id="org30549be"><span class="section-number-3">2.3</span> 缓冲的惯例</h3>
<div class="outline-text-3" id="text-2-3">
<p>
一般标准IO缓冲的惯例为:标准出错不带缓冲,打开至终端设备的流是行缓冲,其他流是全缓冲.
</p>
</div>
</div>

<div id="outline-container-orgdbad5c7" class="outline-3">
<h3 id="orgdbad5c7"><span class="section-number-3">2.4</span> 更改缓冲类型</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">setbuf</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>,<span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">buf</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">setvbuf</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>,<span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">buf</span>,<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">mode</span>,<span style="font-weight: bold; text-decoration: underline;">size_t</span> <span style="font-weight: bold; font-style: italic;">size</span>);
</pre>
</div>
</div>

<div id="outline-container-org1fac5c1" class="outline-4">
<h4 id="org1fac5c1"><span class="section-number-4">2.4.1</span> setbuf函数:打开/关闭缓冲机制</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
当为打开缓冲机制时,这里参数buf必须为一个长度为BUFSIZ的缓冲区(BUFSIZ定义在stdio.h中)
</p>

<p>
若要关闭缓冲机制,参数buf为NULL
</p>
</div>
</div>

<div id="outline-container-org9b4e1c6" class="outline-4">
<h4 id="org9b4e1c6"><span class="section-number-4">2.4.2</span> setvbuf函数:精确指定缓冲类型</h4>
<div class="outline-text-4" id="text-2-4-2">
<ul class="org-ul">
<li><p>
参数mode可以为:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">_IOFBF</td>
<td class="org-left">全缓冲</td>
</tr>

<tr>
<td class="org-left">_IOLBF</td>
<td class="org-left">行缓冲</td>
</tr>

<tr>
<td class="org-left">_IONBF</td>
<td class="org-left">无缓冲</td>
</tr>
</tbody>
</table></li>

<li><p>
参数buf无长度限制,因为有参数size指定缓冲大小.
</p>

<p>
<b>若流设置为带缓冲的,而buf为NULL,则表示IO自动为该流分配适当长度的缓冲区(一般为BUFSIZ大小)</b>
</p>

<p>
一般而言,应由系统选择缓冲区的长度,并自动分配缓冲区.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org78a56dc" class="outline-4">
<h4 id="org78a56dc"><span class="section-number-4">2.4.3</span> fflush函数:强制将缓冲区内容写入磁盘</h4>
<div class="outline-text-4" id="text-2-4-3">
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">fflush</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orga894b9f" class="outline-2">
<h2 id="orga894b9f"><span class="section-number-2">3</span> 标准输入,标准输出和标准出错</h2>
<div class="outline-text-2" id="text-3">
<p>
&lt;stdio.h&gt;中预定义了三个文件指针:stdin,stdout和stderr
一般来说,stderr不带缓冲,stdin和stdout为行缓冲
</p>
</div>
</div>
<div id="outline-container-orgb8179d8" class="outline-2">
<h2 id="orgb8179d8"><span class="section-number-2">4</span> 产生临时文件</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold;">tmpnam</span>(<span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">ptr</span>);
<span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold;">tempnam</span>(<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">directory</span>,<span style="font-weight: bold;">const</span> <span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">prefix</span>);

<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold;">tmpfile</span>();
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">mkstemp</span>(<span style="font-weight: bold; text-decoration: underline;">char</span>* <span style="font-weight: bold; font-style: italic;">template</span>);
</pre>
</div>
<ul class="org-ul">
<li>tmpnam函数产生一个临时文件的名字字符串,最多能调用TMP_MAX次</li>

<li>参数ptr可以为NULL,则产生的路径名存放在一个静态区域,下一次调用时被覆盖.</li>

<li>若ptr不为NULL,则数组长度应该不少于L_tmpnam</li>

<li>tmpfile创建一个临时的二进制文件. 关闭该文件或程序结束后会 <b>自动删除该文件</b>.</li>

<li>tempnam与tmpnam的不同在于它允许调用者为所产生的临时文件路径指定目录和前缀. 其按如下顺序选择目录
<ol class="org-ol">
<li><b>环境变量TMPDIR</b> (此时忽略参数directory的值!)</li>

<li>参数directory</li>

<li>&lt;stdio.h&gt;中的字符串P_tmpdir(通常为/tmp)</li>

<li>本地目录</li>
</ol></li>

<li>tempnam中的prefix参数最多只能包含5个字符.</li>

<li>mkstemp的参数template必须为一个路径名,且 <b>最后6个字符设置为XXXXXX</b></li>

<li>mkstemp产生的 <b>临时文件不会自动被删除</b></li>
</ul>
</div>
</div>

<div id="outline-container-orgffcc063" class="outline-2">
<h2 id="orgffcc063"><span class="section-number-2">5</span> 线程安全的方式管理FILE对象</h2>
<div class="outline-text-2" id="text-5">
<p>
PSOXI.1提供了以线程安全的方式管理FILE文件的方法. 可以使用`flockfile'和`ftrylockfile'获取与FILE对象关联的锁,且这个锁为递归锁.
</p>

<p>
所有操作FILE对象的标准IO函数,都需要表现的好像内部调用了flockfile和funlockfile一样,即不能出现多个线程同时写入同一FILE对象时出现乱序的情况.
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">ftrylockfile</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);

<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">flockfile</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);

<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">funlockfile</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
</pre>
</div>
<p>
通过这些函数,我们可以把多个标准IO函数的调用组合成一个原子序列.
</p>

<p>
若标准IO函数每次操作都获取自己的锁再释放,那么在进行单字符的IO操作时,会消耗大量的性能到加解锁中,因此就有了 <b>不加锁的基于字符的标准IO函数</b>
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">&lt;stdio.h&gt;</span>

<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">getchar_unlocked</span>();
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">getc_unlocked</span>(<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);

<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">putchar_unlocked</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">c</span>);
<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">putc_unlocked</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">c</span>,<span style="font-weight: bold; text-decoration: underline;">FILE</span>* <span style="font-weight: bold; font-style: italic;">fp</span>);
</pre>
</div>
<p>
<b>请保证这四个函数调用时包含在flockfile/ftrylockfile和funlockfile中</b>
</p>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2015-05-15</span>
    <span title="last modification date" class="post-info">2016-10-24</span>
    <span title="tags" class="post-info">N/A</span>
    <span title="author" class="post-info">DarkSun</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-9488a5c5-3f1f-487d-9f0f-a2bfa120bd0b">DarkSun</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
