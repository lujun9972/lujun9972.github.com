<!DOCTYPE html>
<html lang="en">
<head>
  <title>创建Emacs版的notify-sender - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="Administrator" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/org-src-fontify.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com.git">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
    <img class="avatar" src="https://avatar.csdnimg.cn/6/2/4/1_lujun9972.jpg" />
  </header>
</div>

<div>
<div class="post">
<h1 class="title">创建Emacs版的notify-sender</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0ea10c3">1. notify-send</a></li>
<li><a href="#org51a5ad0">2. EmacsLisp的notification库</a></li>
<li><a href="#org86250b1">3. 实现</a></li>
</ul>
</div>
</div>
<p>
最近对EmacsScript颇有兴趣,刚好翻看Emacs Lisp Manual的时候看到"Desktop Notifications"这一章,于是突发奇想,尝试实现一个Emacs版的notify-send.
</p>

<div id="outline-container-org0ea10c3" class="outline-2">
<h2 id="org0ea10c3"><span class="section-number-2">1</span> notify-send</h2>
<div class="outline-text-2" id="text-1">
<p>
notify-send是一个可以用来发送桌面通知的命令, 我经常在脚本中用它来通知一些值得关注的消息.
</p>

<p>
简单起见,我们这次只实现notify-send常用的那几个选项:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">-t</td>
<td class="org-left">设置超时时间</td>
</tr>

<tr>
<td class="org-left">-u</td>
<td class="org-left">设置通知级别</td>
</tr>

<tr>
<td class="org-left">-i</td>
<td class="org-left">设置显示图标</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org51a5ad0" class="outline-2">
<h2 id="org51a5ad0"><span class="section-number-2">2</span> EmacsLisp的notification库</h2>
<div class="outline-text-2" id="text-2">
<p>
若Emacs编译时开启了D-Bus支持,则通过加载`notifications'库,Emacs可以给某些操作系统发送"通知"
</p>

<p>
(notifications-notify &amp;rest params)
</p>

<p>
通过D-Bus,使用Freedesktop notification protocol发送通知,该函数返回一个整数作为通知的id
</p>

<p>
参数params可以是如下keyword参数
</p>

<ul class="org-ul">
<li><p>
:bus BUS
</p>

<p>
D-Bus bus. 该参数只有在bus不是`:session'时使用
</p></li>

<li><p>
:title TITLE
</p>

<p>
通知的标题
</p></li>

<li><p>
:body TEXT
</p>

<p>
通知的内容. 某些notification server甚至支持HTML标签
</p></li>

<li><p>
:app-name NAME
</p>

<p>
发送通知的应用程序名称. 默认为`notifications-application-name'
</p></li>

<li><p>
:replaces-id ID
</p>

<p>
表示该通知要替代指定id的原先通知. ID必须是之前`notifications-notify'调用的返回值
</p></li>

<li><p>
:app-icon ICON-FILE
</p>

<p>
通知的图标文件. 若ICON-FILE为nil则不显示图标. 默认为`notifications-application-icon'
</p></li>

<li><p>
:actions (KEY TITLE KEY TITLE&#x2026;)
</p>

<p>
一系列要应用的动作. KEY和TITLE都是字符串. 其中TITLE会在通知上以按钮的形式展现.
</p>

<p>
若要设置默认动作(通常该动作在点击notification时触发)的key为"default".
</p></li>

<li><p>
:timeout TIMEOUT
</p>

<p>
显示多少毫秒后自动关闭. 默认值-1表示超时时间遵照notification server的设置. 0表示无限时间
</p></li>

<li><p>
:urgency URGENCY
</p>

<p>
紧急的级别. 可以是'low,'normal或'critical
</p></li>

<li><p>
:action-items
</p>

<p>
若设置了该关键字,则TITLE string of the action也被解释为icon name
</p></li>

<li><p>
:category CATEGORY
</p>

<p>
通知的类型,字符串格式
</p></li>

<li><p>
:desktop-entry FILENAME
</p>

<p>
This specifies the name of the desktop filename representing the calling program, like `"emacs"'.
</p></li>

<li><p>
:image-data (WIDTH HEIGHT ROWSTRIDE HAS-ALPHA BITS CHANNELS DATA)
</p>

<p>
这是一个raw data 图像格式描述了宽,高,rowstride,是否有alpha通道,每个sample的比特数,通道和图像数据
</p></li>

<li><p>
:image-path PATH
</p>

<p>
PATH为一个URI(目前只支持"file"类型)或"$XDG_DATA_DIRS/icon"目录下的某个icon theme的名称
</p></li>

<li><p>
:sound-file FILENAME
</p>

<p>
弹出通知时,播放声音文件
</p></li>

<li><p>
:sound-name NAME
</p>

<p>
"$XDG_DATA_DIRS/sound"目录下定义的sound theme
</p></li>

<li><p>
:suppress-sound
</p>

<p>
若设置了,则不播放任何声音.
</p></li>

<li><p>
:resident
</p>

<p>
若设置了该参数,则即使对该通知做了动作,该通知也不会自动关闭,除非明确的对该通知发出关闭操作
</p></li>

<li><p>
:transient
</p>

<p>
若设置了该参数,则server会认为该通知是暂时的,而忽略server的持久化能力(?When set the server will treat the notification as transient and by-pass the server's persistence capability, if it should exist?)
</p></li>

<li><p>
:x POSITION / :y POSITION
</p>

<p>
定义通知在屏幕上的显示位置
</p></li>

<li><p>
:on-action FUNCTION
</p>

<p>
当按下了表示action的按钮时,会调用该函数. 该函数接受两个参数:notification id和action key
</p></li>

<li><p>
:on-close FUNCTION
</p>

<p>
当通知因为超时或人为关闭时调用该函数. 该函数接受两个参数:notification id和关闭的REASON.
</p>

<p>
函数中的REASON参数可以是:
</p>

<ul class="org-ul">
<li><p>
'expired
</p>

<p>
由于超时而关闭
</p></li>

<li><p>
'dismissed
</p>

<p>
被人为关闭
</p></li>

<li><p>
'close-notification
</p>

<p>
通过调用`notifications-close-notification'函数来关闭
</p></li>

<li><p>
'undefined
</p>

<p>
notification server未告知原因
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-on-action-function</span> (id key)
(message <span class="org-string">"Message %d, key \"%s\" pressed"</span> id key))
<span class="org-comment-delimiter">;; </span><span class="org-comment">=&gt; my-on-action-function</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my-on-close-function</span> (id reason)
(message <span class="org-string">"Message %d, closed due to \"%s\""</span> id reason))
<span class="org-comment-delimiter">;; </span><span class="org-comment">=&gt; my-on-close-function</span>

(notifications-notify
<span class="org-builtin">:title</span> <span class="org-string">"Title"</span>
<span class="org-builtin">:body</span> <span class="org-string">"This is &lt;b&gt;important&lt;/b&gt;."</span>
<span class="org-builtin">:actions</span> '(<span class="org-string">"Confirm"</span> <span class="org-string">"I agree"</span> <span class="org-string">"Refuse"</span> <span class="org-string">"I disagree"</span>)
<span class="org-builtin">:on-action</span> 'my-on-action-function
<span class="org-builtin">:on-close</span> 'my-on-close-function)
<span class="org-comment-delimiter">;; </span><span class="org-comment">=&gt; 22</span>

&#36825;&#26102;&#20250;&#24377;&#20986;&#19968;&#20010;message window. &#25353;&#19979; <span class="org-string">"I agree"</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">=&gt; Message 22, key "Confirm" pressed</span>
<span class="org-comment-delimiter">;;    </span><span class="org-comment">Message 22, closed due to "dismissed"</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org86250b1" class="outline-2">
<h2 id="org86250b1"><span class="section-number-2">3</span> 实现</h2>
<div class="outline-text-2" id="text-3">
<p>
有了notifications库,实现起来就异常的简单了,基本上只需要调用 <code>notifications-notify</code> 这个函数就OK了.
</p>

<p>
首先是固定的起手式:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">#!/bin/sh
<span class="org-string">":"</span><span class="org-comment-delimiter">; </span><span class="org-comment">exec emacs --quick --script "$0" -- "$@" # -*- mode: emacs-lisp; lexical-binding: t; -*-</span>
(<span class="org-keyword">pop</span> command-line-args-left)            
</pre>
</div>

<p>
使用 <code>notifications-notify</code> 前当然是要先加载notifications库了:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">notifications</span>)
</pre>
</div>

<p>
现在开始需要将传递给命令行的参数转换成传递给 <code>notifications-notify</code> 函数的参数.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">notify-send-args</span> nil
  <span class="org-doc">"&#23384;&#25918;&#20256;&#36882;&#32473;notification-notify&#20989;&#25968;&#30340;&#21442;&#25968;"</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">notify-send-map</span> '((<span class="org-string">"-t"</span> . <span class="org-builtin">:timeout</span>)
                          (<span class="org-string">"-u"</span> . <span class="org-builtin">:urgency</span>)
                          (<span class="org-string">"-i"</span> . <span class="org-builtin">:app-icon</span>))
  <span class="org-doc">"&#21629;&#20196;&#34892;&#21442;&#25968;&#19982;notifications-notify&#21442;&#25968;&#30340;&#23545;&#24212;&#20851;&#31995;"</span>)

<span class="org-comment-delimiter">;; </span><span class="org-comment">&#23558;&#21629;&#20196;&#34892;&#21442;&#25968;&#36716;&#25442;&#25104;&#23545;&#24212;&#30340;&#20989;&#25968;&#21442;&#25968;</span>
(<span class="org-keyword">catch</span> <span class="org-constant">:DONE</span>
  (<span class="org-keyword">while</span> command-line-args-left
    (<span class="org-keyword">let</span> ((arg (<span class="org-keyword">pop</span> command-line-args-left)))
      (<span class="org-keyword">cond</span> ((assoc arg notify-send-map)
             (<span class="org-keyword">let</span> ((arg (cdr (assoc arg notify-send-map)))
                   (val (<span class="org-keyword">pop</span> command-line-args-left)))
               (<span class="org-keyword">when</span> (eq arg <span class="org-builtin">:timeout</span>)
                 (<span class="org-keyword">setq</span> val (string-to-number val)))
               (<span class="org-keyword">setq</span> notify-send-args `(,arg ,val ,@notify-send-args) )))
            ((string= arg <span class="org-string">"--"</span>)
             (<span class="org-keyword">let</span> ((title (<span class="org-keyword">pop</span> command-line-args-left))
                   (body (<span class="org-keyword">pop</span> command-line-args-left)))
               (<span class="org-keyword">setq</span> notify-send-args `(<span class="org-builtin">:title</span> ,title <span class="org-builtin">:body</span> ,body ,@notify-send-args))
               (<span class="org-keyword">throw</span> <span class="org-constant">:DONE</span> <span class="org-builtin">:DONE</span>)))
            (t
             (<span class="org-keyword">let</span> ((title arg)
                   (body (<span class="org-keyword">pop</span> command-line-args-left)))
               (<span class="org-keyword">setq</span> notify-send-args `(<span class="org-builtin">:title</span> ,title <span class="org-builtin">:body</span> ,body ,@notify-send-args))
               (<span class="org-keyword">throw</span> <span class="org-constant">:DONE</span> <span class="org-builtin">:DONE</span>)))))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">&#35843;&#29992;notifications-notify&#21457;&#36865;&#28040;&#24687;</span>
(apply #'notifications-notify notify-send-args)
</pre>
</div>

<p>
最后将 <code>command-line-args-left</code> 清空,防止报错.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> command-line-args-left nil)
</pre>
</div>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2016-12-16</span>
    <span title="last modification date" class="post-info">2017-01-09</span>
    <span title="tags" class="post-info">N/A</span>
    <span title="author" class="post-info">Administrator</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-e17915d5-315f-4c20-b125-fbc09909e5be">Administrator</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="https://licensebuttons.net/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
