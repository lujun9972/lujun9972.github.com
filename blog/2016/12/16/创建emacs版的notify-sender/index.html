<!DOCTYPE html>
<html lang="en">
<head>
  <title>创建Emacs版的notify-sender - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="Administrator" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../authors/">Authors</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">创建Emacs版的notify-sender</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org93424be">1. notify-send</a></li>
<li><a href="#orgee3b188">2. EmacsLisp的notification库</a></li>
<li><a href="#org062ba6f">3. 实现</a></li>
</ul>
</div>
</div>
<p>
最近对EmacsScript颇有兴趣,刚好翻看Emacs Lisp Manual的时候看到"Desktop Notifications"这一章,于是突发奇想,尝试实现一个Emacs版的notify-send.
</p>

<div id="outline-container-org93424be" class="outline-2">
<h2 id="org93424be"><span class="section-number-2">1</span> notify-send</h2>
<div class="outline-text-2" id="text-1">
<p>
notify-send是一个可以用来发送桌面通知的命令, 我经常在脚本中用它来通知一些值得关注的消息.
</p>

<p>
简单起见,我们这次只实现notify-send常用的那几个选项:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">-t</td>
<td class="org-left">设置超时时间</td>
</tr>

<tr>
<td class="org-left">-u</td>
<td class="org-left">设置通知级别</td>
</tr>

<tr>
<td class="org-left">-i</td>
<td class="org-left">设置显示图标</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgee3b188" class="outline-2">
<h2 id="orgee3b188"><span class="section-number-2">2</span> EmacsLisp的notification库</h2>
<div class="outline-text-2" id="text-2">
<p>
若Emacs编译时开启了D-Bus支持,则通过加载`notifications'库,Emacs可以给某些操作系统发送"通知"
</p>

<p>
(notifications-notify &amp;rest params)
</p>

<p>
通过D-Bus,使用Freedesktop notification protocol发送通知,该函数返回一个整数作为通知的id
</p>

<p>
参数params可以是如下keyword参数
</p>

<ul class="org-ul">
<li><p>
:bus BUS
</p>

<p>
D-Bus bus. 该参数只有在bus不是`:session'时使用
</p></li>

<li><p>
:title TITLE
</p>

<p>
通知的标题
</p></li>

<li><p>
:body TEXT
</p>

<p>
通知的内容. 某些notification server甚至支持HTML标签
</p></li>

<li><p>
:app-name NAME
</p>

<p>
发送通知的应用程序名称. 默认为`notifications-application-name'
</p></li>

<li><p>
:replaces-id ID
</p>

<p>
表示该通知要替代指定id的原先通知. ID必须是之前`notifications-notify'调用的返回值
</p></li>

<li><p>
:app-icon ICON-FILE
</p>

<p>
通知的图标文件. 若ICON-FILE为nil则不显示图标. 默认为`notifications-application-icon'
</p></li>

<li><p>
:actions (KEY TITLE KEY TITLE&#x2026;)
</p>

<p>
一系列要应用的动作. KEY和TITLE都是字符串. 其中TITLE会在通知上以按钮的形式展现.
</p>

<p>
若要设置默认动作(通常该动作在点击notification时触发)的key为"default".
</p></li>

<li><p>
:timeout TIMEOUT
</p>

<p>
显示多少毫秒后自动关闭. 默认值-1表示超时时间遵照notification server的设置. 0表示无限时间
</p></li>

<li><p>
:urgency URGENCY
</p>

<p>
紧急的级别. 可以是'low,'normal或'critical
</p></li>

<li><p>
:action-items
</p>

<p>
若设置了该关键字,则TITLE string of the action也被解释为icon name
</p></li>

<li><p>
:category CATEGORY
</p>

<p>
通知的类型,字符串格式
</p></li>

<li><p>
:desktop-entry FILENAME
</p>

<p>
This specifies the name of the desktop filename representing the calling program, like `"emacs"'.
</p></li>

<li><p>
:image-data (WIDTH HEIGHT ROWSTRIDE HAS-ALPHA BITS CHANNELS DATA)
</p>

<p>
这是一个raw data 图像格式描述了宽,高,rowstride,是否有alpha通道,每个sample的比特数,通道和图像数据
</p></li>

<li><p>
:image-path PATH
</p>

<p>
PATH为一个URI(目前只支持"file"类型)或"$XDG_DATA_DIRS/icon"目录下的某个icon theme的名称
</p></li>

<li><p>
:sound-file FILENAME
</p>

<p>
弹出通知时,播放声音文件
</p></li>

<li><p>
:sound-name NAME
</p>

<p>
"$XDG_DATA_DIRS/sound"目录下定义的sound theme
</p></li>

<li><p>
:suppress-sound
</p>

<p>
若设置了,则不播放任何声音.
</p></li>

<li><p>
:resident
</p>

<p>
若设置了该参数,则即使对该通知做了动作,该通知也不会自动关闭,除非明确的对该通知发出关闭操作
</p></li>

<li><p>
:transient
</p>

<p>
若设置了该参数,则server会认为该通知是暂时的,而忽略server的持久化能力(?When set the server will treat the notification as transient and by-pass the server's persistence capability, if it should exist?)
</p></li>

<li><p>
:x POSITION / :y POSITION
</p>

<p>
定义通知在屏幕上的显示位置
</p></li>

<li><p>
:on-action FUNCTION
</p>

<p>
当按下了表示action的按钮时,会调用该函数. 该函数接受两个参数:notification id和action key
</p></li>

<li><p>
:on-close FUNCTION
</p>

<p>
当通知因为超时或人为关闭时调用该函数. 该函数接受两个参数:notification id和关闭的REASON.
</p>

<p>
函数中的REASON参数可以是:
</p>

<ul class="org-ul">
<li><p>
'expired
</p>

<p>
由于超时而关闭
</p></li>

<li><p>
'dismissed
</p>

<p>
被人为关闭
</p></li>

<li><p>
'close-notification
</p>

<p>
通过调用`notifications-close-notification'函数来关闭
</p></li>

<li><p>
'undefined
</p>

<p>
notification server未告知原因
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defun</span> <span style="color: #bc6ec5; font-weight: bold;">my-on-action-function</span> <span style="color: #bc6ec5;">(</span>id key<span style="color: #bc6ec5;">)</span>
<span style="color: #bc6ec5;">(</span>message <span style="color: #2d9574;">"Message %d, key \"%s\" pressed"</span> id key<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; my-on-action-function</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defun</span> <span style="color: #bc6ec5; font-weight: bold;">my-on-close-function</span> <span style="color: #bc6ec5;">(</span>id reason<span style="color: #bc6ec5;">)</span>
<span style="color: #bc6ec5;">(</span>message <span style="color: #2d9574;">"Message %d, closed due to \"%s\""</span> id reason<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; my-on-close-function</span>

<span style="color: #4f97d7;">(</span>notifications-notify
<span style="color: #4f97d7;">:title</span> <span style="color: #2d9574;">"Title"</span>
<span style="color: #4f97d7;">:body</span> <span style="color: #2d9574;">"This is &lt;b&gt;important&lt;/b&gt;."</span>
<span style="color: #4f97d7;">:actions</span> '<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"Confirm"</span> <span style="color: #2d9574;">"I agree"</span> <span style="color: #2d9574;">"Refuse"</span> <span style="color: #2d9574;">"I disagree"</span><span style="color: #bc6ec5;">)</span>
<span style="color: #4f97d7;">:on-action</span> 'my-on-action-function
<span style="color: #4f97d7;">:on-close</span> 'my-on-close-function<span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; 22</span>

&#36825;&#26102;&#20250;&#24377;&#20986;&#19968;&#20010;message window. &#25353;&#19979; <span style="color: #2d9574;">"I agree"</span>
<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; Message 22, key "Confirm" pressed</span>
<span style="color: #2aa1ae; background-color: #292e34;">;;    </span><span style="color: #2aa1ae; background-color: #292e34;">Message 22, closed due to "dismissed"</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org062ba6f" class="outline-2">
<h2 id="org062ba6f"><span class="section-number-2">3</span> 实现</h2>
<div class="outline-text-2" id="text-3">
<p>
有了notifications库,实现起来就异常的简单了,基本上只需要调用 <code>notifications-notify</code> 这个函数就OK了.
</p>

<p>
首先是固定的起手式:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">#!/bin/sh
<span style="color: #2d9574;">":"</span><span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">exec emacs --quick --script "$0" -- "$@" # -*- mode: emacs-lisp; lexical-binding: t; -*-</span>
<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">pop</span> command-line-args-left<span style="color: #4f97d7;">)</span>            
</pre>
</div>

<p>
使用 <code>notifications-notify</code> 前当然是要先加载notifications库了:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">require</span> '<span style="color: #a45bad;">notifications</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
现在开始需要将传递给命令行的参数转换成传递给 <code>notifications-notify</code> 函数的参数.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defvar</span> <span style="color: #7590db;">notify-send-args</span> nil
  <span style="color: #2aa1ae;">"&#23384;&#25918;&#20256;&#36882;&#32473;notification-notify&#20989;&#25968;&#30340;&#21442;&#25968;"</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defvar</span> <span style="color: #7590db;">notify-send-map</span> '<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"-t"</span> . <span style="color: #4f97d7;">:timeout</span><span style="color: #2d9574;">)</span>
                          <span style="color: #2d9574;">(</span><span style="color: #2d9574;">"-u"</span> . <span style="color: #4f97d7;">:urgency</span><span style="color: #2d9574;">)</span>
                          <span style="color: #2d9574;">(</span><span style="color: #2d9574;">"-i"</span> . <span style="color: #4f97d7;">:app-icon</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #2aa1ae;">"&#21629;&#20196;&#34892;&#21442;&#25968;&#19982;notifications-notify&#21442;&#25968;&#30340;&#23545;&#24212;&#20851;&#31995;"</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">&#23558;&#21629;&#20196;&#34892;&#21442;&#25968;&#36716;&#25442;&#25104;&#23545;&#24212;&#30340;&#20989;&#25968;&#21442;&#25968;</span>
<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #a45bad;">:DONE</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">while</span> command-line-args-left
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>arg <span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">pop</span> command-line-args-left<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">cond</span> <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>assoc arg notify-send-map<span style="color: #4f97d7;">)</span>
             <span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>arg <span style="color: #9cb6ad;">(</span>cdr <span style="color: #4f97d7;">(</span>assoc arg notify-send-map<span style="color: #4f97d7;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span>
                   <span style="color: #2d9574;">(</span>val <span style="color: #9cb6ad;">(</span><span style="color: #4f97d7; font-weight: bold;">pop</span> command-line-args-left<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
               <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">when</span> <span style="color: #2d9574;">(</span>eq arg <span style="color: #4f97d7;">:timeout</span><span style="color: #2d9574;">)</span>
                 <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">setq</span> val <span style="color: #9cb6ad;">(</span>string-to-number val<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
               <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">setq</span> notify-send-args `<span style="color: #2d9574;">(</span>,arg ,val ,@notify-send-args<span style="color: #2d9574;">)</span> <span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>
            <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>string= arg <span style="color: #2d9574;">"--"</span><span style="color: #4f97d7;">)</span>
             <span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>title <span style="color: #9cb6ad;">(</span><span style="color: #4f97d7; font-weight: bold;">pop</span> command-line-args-left<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span>
                   <span style="color: #2d9574;">(</span>body <span style="color: #9cb6ad;">(</span><span style="color: #4f97d7; font-weight: bold;">pop</span> command-line-args-left<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
               <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">setq</span> notify-send-args `<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">:title</span> ,title <span style="color: #4f97d7;">:body</span> ,body ,@notify-send-args<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
               <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #a45bad;">:DONE</span> <span style="color: #4f97d7;">:DONE</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>
            <span style="color: #b1951d;">(</span>t
             <span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>title arg<span style="color: #2d9574;">)</span>
                   <span style="color: #2d9574;">(</span>body <span style="color: #9cb6ad;">(</span><span style="color: #4f97d7; font-weight: bold;">pop</span> command-line-args-left<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
               <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">setq</span> notify-send-args `<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">:title</span> ,title <span style="color: #4f97d7;">:body</span> ,body ,@notify-send-args<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
               <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #a45bad;">:DONE</span> <span style="color: #4f97d7;">:DONE</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">&#35843;&#29992;notifications-notify&#21457;&#36865;&#28040;&#24687;</span>
<span style="color: #4f97d7;">(</span>apply #'notifications-notify notify-send-args<span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
最后将 <code>command-line-args-left</code> 清空,防止报错.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">setq</span> command-line-args-left nil<span style="color: #4f97d7;">)</span>
</pre>
</div>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2016-12-16</span>
    <span title="last modification date" class="post-info">2017-01-09</span>
    <span title="tags" class="post-info">N/A</span>
    <span title="author" class="post-info">Administrator</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T520">Administrator</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
