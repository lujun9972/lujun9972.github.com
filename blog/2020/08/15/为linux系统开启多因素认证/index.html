<!DOCTYPE html>
<html lang="en">
<head>
  <title>为Linux系统开启多因素认证 - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="linux和它的小伙伴" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/org-src-fontify.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;DarkSun的个人博客</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="git@github.com:lujun9972/lujun9972.github.com.git">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">为Linux系统开启多因素认证</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb4fada5">安装</a></li>
<li><a href="#orgce584a3">配置 google-authenticator 模块</a></li>
<li><a href="#org1b8ca43">启用google-authenticator模块</a></li>
</ul>
</div>
</div>
<p>
通常我们登陆系统时只需要输入用户名和密码即可（若是通过SSH登陆则还可以通过密钥对来登陆）。
而多因素认证可以要求用户提供附加的认证信息来加强安全性，这个附加信息可能是一条短信验证码，安全令牌应用生成的一次性密码，指纹等内容。
</p>

<p>
本文要做的就是通过 google-authenticator 为Linux增加基于安全令牌的多因素认证
</p>

<div id="outline-container-orgb4fada5" class="outline-2">
<h2 id="orgb4fada5">安装</h2>
<div class="outline-text-2" id="text-orgb4fada5">
<p>
首先在Linux上安装PAM模块google-authenticator
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo pacman -S libpam-google-authenticator
</pre>
</div>

<p>
然后，在手机上安装 <code>小米安全令牌</code> 应用
</p>
</div>
</div>

<div id="outline-container-orgce584a3" class="outline-2">
<h2 id="orgce584a3">配置 google-authenticator 模块</h2>
<div class="outline-text-2" id="text-orgce584a3">
<p>
运行 <code>google-authenticator</code> 来生成 OTP code。该命令会询问是否基于时间生成认证码，并生成一个二维码供你扫描。
</p>


<div class="figure">
<p><img src="../../../../../assets/blog/2020/08/15/为linux系统开启多因素认证/OTP.png" alt="OTP.png" />
</p>
</div>

<p>
在手机上打开 <code>小米安全令牌</code> 扫描这个二维码就能看认证码了，输入认证码后，再回答几个问题就完成了google-authentiator模块的配置了
</p>
<pre class="example">
Enter code from app (-1 to skip): 383791
Code confirmed
Your emergency scratch codes are:
  28577389
  12044244
  52789565
  81786311
  51903013

Do you want me to update your "/home/lujun9972/.google_authenticator" file? (y/n) y

Do you want to disallow multiple uses of the same authentication
token? This restricts you to one login about every 30s, but it increases
your chances to notice or even prevent man-in-the-middle attacks (y/n) y

By default, a new token is generated every 30 seconds by the mobile app.
In order to compensate for possible time-skew between the client and the server,
we allow an extra token before and after the current time. This allows for a
time skew of up to 30 seconds between authentication server and client. If you
experience problems with poor time synchronization, you can increase the window
from its default size of 3 permitted codes (one previous code, the current
code, the next code) to 17 permitted codes (the 8 previous codes, the current
code, and the 8 next codes). This will permit for a time skew of up to 4 minutes
between client and server.
Do you want to do so? (y/n) y

If the computer that you are logging into isn't hardened against brute-force
login attempts, you can enable rate-limiting for the authentication module.
By default, this limits attackers to no more than 3 login attempts every 30s.
Do you want to enable rate-limiting? (y/n) y
</pre>
</div>
</div>

<div id="outline-container-org1b8ca43" class="outline-2">
<h2 id="org1b8ca43">启用google-authenticator模块</h2>
<div class="outline-text-2" id="text-org1b8ca43">
<p>
一般来说，通过 <code>login</code> 登陆系统要求接触到物理机器，本身安全性已经足够高了，开启多因素认证意义不大，我们主要对通过网络认证的 <code>sshd</code> 进行约束。
</p>

<ol class="org-ol">
<li><p>
为 <code>sshd</code> PAM启用google-authenticator认证
</p>

<p>
往 <code>/etc/pam.d/sshd</code> 中添加如下内容:
</p>
<div class="org-src-container">
<pre class="src src-conf">auth required pam_google_authenticator.so nullok
</pre>
</div>

<p>
其中 <code>nullok</code> 的意思是对于未配置多因素认证的用户不需要输入认证码。若没有这个参数则会强制要求主机上的所有用户都必须启用多因素认证。
</p></li>

<li><p>
配置 <code>sshd</code> 使用PAM进行认证
</p>

<p>
编辑 <code>/etc/ssh/sshd_config</code> 确定 <code>UsePAM</code> 的值为 <code>yes</code>
</p></li>

<li><p>
配置 <code>sshd</code> 提示输入认证码
</p>

<p>
编辑 <code>/etc/ssh/sshd_config</code> 确定 <code>ChallengeResponseAuthentication</code> 的值为 <code>yes</code>
</p></li>

<li><p>
重启 <code>sshd</code> 服务
</p>

<div class="org-src-container">
<pre class="src src-shell">sudo systemctl restart sshd
</pre>
</div></li>
</ol>


<p>
这样一来，通过 <code>sshd</code> 登陆 <code>lujun9972</code> 这个用户时就会要求输入认证码了，而登陆其他用户时则无需输入验证码:
</p>
<pre class="example">
lujun9972@orangepipc2:~$ ssh 192.168.1.206 -p 8022
The authenticity of host '[192.168.1.206]:8022 ([192.168.1.206]:8022)' can't be established.
ECDSA key fingerprint is SHA256:zIiiOyKuX/q7d+CI5HKNTTiqcHQ+QSf+caivgdS/OG8.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '[192.168.1.206]:8022' (ECDSA) to the list of known hosts.
Password: 
Verification code: 
Last login: Sat Aug 15 19:35:37 2020 from 127.0.0.1
Test whether fcitx is running correctly with dbus...
Fcitx is running correctly.

=========================================================
Launch fbterm...
stdin isn't a interactive tty!
lujun9972:~/ $ exit
logout
Connection to 192.168.1.206 closed.
lujun9972@orangepipc2:~$ ssh daddy@192.168.1.206 -p 8022
Password: 
Last login: Sat Aug 15 19:37:50 2020 from 127.0.0.1
[daddy@T520 /]$ exit
logout
Connection to 192.168.1.206 closed.
lujun9972@orangepipc2:~$ 
</pre>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2020-08-15</span>
    <span title="last modification date" class="post-info">2020-08-15</span>
    <span title="tags" class="post-info"><a href="../../../../../tags/linux和它的小伙伴">linux和它的小伙伴</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <!-- 添加一叶 -->
  <link href="https://yiyechat.com/open-source/build/content-static/css/main.css" rel="stylesheet">
  <script src="https://yiyechat.com/open-source/build/content-static/js/main.js" ></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-eb15b8af-c93c-4e4f-8aa5-44a977823ee7">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="https://licensebuttons.net/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
