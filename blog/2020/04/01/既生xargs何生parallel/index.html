<!DOCTYPE html>
<html lang="en">
<head>
  <title>既生xargs何生parallel - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="linux和它的小伙伴" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/org-src-fontify.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;DarkSun的个人博客</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com.git">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">既生xargs何生parallel</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgad95e88">xargs 不能很好的处理特殊字符(比如空格, \, ' 和 ")</a></li>
<li><a href="#org30fc9c9">xargs 没有参数直接按CPU Core数量来并法运行任务，而必须人工指定并法度</a></li>
<li><a href="#org5a26bfb">xargs 可能会导致输出串行</a></li>
<li><a href="#orgfb9f27a">xargs 不支持保持多任务输出的顺序</a></li>
<li><a href="#orgac6d3f0">xargs 不支持远程运行任务</a></li>
<li><a href="#org7ff578d">xargs 不支持context替换</a></li>
<li><a href="#orga35f144">xargs使用 -I 选项时，只能替代一个参数.</a></li>
<li><a href="#org613feee">当命令中包含复合命令，管道或IO重定向时，xargs需要将之包装在 bash -c中</a></li>
</ul>
</div>
</div>
<p>
xargs和parallel都能并发运行多个命令，然而对这两个命令的区别一直不太清楚，直到看到了这篇文章:<a href="https://www.gnu.org/software/parallel/parallel_alternatives.html#DIFFERENCES-BETWEEN-xargs-AND-GNU-Parallel">https://www.gnu.org/software/parallel/parallel_alternatives.html#DIFFERENCES-BETWEEN-xargs-AND-GNU-Parallel</a>
</p>

<p>
简单的说，parallel就是增强版的xargs。
</p>

<div id="outline-container-orgad95e88" class="outline-2">
<h2 id="orgad95e88">xargs 不能很好的处理特殊字符(比如空格, \, ' 和 ")</h2>
<div class="outline-text-2" id="text-orgad95e88">
<p>
比如下面这个例子
</p>

<div class="org-src-container">
<pre class="src src-shell">touch important_file
touch <span class="org-string">'not important_file'</span>
ls not* | xargs rm              
</pre>
</div>
<p>
会删除 <code>import_file</code>,并提示 <code>rm: 无法删除 'not': 没有那个文件或目录</code>
</p>

<div class="org-src-container">
<pre class="src src-shell">mkdir -p <span class="org-string">"My brother's 12\" records"</span>
ls | xargs rmdir
</pre>
</div>
<p>
会提示 <code>/usr/bin/xargs: 未匹配的 单 引用；默认情况下，引用是针对 xargs 的，除非您使用了 -0 选项</code> 和 <code>rmdir: 删除 'My' 失败: 没有那个文件或目录</code>
</p>

<div class="org-src-container">
<pre class="src src-shell">touch <span class="org-string">'c:\windows\system32\clfs.sys'</span>
<span class="org-builtin">echo</span> <span class="org-string">'c:\windows\system32\clfs.sys'</span> | xargs ls -l
</pre>
</div>
<p>
会提示: <code>ls: 无法访问 'c:windowssystem32clfs.sys': 没有那个文件或目录</code>
</p>

<p>
一般遇到这种情况你需要使用xargs的 <code>-0</code> 参数来指定使用 <code>NUL</code> 作为分隔符，然而这同时要求产生输入的命令的支持。
</p>

<p>
还有一种变通方案是使用 xargs 的 <code>-d</code> 选项指定使用换行符作为分隔符,比如:
</p>
<div class="org-src-container">
<pre class="src src-shell">touch <span class="org-string">'c:\windows\system32\clfs.sys'</span>
touch <span class="org-string">'not important_file'</span>
ls |xargs -d <span class="org-string">"\n"</span> -n1 rm
</pre>
</div>
</div>
</div>

<div id="outline-container-org30fc9c9" class="outline-2">
<h2 id="org30fc9c9">xargs 没有参数直接按CPU Core数量来并法运行任务，而必须人工指定并法度</h2>
<div class="outline-text-2" id="text-org30fc9c9">
<p>
在parallel默认依据CPU Core数量来决定并发的任务数，而且除了能通过 <code>-P N</code> 直接设定并发度外,还能通过 <code>-P +N</code>, <code>-P -N</code>, <code>-P N%</code> 来在CPU Core的数量基准进行调整(减少N个，增加N个，乘于N%)
</p>

<p>
而xargs只能通过 <code>-P N</code> 来手工设定并法度， 不过这也不是什么太大的问题，我们可以通过 <code>grep processor /proc/cpuinfo |wc -l</code> 来统计CPU的Core数量
</p>
</div>
</div>

<div id="outline-container-org5a26bfb" class="outline-2">
<h2 id="org5a26bfb">xargs 可能会导致输出串行</h2>
<div class="outline-text-2" id="text-org5a26bfb">
<p>
也就是可能一行输出的前半部分是一个进程的输出，而后半部分是另一个进程的输出。例如:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-function-name">slow_seq</span>() {
    <span class="org-builtin">echo</span> Count to <span class="org-string">"$@"</span>
    seq <span class="org-string">"$@"</span> |
        perl -ne <span class="org-string">'$|=1; for(split//){ print; select($a,$a,$a,0.100);}'</span>
}
<span class="org-builtin">export</span> -f slow_seq
<span class="org-builtin">echo</span> <span class="org-string">"&#36825;&#26159;&#26399;&#26395;&#20540;"</span>
seq 8 | xargs -n1 -P1 -I {} bash -c <span class="org-string">'slow_seq {}'</span>
<span class="org-builtin">echo</span> <span class="org-string">"&#20351;&#29992;parallel&#36827;&#34892;&#24182;&#21457;"</span>
seq 8 | parallel -P8 slow_seq {}
<span class="org-builtin">echo</span> <span class="org-string">"&#20351;&#29992;xargs&#36827;&#34892;&#24182;&#21457;"</span>
seq 8 | xargs -n1 -P8 -I {} bash -c <span class="org-string">'slow_seq {}'</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">&#36825;&#26159;&#26399;&#26395;&#20540;
Count to 1
1
Count to 2
1
2
Count to 3
1
2
3
Count to 4
1
2
3
4
Count to 5
1
2
3
4
5
Count to 6
1
2
3
4
5
6
Count to 7
1
2
3
4
5
6
7
Count to 8
1
2
3
4
5
6
7
8
&#20351;&#29992;parallel&#36827;&#34892;&#24182;&#21457;
Count to 1
1
Count to 2
1
2
Count to 3
1
2
3
Count to 4
1
2
3
4
Count to 5
1
2
3
4
5
Count to 6
1
2
3
4
5
6
Count to 7
1
2
3
4
5
6
7
Count to 8
1
2
3
4
5
6
7
8
&#20351;&#29992;xargs&#36827;&#34892;&#24182;&#21457;
Count to 1
Count to 2
Count to 3
Count to 4
11Count to 5
11Count to 6
Count to 7
1Count to 8
111







2222222






333333





44444




5555



666


77

8
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfb9f27a" class="outline-2">
<h2 id="orgfb9f27a">xargs 不支持保持多任务输出的顺序</h2>
<div class="outline-text-2" id="text-orgfb9f27a">
<p>
parallel 可以通过 <code>-k</code> 或 <code>--keep-order</code> 选项来保证多任务的输出顺序与顺序执行时的顺序一直。
</p>

<p>
而xargs无此功能，也就是说任务有多行输出的话，可能导致多个任务的输出混杂在一起.
</p>
</div>
</div>

<div id="outline-container-orgac6d3f0" class="outline-2">
<h2 id="orgac6d3f0">xargs 不支持远程运行任务</h2>
<div class="outline-text-2" id="text-orgac6d3f0">
<p>
parallel可以通过 <code>--sshlogin</code> 来将任务发送到远程主机上并发运行.
</p>

<p>
其他与远程运行的命令包括 <code>--ssh</code>, <code>--return</code>, <code>--transfer</code>, <code>--transferfile</code>, <code>--tf</code>, <code>--cleanup</code>, <code>--env</code>
</p>

<p>
这个能力极其恐怖，下面是摘自 <code>man parallel</code> 中的一个远程执行任务的例子:
</p>
<pre class="example">
EXAMPLE: Using remote computers
       To run commands on a remote computer SSH needs to be set
       up and you must be able to login without entering a
       password (The commands ssh-copy-id, ssh-agent, and
       sshpass may help you do that).

       If you need to login to a whole cluster, you typically do
       not want to accept the host key for every host. You want
       to accept them the first time and be warned if they are
       ever changed. To do that:

         # Add the servers to the sshloginfile
         (echo servera; echo serverb) &gt; .parallel/my_cluster
         # Make sure .ssh/config exist
         touch .ssh/config
         cp .ssh/config .ssh/config.backup
         # Disable StrictHostKeyChecking temporarily
         (echo 'Host *'; echo StrictHostKeyChecking no) &gt;&gt; .ssh/config
         parallel --slf my_cluster --nonall true
         # Remove the disabling of StrictHostKeyChecking
         mv .ssh/config.backup .ssh/config

       The servers in .parallel/my_cluster are now added in
       .ssh/known_hosts.

       To run echo on server.example.com:

         seq 10 | parallel --sshlogin server.example.com echo

       To run commands on more than one remote computer run:

         seq 10 | parallel --sshlogin s1.example.com,s2.example.net echo

       Or:

         seq 10 | parallel --sshlogin server.example.com \
           --sshlogin server2.example.net echo

       If the login username is foo on server2.example.net use:

         seq 10 | parallel --sshlogin server.example.com \
           --sshlogin foo@server2.example.net echo

       If your list of hosts is server1-88.example.net with
       login foo:

         seq 10 | parallel -Sfoo@server{1..88}.example.net echo

       To distribute the commands to a list of computers, make a
       file mycomputers with all the computers:

         server.example.com
         foo@server2.example.com
         server3.example.com

       Then run:

         seq 10 | parallel --sshloginfile mycomputers echo

       To include the local computer add the special sshlogin
       ':' to the list:

         server.example.com
         foo@server2.example.com
         server3.example.com
         :

       GNU parallel will try to determine the number of CPUs on
       each of the remote computers, and run one job per CPU -
       even if the remote computers do not have the same number
       of CPUs.

       If the number of CPUs on the remote computers is not
       identified correctly the number of CPUs can be added in
       front. Here the computer has 8 CPUs.

         seq 10 | parallel --sshlogin 8/server.example.com echo
</pre>
</div>
</div>
<div id="outline-container-org7ff578d" class="outline-2">
<h2 id="org7ff578d">xargs 不支持context替换</h2>
<div class="outline-text-2" id="text-org7ff578d">
<p>
parallel 的 <code>-X</code> 选项可以让 <code>{}</code> 替换成命令行参数允许的最多参数值，若并发运行多个任务，则这些参数会被平均地分给每个任务，这种多参数的替换被称为context替换。例如
</p>

<div class="org-src-container">
<pre class="src src-shell">seq 1 123|parallel -X -I{} <span class="org-builtin">echo</span> {}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62
63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93
94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123
</pre>
</div>
</div>
</div>

<div id="outline-container-orga35f144" class="outline-2">
<h2 id="orga35f144">xargs使用 -I 选项时，只能替代一个参数.</h2>
<div class="outline-text-2" id="text-orga35f144">
<p>
xargs的 <code>-I</code> 选项默认了 <code>-L 1</code>,也就是说每个命令行只能使用最多一行输入作为参数。
</p>

<p>
而parallel中没有这个限制
</p>
<div class="org-src-container">
<pre class="src src-shell">seq 1 11 |parallel -I{} -l 2 echo 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">1 2
3 4
5 6
7 8
9 10
11
</pre>
</div>
</div>
</div>

<div id="outline-container-org613feee" class="outline-2">
<h2 id="org613feee">当命令中包含复合命令，管道或IO重定向时，xargs需要将之包装在 bash -c中</h2>
<div class="outline-text-2" id="text-org613feee">
<p>
在xargs中，若将命令用括号引用起来，则xargs将整个括号的内容当成是一个命令名，也就是类似于parallel中的 <code>-q</code> 选项:
</p>

<p>
所以当你执行
</p>
<div class="org-src-container">
<pre class="src src-shell">ls | xargs -d <span class="org-string">"\n"</span>  -I {} <span class="org-string">"wc {} &gt;{}.wc"</span>
</pre>
</div>
<p>
时，xargs会尝试查找一个叫做 <code>wc XXX&gt;XXX.wc</code> 的命令，结果就是提示找不到该命令。
</p>

<p>
正确的做法是改成
</p>
<div class="org-src-container">
<pre class="src src-shell">ls | xargs -d <span class="org-string">"\n"</span> -P8 -I {} bash -c <span class="org-string">"wc {} &gt;{}.wc"</span>
</pre>
</div>

<p>
而使用parallel就没那么复杂了,直接用引号引起来就行了:
</p>
<div class="org-src-container">
<pre class="src src-shell">ls | parallel <span class="org-string">"wc {} &gt;{}.wc"</span>
</pre>
</div>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2020-04-01</span>
    <span title="last modification date" class="post-info">2020-04-04</span>
    <span title="tags" class="post-info"><a href="../../../../../tags/linux和它的小伙伴">linux和它的小伙伴</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <!-- 添加一叶 -->
  <link href="https://yiyechat.com/open-source/build/content-static/css/main.css" rel="stylesheet">
  <script src="https://yiyechat.com/open-source/build/content-static/js/main.js" ></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-dd0f39f9-6e07-42f1-8db5-93cf948ad718">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="https://licensebuttons.net/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
