<!DOCTYPE html>
<html lang="en">
<head>
  <title>如何更改url package访问HTTP时的user-agent header - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="Emacs之怒" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/org-src-fontify.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;DarkSun的个人博客</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="git@github.com:lujun9972/lujun9972.github.com.git">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">如何更改url package访问HTTP时的user-agent header</h1>
<p>
有些网站会根据 http request 中的 user-agent header 的值返回不同的response，例如 <a href="http://wttr.in">http://wttr.in</a> 会根据就会根据 user-agent 是否为 curl 来决定是返回带图片的HTML，还是字符拼接图案的文本。
</p>

<p>
一开始我以为修改 <code>url package</code> 中的 <code>user-agent</code> 就是直接把相应的 header 内容加到 <code>url-request-extra-headers</code> 中就行了，事实证明我还是太天真了，这样做的后果是会产生两个 <code>user-agent</code> header...
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">let</span> ((url-debug t)
      (url-request-extra-headers '((<span class="org-string">"User-Agent"</span> . <span class="org-string">"curl/7.78.0"</span>))))
  (kill-buffer (url-retrieve-synchronously <span class="org-string">"http://wttr.in"</span>))
  (<span class="org-keyword">with-current-buffer</span> <span class="org-string">"*URL-DEBUG*"</span>
    (keep-lines <span class="org-string">"^User-Agent"</span> (point-min) (point-max))
    (buffer-substring-no-properties (point-min) (point-max))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">User-Agent: URL/Emacs Emacs/28.0.50 (X11; x86_64-pc-linux-gnu)
User-Agent: curl/7.78.0
</pre>
</div>

<p>
在翻阅了 <a href="https://www.gnu.org/software/emacs/manual/html_mono/url.html">url manual</a> 之后才知道，原来 <code>url</code> 专门有个变量用来控制 user-agent:
</p>
<pre class="example">
url-user-agent is a variable defined in ‘url-vars.el’.

Its value is ‘default’

  You can customize this variable.
  This variable was introduced, or its default value was changed, in
  version 26.1 of Emacs.
  Probably introduced at or before Emacs version 25.1.

User Agent used by the URL package for HTTP/HTTPS requests.
Should be one of:
* A string (not including the "User-Agent:" prefix)
* A function of no arguments, returning a string
* ‘default’ (to compute a value according to ‘url-privacy-level’)
* nil (to omit the User-Agent header entirely)
</pre>

<p>
所以修改 <code>user-agent</code> header 的正确方法是修改 <code>url-user-agent</code> 这个变量的值:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">let</span> ((url-debug t)
      (url-user-agent <span class="org-string">"curl/7.78.0"</span>))
  (kill-buffer (url-retrieve-synchronously <span class="org-string">"http://wttr.in"</span>))
  (<span class="org-keyword">with-current-buffer</span> <span class="org-string">"*URL-DEBUG*"</span>
    (keep-lines <span class="org-string">"^User-Agent"</span> (point-min) (point-max))
    (buffer-substring-no-properties (point-min) (point-max))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">User-Agent: curl/7.78.0
</pre>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2021-09-24</span>
    <span title="last modification date" class="post-info">2021-09-24</span>
    <span title="tags" class="post-info"><a href="../../../../../tags/emacs之怒">Emacs之怒</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <!-- 添加一叶 -->
  <link href="https://yiyechat.com/open-source/build/content-static/css/main.css" rel="stylesheet">
  <script src="https://yiyechat.com/open-source/build/content-static/js/main.js" ></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-9e640df4-1d0f-4ce1-9cd3-37b57947b466">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="https://licensebuttons.net/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
