<!DOCTYPE html>
<html lang="en">
<head>
  <title>从undistract-me项目代码中学到的bash知识 - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="编程之旅,shell,bash" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="../../../../../media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/org-src-fontify.css" type="text/css">
  <link rel="stylesheet" href="../../../../../media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">暗无天日</a></h1>
    <p>=============&gt;DarkSun的个人博客</p>
    <nav class="site-nav">
      <div class="menu-icon">
      </div>
      <ul class="trigger">
              <li><a href="../../../../../years/">Years</a></li>
              <li><a href="../../../../../tags/">Tags</a></li>
              <li><a href="../../../../../about/">About</a></li>
              <li><a href="https://github.com/lujun9972/lujun9972.github.com.git">Github</a></li>
              <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
        <input type="text" class="field" name="q" id="s" placeholder="Search">
        <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">从undistract-me项目代码中学到的bash知识</h1>
<p>
今天看到一个和有趣的项目 <a href="https://github.com/jml/undistract-me">undistract-me</a>. 它可以在命令执行时间超过指定时间的情况下，在命令执行完毕后通过 <code>notify-send</code> 发送通知告诉你.
</p>

<p>
我对它的实现很好奇，于是阅读了一下它的源代码。从它的代码中又学到了很多关于BASH的知识:
</p>

<ol class="org-ol">
<li><p>
如何检查一个命令是否存在？
</p>

<p>
使用 <code>command -v 命令</code>. 根据 <code>man bash</code> 中的说法：
</p>
<pre class="example">
command [-pVv] command [arg ...]
         运行   command   ，使用   args   作为参数，禁止通常的查找  shell
         函数的过程。只有内建命令或者 PATH 中包含的命令可以执行。如果给出
         -p         参数，         command         的查找是以        PATH
         的默认值进行的。这样可以保证找到所有的标准工具。如果给出 -V 或者
         -v      选项，关于      command      的说明将被打印出来。     -v
         选项使得表述这个命令的词，或者要执行                     command
         需要执行的文件显示出来；  -V  选项给出更详细的描述。如果给出  -V
         或者 -v 选项，退出状态在找到了 command  的情况下0，没找到就是1。
         如果没有提供选项，并且产生了错误或者                     command
         没有找到，退出状态就是127。否则，  command  内建命令的退出状态是
         command 的退出状态。
</pre></li>

<li><p>
如何获取当前正在执行的shell函数名称
</p>

<p>
通过 <code>FUNCNAME</code> 可以获取到当前执行的shell函数名
</p>
<pre class="example">
     函数执行时，   FUNCNAME   变量被设置为函数的名称。
</pre></li>

<li><p>
如何获取当前执行shell函数所在的文件
</p>

<p>
<code>${BASH_SOURCE[0]}</code> 可以去的当前执行函数所在shell文件的路径
</p>
<pre class="example">
BASH_SOURCE
              An array variable whose members are the source  filenames  where
              the  corresponding  shell  function  names in the FUNCNAME array
              variable are defined.  The  shell  function  ${FUNCNAME[$i]}  is
              defined   in   the   file  ${BASH_SOURCE[$i]}  and  called  from
              ${BASH_SOURCE[$i+1]}.
</pre></li>

<li><p>
PROMPT_COMMAND 变量
</p>

<p>
该变量中的值会在每次现实主提示符之前执行
</p>
<pre class="example">
PROMPT_COMMAND
              If set, the value is executed as a command prior to issuing each
              primary prompt.
</pre></li>

<li><p>
BASH_COMMAND
</p>

<p>
<code>BASH_COMMAND</code> 变量存储的是正在执行的命令:
</p>
<pre class="example">
BASH_COMMAND
              The  command  currently  being executed or about to be executed,
              unless the shell is executing a command as the result of a trap,
              in  which  case  it  is the command executing at the time of the
              trap.
</pre></li>

<li><p>
如何正确地获取最后一次执行的命令
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">local</span> <span class="org-variable-name">this_command</span>=$(<span class="org-sh-quoted-exec">HISTTIMEFORMAT</span>= history 1 | sed -e <span class="org-string">"s/^[ ]*[0-9]*[ ]*//g"</span>);  <span class="org-comment-delimiter"># </span><span class="org-comment">&#24403;&#24102;&#31649;&#36947;&#26102;&#65292;$BASH_COMMAND&#23601;&#19981;&#20934;&#30830;&#20102;</span>
</pre>
</div>

<p>
记得这里要把环境变量 <code>HISTTIMEFORMAT</code> 清空,因为它可能影响到 history的输出格式
</p>
<pre class="example">
HISTTIMEFORMAT
              If this variable is set and not null, its value  is  used  as  a
              format string for strftime(3) to print the time stamp associated
              with each history entry displayed by the  history  builtin.   If
              this  variable  is  set,  time stamps are written to the history
              file so they may be preserved across shell sessions.  This  uses
              the  history  comment  character  to distinguish timestamps from
              other history lines.
</pre></li>

<li><p>
undistract-me的实现原理
</p>

<p>
<code>undistract-me</code> 巧妙的利用了 DEBUG trap 和 <code>PROMPT_COMMAND</code> 变量.
</p>

<p>
首先，通过DEBUG trap，在每次命令执行前将要执行的命令,执行的时间以及执行命令时的窗口id号存储起来（通过history）
</p>

<p>
然后，通过变量 <code>PROMPT_COMMAND</code> 在出现主提示符（也就是命令执行完后）前计算一下当前时间和当前激活的窗口id号，
如果时间间隔超过指定时间并且激活的窗口改变了就调用 <code>notify-send</code> 来发送通知了。
</p></li>
</ol>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2017-12-02</span>
    <span title="last modification date" class="post-info">2018-03-01</span>
    <span title="tags" class="post-info"><a href="../../../../../tags/编程之旅">编程之旅</a> : <a href="../../../../../tags/shell">shell</a> : <a href="../../../../../tags/bash">bash</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
  <script src="../../../../../media/js/md5.min.js"></script>
  <section>
      <div id="gitalk-container"></div>
      <script type="text/javascript">
       var gitalk = new Gitalk({
           clientID: 'fdcb5d9da3f4acb4862c',
           clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
           repo: 'lujun9972.github.com',
           owner: 'lujun9972',
           admin: ['lujun9972'],
           id: md5(location.pathname),      // Ensure uniqueness and length less than 50
           distractionFreeMode: false  // Facebook-like distraction free mode
       })
       gitalk.render('gitalk-container')
      </script>
  </section>
  <script src="../../../../../media/js/kdComment.js"></script>
      <script>
       var _hmt = _hmt || [];
       (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
           var s = document.getElementsByTagName("script")[0]; 
           s.parentNode.insertBefore(hm, s);
       })();
      </script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-29b1e98a-de29-4fc3-8dad-b90294fb7963">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/emacs-china/EGO" target="_blank">EGO</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="https://licensebuttons.net/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
