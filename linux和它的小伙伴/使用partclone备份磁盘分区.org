#+TITLE: ä½¿ç”¨partcloneå¤‡ä»½ç£ç›˜åˆ†åŒº
#+AUTHOR: lujun9972
#+TAGS: linuxå’Œå®ƒçš„å°ä¼™ä¼´,backup
#+DATE: [2018-03-08 å›› 12:47]
#+LANGUAGE:  zh-CN
#+OPTIONS:  H:6 num:nil toc:t \n:nil ::t |:t ^:nil -:nil f:t *:t <:nil

åœ¨linuxä¸­ï¼Œæœ€å¸¸ç”¨çš„ =block level= å¤‡ä»½å·¥å…·åº”è¯¥é =dd= è«å±äº†ã€‚ ç„¶è€Œç”¨ =dd= åšç£ç›˜å¤‡ä»½æœ‰ä¸€ä¸ªä¸å¥½çš„åœ°æ–¹å°±æ˜¯å¤ªè´¹ç©ºé—´ï¼Œç£ç›˜å¤šå¤§ï¼Œç”Ÿæˆçš„å¤‡ä»½æ–‡ä»¶å°±æœ‰å¤šå¤§ã€‚

partclone è·Ÿ =dd= ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¸€æ¬¾ =block level= çš„å¤‡ä»½å·¥å…·ï¼Œå› æ­¤ä½¿ç”¨å®ƒä½ æ— éœ€æ‹…å¿ƒä¼šç ´åç£ç›˜ä¸­ =acls= æˆ– =selinux labels= è¿™ä¸€ç±»ç‰¹æ®Šçš„æ–‡ä»¶æƒé™ã€‚

ä½†æ˜¯è·Ÿ =dd= ç›¸æ¯”ï¼Œ =partclone= èƒ½å¤Ÿè¯†åˆ«å¤§å¤šæ•°å¸¸è§çš„æ–‡ä»¶ç±»å‹ï¼Œåªå¤‡ä»½ç£ç›˜ä¸­ç”¨åˆ°çš„é‚£äº›blockï¼Œä»è€Œå¤§å¤§å‡å°‘å¤‡ä»½æ‰€è€—çš„ç©ºé—´ã€‚

ç›®å‰ =partclone= æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ…æ‹¬ext2, ext3, ext4, hfs+, reiserfs, xfs, jfs, ntfs, fat(12/16/32), exfatã€‚

å¯¹æ¯ç§æ–‡ä»¶ç³»ç»Ÿ =partclone= éƒ½æä¾›äº†å¯¹åº”çš„ =partclone.<fs>= å¯¹åº”ã€‚æ¯”å¦‚å¤‡ä»½ =ext4= æ–‡ä»¶ç³»ç»Ÿåˆ™ä½¿ç”¨ =parclone.ext4= è¿›è¡Œå¤‡ä»½ã€‚
å¯¹äºä¸æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œ =partclone= ä¹Ÿæä¾›äº† =partclone.dd= æ¥å¤‡ä»½ã€‚

* å®‰è£…partclone
archlinuxä¸Šå¯ä»¥ç›´æ¥ä½¿ç”¨pacmanæ¥å®‰è£…ï¼š
#+BEGIN_SRC shell :dir /sudo:: :results org
  sudo pacman -S partclone --noconfirm
#+END_SRC

#+RESULTS:
#+BEGIN_SRC org
resolving dependencies...
looking for conflicting packages...

[0;1mPackages (1)[0m partclone-0.2.89-2

[0;1mTotal Installed Size:[0m  1.48 MiB
[0;1mNet Upgrade Size:    [0m  0.00 MiB

[1;34m::[0;1m Proceed with installation? [Y/n] [0m
(0/1) checking keys in keyring                     [[1;33mc[m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m]   0%(1/1) checking keys in keyring                     [----------------------] 100%
(0/1) checking package integrity                   [[1;33mc[m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m]   0%(1/1) checking package integrity                   [----------------------] 100%
(0/1) loading package files                        [[1;33mc[m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m]   0%(1/1) loading package files                        [----------------------] 100%
(0/1) checking for file conflicts                  [[1;33mc[m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m]   0%(1/1) checking for file conflicts                  [----------------------] 100%
(0/1) checking available disk space                [[1;33mc[m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m]   0%(1/1) checking available disk space                [----------------------] 100%
[1;34m::[0;1m Processing package changes...
[0m(1/1) reinstalling partclone                       [[1;33mc[m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m[0;37mo[m[0;37m [m[0;37m [m]   0%(1/1) reinstalling partclone                       [----------------------] 100%
[1;34m::[0;1m Running post-transaction hooks...
[0m(1/1) Arming ConditionNeedsUpdate...
#+END_SRC

* å¤‡ä»½ç£ç›˜åˆ†åŒº

åœ¨å¤‡ä»½ç£ç›˜åˆ†åŒºä¹‹å‰ï¼Œè¯·å…ˆç¡®ä¿è¢«å¤‡ä»½çš„åˆ†åŒºéœ€è¦å…ˆå¸è½½ã€‚ä¸è¿‡å¦‚æœä½ æ˜¯ç”¨çš„ =lvm= ï¼Œé‚£ä¹ˆå¯ä»¥åˆ›å»ºä¸€ä¸ªé€»è¾‘å·çš„ live snapshot,å› æ­¤å¯ä»¥ä¸å—æ­¤é™åˆ¶ã€‚

ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘æŠŠå®‰è£…å¥½çš„orangepiliteåšä¸ªå¤‡ä»½ã€‚

å°†orangepiliteæ–­ç”µåï¼Œæ¨å‡ºTFå¡ï¼Œç„¶åæ’å…¥è¯»å¡å™¨ä¸­ï¼Œæ’å…¥ç”µè„‘çš„USBæ¥å£ã€‚ç„¶åæ‰§è¡Œ
#+BEGIN_SRC shell :dir /sudo::
  sudo partclone.ext4 -c -s /dev/sdb1 -o /mnt/orangepilite.pcl
#+END_SRC

å…¶ä¸­ï¼š

+ -c :: è¡¨ç¤ºcloneä¸€ä¸ªå¤‡ä»½
+ -s :: æŒ‡å®šcloneçš„æº
+ -o :: æŒ‡å®šä¿å­˜çš„é•œåƒæ–‡ä»¶

ä½ ä¼šå‘ç°ï¼Œè™½ç„¶TFå¡æ˜¯8Gï¼Œä½†æ˜¯äº§ç”Ÿçš„orangepilite.pclåªæœ‰1.3G
#+BEGIN_EXAMPLE
  [lujun9972@T520 lujun9972]$ ls -lh /mnt/orangepilite.pcl 
  -rw------- 1 root root 1.3G 3æœˆ   8 21:23 /mnt/orangepilite.pcl
#+END_EXAMPLE

ä¸è¿‡æ›´å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå¯¹é•œåƒæ–‡ä»¶å‹ç¼©å­˜å‚¨ï¼Œæˆ‘ä»¬å¯ä»¥è®© =partclone= ä¸ =gzip= è¿ç”¨å®ç°è¿™ä¸€ç‚¹

#+BEGIN_SRC shell :dir /sudo::
  sudo bash -c "partclone.ext4 -c -s /dev/sdb1 |gzip -c -9 >/mnt/orangepilite.pcl.gz"
#+END_SRC

æœ€åäº§ç”Ÿçš„å¤‡ä»½æ–‡ä»¶åªæœ‰454M
#+BEGIN_EXAMPLE
  [lujun9972@T520 lujun9972]$ ls -lh /mnt/orangepilite.pcl.gz 
  -rw-r--r-- 1 root root 454M 3æœˆ   8 21:34 /mnt/orangepilite.pcl.gz
#+END_EXAMPLE

* ä»å¤‡ä»½è¿˜åŸ

ä»å¤‡ä»½è¿˜åŸå¾ˆç®€å•
#+BEGIN_SRC shell
  sudo partclone.ext4 -r -s /mnt/orangepilite.pcl -o /dev/sdb1
#+END_SRC

è¿™é‡Œ =-r= è¡¨ç¤ºè¿˜åŸ(restore),ç„¶åæŠŠä¸Šé¢å¤‡ä»½çš„ =-s= å’Œ =-o= å‚æ•°å€¼åè¿‡æ¥å°±æ˜¯äº†ã€‚

è‹¥å¤‡ä»½çš„æ˜¯å‹ç¼©è¿‡çš„æ–‡ä»¶ï¼Œåˆ™åªéœ€è¦è¿è¡Œ
#+BEGIN_SRC shell
  sudo bash -c "gzip -c -d /mnt/orangepilite.pcl.gz | partclone.ext4 -r -o /dev/sdb1"
#+END_SRC
